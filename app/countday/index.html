<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Text2 Countday</title>
    <meta name="description" content="Text2 Countday - Free countdown app to track important events like birthdays, anniversaries, deadlines. Beautiful interface, easy to use on Text02.com">
    <meta name="keywords" content="text2 countday, countdown, events, birthday, anniversary, text2, text02.com, countdown app">
    <meta name="author" content="Text02.com">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="google" content="notranslate">
    
    <!-- Google tag (gtag.js) - GA4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-6J85STMJ14');
    </script>
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://text02.com/app/countday">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://text02.com/app/countday">
    <meta property="og:title" content="Text2 Countday - Free Countdown App">
    <meta property="og:description" content="Track important events with Text2 Countday. Free countdown app for birthdays, anniversaries, deadlines. Beautiful interface on Text02.com">
    <meta property="og:image" content="https://text02.com/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://text02.com/app/countday">
    <meta property="twitter:title" content="Text2 Countday - Free Countdown App">
    <meta property="twitter:description" content="Track important events with Text2 Countday. Free countdown app for birthdays, anniversaries, deadlines. Beautiful interface on Text02.com">
    <meta property="twitter:image" content="https://text02.com/og-image.png">
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Text2 Countday",
      "description": "Free countdown app to track important events like birthdays, anniversaries, deadlines.",
      "url": "https://text02.com/app/countday",
      "applicationCategory": "UtilitiesApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Text02.com"
      }
    }
    </script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
    crossorigin="anonymous"></script>
    
    <!-- Libraries -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Favicon and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    
    <style>
        :root {
            --ease-smooth: cubic-bezier(0.22, 1, 0.36, 1);
            --soft-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }

        body {
            font-family: "Inter", sans-serif;
            background: #121212;
            margin: 0;
            color: #ffffff;
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* Header - Reverted to Original Gradient */
        .app-title {
            padding: 22px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #1E1E1E, #242424);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .logo-link:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            margin-right: 12px;
            transition: transform 0.3s ease;
        }

        .logo-link:hover .logo {
            transform: rotate(5deg) scale(1.05);
        }

        /* Quote Section */
        .quote-container {
            text-align: center;
            padding: 20px 20px 10px 20px;
            color: #a0a0a0;
            font-style: italic;
            font-size: 14px;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 1s ease;
        }

        .quote-text {
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        /* Controls: Search & Filter */
        .controls {
            padding: 15px 20px;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1E1E1E, #242424);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
             outline: none;
             border-color: #35b4ff;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-tab.active {
            background: #35b4ff;
            color: white;
            border-color: #35b4ff;
        }

        /* Events list */
        .events {
            padding: 10px 20px;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Event Card - Reverted to Original Gradient */
        .event-card {
            position: relative;
            background: linear-gradient(135deg, #1E1E1E, #242424);
            padding: 22px;
            border-radius: 18px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            transition: transform 0.35s var(--ease-smooth), box-shadow 0.35s var(--ease-smooth), background 0.35s var(--ease-smooth), border-color 0.35s var(--ease-smooth);
            background-size: cover;
            background-position: center;
            will-change: transform, box-shadow, filter;
            transform-origin: center center;
            /* Border left will be handled by JS for colors */
        }

        .event-card:hover {
            transform: translateY(-2px) scale(1.015);
            background: linear-gradient(135deg, #242424, #2A2A2A);
            box-shadow: var(--soft-shadow);
        }

        .event-card.card-enter {
            animation: cardEnter 0.45s var(--ease-smooth);
            animation-delay: var(--card-delay, 0ms);
        }

        /* Overlay for background images */
        .event-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.85) 30%, rgba(0,0,0,0.6));
            z-index: 1;
        }
        
        .event-content {
            position: relative;
            z-index: 2;
            cursor: pointer;
        }

        .event-card.hero {
            border: 2px solid #ffd700;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
            margin-bottom: 15px;
        }

        .event-card.hero::after {
            content: 'ðŸ“Œ Pinned';
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ffd700;
            color: #000;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 3;
        }

        .event-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .event-date {
            font-size: 14px;
            color: #c0c0c0;
            margin-bottom: 10px;
        }

        .event-number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .days-text {
            color: #c0c0c0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Card Actions */
        .card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 3;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .btn-pin.pinned {
            color: #ffd700;
            background: rgba(255, 215, 0, 0.15);
        }

        .btn-delete:hover {
            background: rgba(212, 70, 107, 0.4);
            color: #ffcccc;
        }

        /* Floating Add Button - Reverted to Original White */
        .add-btn {
            height: 70px;
            width: 70px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            color: #121212;
            font-size: 40px;
            position: fixed;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 40;
            box-shadow: 0 10px 30px rgba(79, 195, 247, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .add-btn:hover {
            box-shadow: 0 15px 40px rgba(79, 195, 247, 0.3);
        }

        .add-btn:active {
            transform: translateX(-50%) scale(0.9);
        }

        /* Modal Styles - Reverted to Original Gradient */
        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(12px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.28s var(--ease-smooth), visibility 0.28s ease;
        }

        .modal.visible {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            padding: 32px;
            width: 90%;
            max-width: 400px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--soft-shadow);
            transform: translateY(10px) scale(0.985);
            opacity: 0.9;
            transition: transform 0.32s var(--ease-smooth), opacity 0.32s var(--ease-smooth);
        }

        .modal.visible .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal.closing .modal-content {
            transform: translateY(6px) scale(0.98);
            opacity: 0.85;
        }

        .modal h2 {
            margin-top: 0;
            color: #fff;
            background: linear-gradient(135deg, #35b4ff, #a26bff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            font-weight: 700;
            margin-bottom: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            font-size: 15px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 16px 18px;
            border-radius: 14px;
            background: rgba(18, 18, 18, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #35b4ff;
            background: rgba(18, 18, 18, 0.9);
            box-shadow: 0 0 0 4px rgba(53, 180, 255, 0.1);
        }

        /* Color Picker */
        .colors {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 10px;
            justify-content: center;
        }

        .color {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .color.selected {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        /* Image Upload */
        .image-preview {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            border: 2px dashed #444;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            background: rgba(18, 18, 18, 0.5);
        }
        
        .image-preview span {
            color: #888;
            font-size: 14px;
            pointer-events: none;
            font-style: italic;
        }

        .primary-btn {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            background: linear-gradient(135deg, #35b4ff, #a26bff);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 8px 24px rgba(53, 180, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(53, 180, 255, 0.4);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #c0c0c0;
            font-size: 18px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Detail Modal Specifics */
        .detail-time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-value {
            font-size: 24px;
            font-weight: bold;
            color: #35b4ff;
            display: block;
        }

        .detail-label {
            font-size: 12px;
            color: #aaa;
        }

        /* Settings Menu */
        .settings-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #c0c0c0;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .settings-menu {
            display: none;
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            min-width: 220px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-menu.active {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: #e0e0e0;
            width: 100%;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            font-size: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
            padding-left: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes cardEnter {
            from { opacity: 0; transform: translateY(14px) scale(0.99); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Export Helper */
        .hide-on-export {
            display: none !important;
        }

        @media (max-width: 600px) {
            .event-number { font-size: 42px; }
            .detail-time-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

    <header class="app-title">
        <a href="https://text02.com" class="logo-link">
            <img src="https://text02.com/favicon.ico" alt="Text2 Logo" class="logo">
            <span>Text2 Countday</span>
        </a>
        <button class="settings-btn" id="settings-toggle"><i class="fas fa-cog"></i></button>
        
        <div class="settings-menu" id="settings-menu">
            <button class="menu-item" id="export-data">
                <i class="fas fa-file-export"></i> Backup Data
            </button>
            <button class="menu-item" id="import-data">
                <i class="fas fa-file-import"></i> Restore Data
            </button>
        </div>
    </header>

    <!-- Quote Section -->
    <div class="quote-container" id="quote-container">
        <div class="quote-text" id="daily-quote">"Time waits for no one."</div>
    </div>

    <!-- Search & Filter Controls -->
    <div class="controls">
        <div class="search-box">
            <input type="text" id="search-input" placeholder="Search events...">
            <i class="fas fa-search"></i>
        </div>
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="all">All Events</div>
            <div class="filter-tab" data-filter="upcoming">Upcoming</div>
            <div class="filter-tab" data-filter="past">Past</div>
        </div>
    </div>

    <!-- Events Container -->
    <div id="events-container" class="events"></div>

    <!-- Floating Add Button -->
    <button class="add-btn" id="open-create-modal">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Hidden Inputs -->
    <input type="file" id="json-file-input" accept=".json" style="display:none" />
    <input type="file" id="image-file-input" accept="image/*" style="display:none" />

    <!-- Create/Edit Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-modal" id="close-modal"><i class="fas fa-times"></i></button>
            <h2 id="modal-title">New Event</h2>

            <div class="form-group">
                <label>Event Name</label>
                <input type="text" class="form-control" id="event-name" placeholder="e.g. Mom's Birthday">
            </div>

            <div class="form-group">
                <label>Date & Time</label>
                <input type="datetime-local" class="form-control" id="event-date">
            </div>

            <div class="form-group">
                <label>Theme Color</label>
                <div class="colors" id="color-picker">
                    <div class="color selected" style="background: #35b4ff;" data-color="#35b4ff"></div>
                    <div class="color" style="background: #a26bff;" data-color="#a26bff"></div>
                    <div class="color" style="background: #d28f2c;" data-color="#d28f2c"></div>
                    <div class="color" style="background: #21b78a;" data-color="#21b78a"></div>
                    <div class="color" style="background: #d4466b;" data-color="#d4466b"></div>
                    <div class="color" style="background: #ffffff;" data-color="#ffffff"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Background Image (Optional)</label>
                <div class="image-preview" id="bg-preview">
                    <span><i class="fas fa-cloud-upload-alt"></i> Tap to upload image</span>
                </div>
                <button id="remove-bg" style="background:none; border:none; color:#d4466b; font-size:12px; margin-top:5px; cursor:pointer; display:none;">Remove Image</button>
            </div>

            <button id="save-event-btn" class="primary-btn">Create Count</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detail-modal">
            <div class="modal-content" style="text-align: center;">
            <button class="close-modal" onclick="closeDetailModal()"><i class="fas fa-times"></i></button>
            <h2 id="detail-title" style="color: #35b4ff;">Event Name</h2>
            <p id="detail-full-date" style="color: #888; font-size: 14px; margin-bottom: 20px;"></p>
            
            <div class="detail-time-grid">
                <div class="detail-item">
                    <span class="detail-value" id="d-years">0</span>
                    <span class="detail-label">YEARS</span>
                </div>
                <div class="detail-item">
                    <span class="detail-value" id="d-months">0</span>
                    <span class="detail-label">MONTHS</span>
                </div>
                <div class="detail-item">
                    <span class="detail-value" id="d-days">0</span>
                    <span class="detail-label">DAYS</span>
                </div>
                <div class="detail-item">
                    <span class="detail-value" id="d-hours">0</span>
                    <span class="detail-label">HOURS</span>
                </div>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-style: italic; font-size: 12px;">
                *Exact duration
            </div>
        </div>
    </div>

    <script>
        // State
        let events = JSON.parse(localStorage.getItem("events")) || [];
        let editingIndex = -1; // -1 means new event
        let selectedColor = "#35b4ff";
        let tempBgImage = null; // Stores base64 string during edit
        let currentFilter = "all";
        let searchQuery = "";

        // Quotes
        const quotes = [
            "Time is what we want most, but what we use worst.",
            "The future depends on what you do today.",
            "Don't count the days, make the days count.",
            "Time flies over us, but leaves its shadow behind.",
            "Yesterday is history. Tomorrow is a mystery. Today is a gift.",
            "Lost time is never found again.",
            "Your time is limited, so don't waste it living someone else's life."
        ];

        // DOM Elements
        const eventsContainer = document.getElementById("events-container");
        const modal = document.getElementById("modal");
        const detailModal = document.getElementById("detail-modal");
        const saveBtn = document.getElementById("save-event-btn");
        const modalTitle = document.getElementById("modal-title");
        const searchInput = document.getElementById("search-input");
        const filterTabs = document.querySelectorAll(".filter-tab");
        const settingsMenu = document.getElementById("settings-menu");

        // Modal helpers for smooth open/close
        function showModal(el) {
            el.style.display = "flex";
            requestAnimationFrame(() => {
                el.classList.add("visible");
                el.classList.remove("closing");
            });
        }

        function hideModal(el) {
            el.classList.remove("visible");
            el.classList.add("closing");
            setTimeout(() => {
                el.style.display = "none";
                el.classList.remove("closing");
            }, 240);
        }

        // Ensure modals are hidden on first paint
        modal.style.display = "none";
        detailModal.style.display = "none";
        
        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("daily-quote").innerText = quotes[Math.floor(Math.random() * quotes.length)];
            renderEvents();
        });

        // --- Settings & Menus ---
        document.getElementById("settings-toggle").onclick = (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle("active");
        };

        document.addEventListener("click", (e) => {
            if (!settingsMenu.contains(e.target) && e.target.id !== "settings-toggle") {
                settingsMenu.classList.remove("active");
            }
        });

        // --- Event Handlers: Search & Filter ---
        searchInput.addEventListener("input", (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderEvents();
        });

        filterTabs.forEach(tab => {
            tab.addEventListener("click", () => {
                document.querySelector(".filter-tab.active").classList.remove("active");
                tab.classList.add("active");
                currentFilter = tab.dataset.filter;
                renderEvents();
            });
        });

        // --- Event Handlers: Modal & Form ---
        document.getElementById("open-create-modal").onclick = () => openModal();
        document.getElementById("close-modal").onclick = () => closeModal();
        
        // Color Picker Logic
        document.querySelectorAll("#color-picker .color").forEach(c => {
            c.onclick = () => {
                document.querySelectorAll("#color-picker .color").forEach(x => x.classList.remove("selected"));
                c.classList.add("selected");
                selectedColor = c.dataset.color;
            };
        });

        // Image Upload Logic
        const bgPreview = document.getElementById("bg-preview");
        const imageInput = document.getElementById("image-file-input");
        const removeBgBtn = document.getElementById("remove-bg");

        bgPreview.onclick = () => imageInput.click();
        
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                if(file.size > 2 * 1024 * 1024) { // 2MB limit check
                     alert("Image is too large! Please choose an image under 2MB.");
                     return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    tempBgImage = ev.target.result;
                    bgPreview.style.backgroundImage = `url('${tempBgImage}')`;
                    bgPreview.innerHTML = "";
                    removeBgBtn.style.display = "block";
                };
                reader.readAsDataURL(file);
            }
        };

        removeBgBtn.onclick = () => {
            tempBgImage = null;
            bgPreview.style.backgroundImage = "none";
            bgPreview.innerHTML = '<span><i class="fas fa-cloud-upload-alt"></i> Tap to upload image</span>';
            removeBgBtn.style.display = "none";
            imageInput.value = "";
        };

        // Save Event (Create or Edit)
        saveBtn.onclick = () => {
            const name = document.getElementById("event-name").value.trim();
            const date = document.getElementById("event-date").value;

            if (!name || !date) return alert("Please fill in name and date!");

            const eventData = {
                name,
                date,
                color: selectedColor,
                image: tempBgImage,
                pinned: editingIndex > -1 ? events[editingIndex].pinned : false, // Preserve pin status
                id: editingIndex > -1 ? events[editingIndex].id : Date.now() // Unique ID
            };

            if (editingIndex > -1) {
                // Update existing
                events[editingIndex] = eventData;
            } else {
                // Create new
                events.push(eventData);
            }

            saveData();
            closeModal();
            renderEvents();
        };

        function saveData() {
            try {
                localStorage.setItem("events", JSON.stringify(events));
            } catch (e) {
                alert("Storage full! Image might be too large.");
            }
        }

        // --- Logic: Rendering ---
        function renderEvents() {
            eventsContainer.innerHTML = "";

            // Filter
            let filtered = events.filter(ev => {
                const matchesSearch = ev.name.toLowerCase().includes(searchQuery);
                const evDate = new Date(ev.date);
                const now = new Date();
                
                let matchesTab = true;
                if (currentFilter === "upcoming") matchesTab = evDate > now;
                if (currentFilter === "past") matchesTab = evDate <= now;

                return matchesSearch && matchesTab;
            });

            // Sort: Pinned first, then by date logic
            filtered.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;

                // Existing sorting logic
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                const now = new Date();
                const diffA = Math.floor((dateA - now) / (1000 * 60 * 60 * 24));
                const diffB = Math.floor((dateB - now) / (1000 * 60 * 60 * 24));

                // If both upcoming, closer date first
                if (diffA >= 0 && diffB >= 0) return diffA - diffB;
                // If both past, more recent first
                if (diffA < 0 && diffB < 0) return diffB - diffA;
                // Upcoming before past
                return diffB - diffA;
            });

            if (filtered.length === 0) {
                eventsContainer.innerHTML = `<div style="text-align:center; color:#555; margin-top:50px;">No events found.</div>`;
                return;
            }

            filtered.forEach((ev, idx) => {
                const evDate = new Date(ev.date);
                const now = new Date();
                const diffTime = evDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                let displayNum, label;
                if (diffDays > 0) {
                    displayNum = diffDays;
                    label = "Days Left";
                } else if (diffDays === 0) {
                    displayNum = "Today";
                    label = "";
                } else {
                    displayNum = Math.abs(diffDays);
                    label = "Days Ago";
                }

                const card = document.createElement("div");
                card.className = `event-card ${ev.pinned ? 'hero' : ''}`;
                // Set styles for bg image
                if (ev.image) {
                    card.style.backgroundImage = `url('${ev.image}')`;
                }
                
                // For non-image cards, show color border and simple box shadow (reverted style)
                if (!ev.image) {
                    card.style.borderLeft = `6px solid ${ev.color}`;
                    card.style.boxShadow = `0 0 35px ${ev.color}30`; // Reverted glow effect
                }

                // Text color handling (if image, always white with shadow, if no image, use theme color for number)
                const numColor = ev.image ? '#fff' : ev.color;

                card.innerHTML = `
                    <div class="event-card-overlay" style="display:${ev.image ? 'block' : 'none'}"></div>
                    
                    <div class="card-actions">
                        <button class="action-btn btn-pin ${ev.pinned ? 'pinned' : ''}" onclick="togglePin(${ev.id})" title="Pin to top">
                            <i class="fas fa-thumbtack"></i>
                        </button>
                        <button class="action-btn" onclick="editEvent(${ev.id})" title="Edit">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                         <button class="action-btn" onclick="shareEvent(${ev.id}, this)" title="Share Image">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteEvent(${ev.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <div class="event-content" onclick="showDetail(${ev.id})">
                        <div class="event-title">${ev.name}</div>
                        <div class="event-date">${evDate.toDateString()}</div>
                        <div class="event-number" style="color:${numColor}">${displayNum}</div>
                        <div class="days-text">${label}</div>
                    </div>
                `;

                card.classList.add("card-enter");
                card.style.setProperty("--card-delay", `${Math.min(idx * 40, 200)}ms`);
                setTimeout(() => card.classList.remove("card-enter"), 500);

                eventsContainer.appendChild(card);
            });
        }

        // --- Logic: CRUD & Actions ---
        
        function openModal(isEdit = false) {
            showModal(modal);
            if (!isEdit) {
                editingIndex = -1;
                modalTitle.innerText = "New Event";
                document.getElementById("event-name").value = "";
                document.getElementById("event-date").value = "";
                tempBgImage = null;
                resetFormVisuals();
            }
        }

        function closeModal() {
            hideModal(modal);
        }

        function resetFormVisuals() {
            // Reset color selection
            document.querySelectorAll("#color-picker .color").forEach(x => x.classList.remove("selected"));
            document.querySelector(`[data-color="${selectedColor}"]`)?.classList.add("selected");
            
            // Reset image preview
            if (tempBgImage) {
                bgPreview.style.backgroundImage = `url('${tempBgImage}')`;
                bgPreview.innerHTML = "";
                removeBgBtn.style.display = "block";
            } else {
                bgPreview.style.backgroundImage = "none";
                bgPreview.innerHTML = '<span><i class="fas fa-cloud-upload-alt"></i> Tap to upload image</span>';
                removeBgBtn.style.display = "none";
            }
        }

        window.editEvent = function(id) {
            const index = events.findIndex(e => e.id === id);
            if (index === -1) return;
            
            editingIndex = index;
            const ev = events[index];
            
            modalTitle.innerText = "Edit Event";
            document.getElementById("event-name").value = ev.name;
            document.getElementById("event-date").value = ev.date;
            selectedColor = ev.color;
            tempBgImage = ev.image || null;
            
            resetFormVisuals();
            saveBtn.innerText = "Update Count";
            showModal(modal);
        };

        window.deleteEvent = function(id) {
            if (confirm("Delete this event?")) {
                events = events.filter(e => e.id !== id);
                saveData();
                renderEvents();
            }
        };

        window.togglePin = function(id) {
            // Unpin others if we want only one pinned? Or allow multiple? 
            // User requirement: "Choose 1 most important event". So we unpin others.
            const index = events.findIndex(e => e.id === id);
            if (index === -1) return;

            // If clicking the already pinned one, unpin it
            if (events[index].pinned) {
                events[index].pinned = false;
            } else {
                // Unpin all others
                events.forEach(e => e.pinned = false);
                events[index].pinned = true;
            }
            saveData();
            renderEvents();
        };

        // --- Logic: Details ---
        window.showDetail = function(id) {
            const ev = events.find(e => e.id === id);
            if(!ev) return;

            const now = new Date();
            const target = new Date(ev.date);
            let diff = target - now;
            const isPast = diff < 0;
            diff = Math.abs(diff);

            // Calculations
            const msInYear = 1000 * 60 * 60 * 24 * 365.25;
            const msInMonth = 1000 * 60 * 60 * 24 * 30.44;
            const msInDay = 1000 * 60 * 60 * 24;
            const msInHour = 1000 * 60 * 60;

            const years = Math.floor(diff / msInYear);
            diff -= years * msInYear;
            const months = Math.floor(diff / msInMonth);
            diff -= months * msInMonth;
            const days = Math.floor(diff / msInDay);
            diff -= days * msInDay;
            const hours = Math.floor(diff / msInHour);

            // Populate Modal
            document.getElementById("detail-title").innerText = ev.name;
            document.getElementById("detail-full-date").innerText = new Date(ev.date).toLocaleString();
            
            document.getElementById("d-years").innerText = years;
            document.getElementById("d-months").innerText = months;
            document.getElementById("d-days").innerText = days;
            document.getElementById("d-hours").innerText = hours;

            showModal(detailModal);
        };

        window.closeDetailModal = function() {
            hideModal(detailModal);
        };

        // --- Logic: Share Image ---
        window.shareEvent = function(id, btnElement) {
            const card = btnElement.closest('.event-card');
            
            // Prepare for capture
            card.classList.add("capturing");
            const actions = card.querySelector(".card-actions");
            const originalDisplay = actions.style.display;
            actions.style.display = "none"; // Hide buttons

            // Add branding watermark temporarily
            const watermark = document.createElement("div");
            watermark.innerText = "Text02.com";
            watermark.style.cssText = "position:absolute; bottom:10px; right:10px; font-size:10px; color:rgba(255,255,255,0.5); z-index:10;";
            card.appendChild(watermark);

            html2canvas(card, {
                backgroundColor: "#1E1E1E",
                scale: 2 // High res
            }).then(canvas => {
                // Restore state
                actions.style.display = originalDisplay;
                card.removeChild(watermark);
                
                // Download
                const link = document.createElement('a');
                link.download = 'countday-share.png';
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error(err);
                alert("Failed to generate image.");
                actions.style.display = originalDisplay;
                if(card.contains(watermark)) card.removeChild(watermark);
            });
        };

        // --- Logic: Import/Export ---
        document.getElementById("export-data").onclick = () => {
            const dataStr = JSON.stringify(events, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `text2-backup-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        };

        document.getElementById("import-data").onclick = () => {
            document.getElementById("json-file-input").click();
        };

        document.getElementById("json-file-input").onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (Array.isArray(data)) {
                        if (confirm(`Import ${data.length} events? This will merge with current events.`)) {
                            // Merge logic: avoid duplicate IDs
                            const currentIds = new Set(events.map(ev => ev.id));
                            data.forEach(ev => {
                                if(!ev.id) ev.id = Date.now() + Math.random(); // Ensure ID
                                if(!currentIds.has(ev.id)) events.push(ev);
                            });
                            saveData();
                            renderEvents();
                            alert("Import successful!");
                        }
                    } else {
                        alert("Invalid file format.");
                    }
                } catch(err) {
                    alert("Error reading file.");
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // reset
        };

    </script>
</body>
</html>