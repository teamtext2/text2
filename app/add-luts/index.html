<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text2 -  add luts</title>
  <meta name="description" content="Áp LUT (.cube) lên ảnh trực tiếp trên trình duyệt. Giao diện hiện đại, tối ưu cho mobile và PC." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg1:#0f0f0f;--bg2:#1a1a1a;--card:#23272a;--muted:#9aa4ad;--border:#2f3337;--accent:#4fc3f7}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;min-height:100vh;font-family:'Poppins','Segoe UI',system-ui,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    header{background:rgba(33,37,41,.95);padding:8px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,.5);border-bottom:1px solid #444;height:44px;position:sticky;top:0;z-index:10}
    .start-button{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .2s}
    .start-button:hover{background:rgba(255,255,255,.08)}
    .start-button img{width:22px;height:22px;border-radius:6px}
    .app-title{font-weight:700;font-size:15px;letter-spacing:.3px;color:#fff;opacity:.95}
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    .page-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 14px}
    .page-head h1{font-size:18px;margin:0;font-weight:700;color:#fff}
    .page-head p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1.35fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 6px 15px rgba(0,0,0,.35)}
    .card h2{margin:0 0 10px;font-size:14px;color:#cfe9f6;font-weight:700}
    label{display:block;font-size:13px;margin:10px 0 6px;color:#dce7ee}
    input[type=file]{width:100%;padding:10px;background:rgba(255,255,255,.06);border:1px dashed #3b4046;border-radius:10px;color:#e6edf3}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    hr{border:0;border-top:1px solid #30343a;margin:14px 0}
    .btn-row{display:flex;flex-wrap:wrap;gap:10px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #3a4046;background:linear-gradient(145deg,#343a40,#23272a);color:#fff;font-weight:600;cursor:pointer;transition:transform .15s,box-shadow .2s,background .2s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25);background:linear-gradient(145deg,#3d4449,#2a2f33)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
    .btn-accent{background:linear-gradient(145deg,#4fc3f7,#29b6f6);border-color:#2d8fb6;color:#07141a}
    .btn-accent:hover{background:linear-gradient(145deg,#67d2ff,#3bc3ff)}
    .btn-danger{background:linear-gradient(145deg,#ef5350,#e53935);border-color:#b71c1c;color:#1b0a0a}
    .btn-danger:hover{background:linear-gradient(145deg,#ff6b68,#ff4541)}
    .preview-wrap{display:flex;gap:10px;flex-wrap:wrap}
    .canvas-box{flex:1;min-width:260px}
    .canvas-title{font-size:12px;color:#c9d6dd;margin:0 0 6px}
    canvas{max-width:100%;height:auto;border:1px solid #31363c;border-radius:10px;background:#0f1113}
    .lut-info{margin-top:8px;color:#cfe9f6;font-size:12px}
    .drop-hint{margin-top:8px;color:#9fb6c2;font-size:12px}
    footer{color:#9aa4ad;text-align:center;padding:18px 10px;font-size:12px;opacity:.9}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .item-card{background:#15171a;border:1px solid #2b3036;border-radius:12px;padding:10px}
    .item-title{font-size:12px;color:#c9d6dd;margin:0 0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px;border:1px solid #2f3337;background:#0f1113}
    .mini-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px}
    select{width:100%;padding:10px;border-radius:10px;border:1px solid #3a4046;background:#1a1d21;color:#e6edf3}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
    @media (max-width:480px){header{height:40px}.app-title{font-size:14px}.page-head h1{font-size:16px}}
  </style>
</head>
<body>
  <header>
    <div class="start-button" onclick="window.location.href='/'" title="Về trang chủ">
      <img src="https://text2.click/favicon.ico" alt="Text2" />
      <span style="font-weight:600">Text2</span>
    </div>
    <div class="app-title">Áp LUT (.cube) lên ảnh</div>
  </header>
  <main>
    <div class="page-head">
      <div>
        <h1>Trình áp LUT 3D (.cube)</h1>
        <p>Kéo thả hoặc chọn ảnh và file .cube. Xử lý bằng nội suy trilinear, chạy trực tiếp trên trình duyệt.</p>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Chọn tệp</h2>
        <label for="imgFiles"><strong>1) Ảnh nguồn (chọn nhiều)</strong></label>
        <input id="imgFiles" type="file" accept="image/*" multiple>
        <div class="hint">Ảnh lớn có thể xử lý chậm. Nên resize trước nếu cần.</div>
        <hr>
        <label for="lutFiles"><strong>2) LUT (.cube) — có thể chọn nhiều</strong></label>
        <input id="lutFiles" type="file" accept=".cube" multiple>
        <div id="lutInfo" class="lut-info"></div>
        <label for="lutSelect" style="margin-top:10px"><strong>Chọn LUT để áp dụng</strong></label>
        <select id="lutSelect"></select>
        <div class="drop-hint">Tip: Kéo thả ảnh và LUT vào trang để thêm nhanh.</div>
        <hr>
        <div class="btn-row">
          <button id="applyAllBtn" class="btn-accent" disabled>Áp LUT cho tất cả ảnh</button>
          <button id="clearBtn" class="btn-danger">Xóa danh sách</button>
        </div>
      </div>

      <div class="card">
        <h2>Ảnh đã chọn</h2>
        <div id="imagesGrid" class="gallery"></div>
      </div>
      <div class="card">
        <h2>Kết quả</h2>
        <div id="resultsGrid" class="gallery"></div>
      </div>
    </div>
  </main>
  <footer>© 2024 Text2 • Làm việc hoàn toàn trên máy của bạn, không upload dữ liệu.</footer>

  <script>
  // Helpers
  function readFileAsText(file){
    return new Promise((res,rej)=>{
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=e=>rej(e); r.readAsText(file);
    });
  }
  function readFileAsImage(file){
    return new Promise((res,rej)=>{
      const url = URL.createObjectURL(file);
      const img = new Image(); img.onload = ()=>{ URL.revokeObjectURL(url); res(img); }; img.onerror = rej; img.src = url; img.crossOrigin = "anonymous";
    });
  }

  // Parse .cube LUT (supports comments and header). Returns {size, data:Float32Array}
  function parseCube(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
    let size = null;
    const dataLines = [];
    for(const l of lines){
      const t = l.split(/\s+/);
      if(t[0].toUpperCase()==='LUT_3D_SIZE'){
        size = parseInt(t[1],10);
      } else if(/^TITLE/i.test(t[0]) || /^DOMAIN_MIN/i.test(t[0]) || /^DOMAIN_MAX/i.test(t[0])){
        // ignore for now
      } else {
        // value line (3 floats)
        if(t.length>=3){
          const f0 = parseFloat(t[0]);
          const f1 = parseFloat(t[1]);
          const f2 = parseFloat(t[2]);
          if(!Number.isNaN(f0) && !Number.isNaN(f1) && !Number.isNaN(f2)) dataLines.push(f0, f1, f2);
        }
      }
    }
    if(!size) throw new Error('Không tìm thấy LUT_3D_SIZE trong file .cube');
    const expected = size*size*size*3;
    if(dataLines.length < expected) throw new Error('File LUT có ít dòng dữ liệu hơn yêu cầu: '+dataLines.length+' < '+expected);
    // Store data into Float32Array in index order: lut[(b*size + g)*size + r]
    const data = new Float32Array(size*size*size*3);
    // Many .cube files list entries with R fastest, then G, then B — we'll assume that order.
    // dataLines already in that order; copy first expected floats
    for(let i=0;i<expected;i++) data[i]=dataLines[i];
    return {size, data};
  }

  // Trilinear sampling from the LUT array.
  // pos components are in [0,1]
  function sampleLUT(lut, size, r, g, b){
    const s = size - 1;
    const vr = r * s;
    const vg = g * s;
    const vb = b * s;
    const r0 = Math.floor(vr), r1 = Math.min(r0+1, s);
    const g0 = Math.floor(vg), g1 = Math.min(g0+1, s);
    const b0 = Math.floor(vb), b1 = Math.min(b0+1, s);
    const fr = vr - r0, fg = vg - g0, fb = vb - b0;
    // helper to fetch RGB from LUT at integer indices
    const get = (ri,gi,bi)=>{
      // index ordering: ((bi*size + gi)*size + ri) *3
      const idx = ((bi*size + gi)*size + ri) * 3;
      return [lut[idx], lut[idx+1], lut[idx+2]];
    };
    const c000 = get(r0,g0,b0);
    const c100 = get(r1,g0,b0);
    const c010 = get(r0,g1,b0);
    const c110 = get(r1,g1,b0);
    const c001 = get(r0,g0,b1);
    const c101 = get(r1,g0,b1);
    const c011 = get(r0,g1,b1);
    const c111 = get(r1,g1,b1);
    // interpolate
    const out = [0,0,0];
    for(let k=0;k<3;k++){
      const c00 = c000[k]*(1-fr) + c100[k]*fr;
      const c10 = c010[k]*(1-fr) + c110[k]*fr;
      const c01 = c001[k]*(1-fr) + c101[k]*fr;
      const c11 = c011[k]*(1-fr) + c111[k]*fr;
      const c0 = c00*(1-fg) + c10*fg;
      const c1 = c01*(1-fg) + c11*fg;
      out[k] = c0*(1-fb) + c1*fb;
    }
    return out;
  }

  // Apply LUT to image via CPU. Returns ImageData.
  function applyLUTToImageData(srcImageData, lutObj){
    const {data: src, width, height} = srcImageData;
    const dst = new Uint8ClampedArray(src.length);
    const lut = lutObj.data; const size = lutObj.size;
    const len = width*height;
    for(let i=0, p=0;i<len;i++, p+=4){
      const r = src[p]/255;
      const g = src[p+1]/255;
      const b = src[p+2]/255;
      const a = src[p+3];
      const mapped = sampleLUT(lut, size, r, g, b);
      dst[p] = Math.max(0, Math.min(255, Math.round(mapped[0]*255)));
      dst[p+1] = Math.max(0, Math.min(255, Math.round(mapped[1]*255)));
      dst[p+2] = Math.max(0, Math.min(255, Math.round(mapped[2]*255)));
      dst[p+3] = a;
    }
    return new ImageData(dst, width, height);
  }

  // Setup UI (batch mode)
  const imgFilesEl = document.getElementById('imgFiles');
  const lutFilesEl = document.getElementById('lutFiles');
  const lutSelectEl = document.getElementById('lutSelect');
  const applyAllBtn = document.getElementById('applyAllBtn');
  const clearBtn = document.getElementById('clearBtn');
  const lutInfo = document.getElementById('lutInfo');
  const imagesGrid = document.getElementById('imagesGrid');
  const resultsGrid = document.getElementById('resultsGrid');

  const MAX_WIDTH = 1920;
  const currentImages = []; // {fileName, img, width, height, thumbUrl}
  const currentLUTs = [];   // {name, size, data}
  const results = [];       // {fileName, lutName, url}

  function updateButtonsState(){
    applyAllBtn.disabled = !(currentImages.length && currentLUTs.length);
  }

  function fileBaseName(name){
    const i = name.lastIndexOf('.');
    return i>0 ? name.slice(0,i) : name;
  }

  function renderLUTSelect(){
    lutSelectEl.innerHTML = '';
    currentLUTs.forEach((l, idx)=>{
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = `${l.name} — ${l.size}³`;
      lutSelectEl.appendChild(opt);
    });
    lutInfo.textContent = currentLUTs.length ? `Đã tải ${currentLUTs.length} LUT` : '';
  }

  function renderImages(){
    imagesGrid.innerHTML = '';
    currentImages.forEach((it, idx)=>{
      const card = document.createElement('div'); card.className = 'item-card';
      const title = document.createElement('div'); title.className='item-title'; title.textContent = `${it.fileName} (${it.width}×${it.height})`;
      const img = document.createElement('img'); img.className='thumb'; img.src = it.thumbUrl;
      const row = document.createElement('div'); row.className='mini-row';
      const removeBtn = document.createElement('button'); removeBtn.textContent='Xóa'; removeBtn.className='btn-danger';
      removeBtn.onclick = ()=>{ URL.revokeObjectURL(it.thumbUrl); currentImages.splice(idx,1); renderImages(); updateButtonsState(); };
      row.appendChild(document.createElement('div'));
      row.appendChild(removeBtn);
      card.appendChild(title); card.appendChild(img); card.appendChild(row);
      imagesGrid.appendChild(card);
    });
  }

  function addImagesFromFileList(fileList){
    const files = Array.from(fileList || []);
    files.forEach(async f=>{
      if(!(f.type.startsWith('image/') || f.name.match(/\.(jpg|jpeg|png|webp|bmp)$/i))) return;
      try{
        const img = await readFileAsImage(f);
        let w = img.naturalWidth, h = img.naturalHeight;
        if(w>MAX_WIDTH){ h = Math.round(h * (MAX_WIDTH / w)); w = MAX_WIDTH; }
        // build thumbnail
        const c = document.createElement('canvas'); c.width = 320; c.height = Math.round(320 * (h/w));
        const ctx = c.getContext('2d'); ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,w,h,0,0,c.width,c.height);
        const url = c.toDataURL('image/jpeg',0.85);
        currentImages.push({fileName:f.name, img, width:w, height:h, thumbUrl:url});
        renderImages(); updateButtonsState();
      }catch(err){ alert('Không thể mở ảnh: '+err.message); }
    });
  }

  function addLUTsFromFileList(fileList){
    const files = Array.from(fileList || []);
    files.forEach(async f=>{
      if(!f.name.match(/\.cube$/i)) return;
      try{
        const text = await readFileAsText(f);
        const lutObj = parseCube(text);
        currentLUTs.push({name:f.name, size:lutObj.size, data:lutObj.data});
        renderLUTSelect(); updateButtonsState();
      }catch(err){ alert('Lỗi khi đọc LUT: '+err.message); }
    });
  }

  imgFilesEl.addEventListener('change', e=>{
    if(!e.target.files || !e.target.files.length) return;
    addImagesFromFileList(e.target.files);
    // reset input to allow re-adding same files
    e.target.value='';
  });

  lutFilesEl.addEventListener('change', e=>{
    if(!e.target.files || !e.target.files.length) return;
    addLUTsFromFileList(e.target.files);
    e.target.value='';
  });

  clearBtn.addEventListener('click', ()=>{
    // revoke urls
    currentImages.forEach(it=> URL.revokeObjectURL(it.thumbUrl));
    results.forEach(r=> URL.revokeObjectURL(r.url));
    currentImages.length = 0; currentLUTs.length = 0; results.length = 0;
    imagesGrid.innerHTML=''; resultsGrid.innerHTML='';
    lutSelectEl.innerHTML=''; lutInfo.textContent='';
    updateButtonsState();
  });

  function appendResultCard(fileName, lutName, blob){
    const url = URL.createObjectURL(blob);
    results.push({fileName, lutName, url});
    const card = document.createElement('div'); card.className='item-card';
    const title = document.createElement('div'); title.className='item-title'; title.textContent = `${fileName} • ${lutName}`;
    const img = document.createElement('img'); img.className='thumb'; img.src=url;
    const row = document.createElement('div'); row.className='mini-row';
    const dlBtn = document.createElement('button'); dlBtn.className='btn-accent'; dlBtn.textContent='Tải';
    dlBtn.onclick = ()=>{ const a=document.createElement('a'); a.href=url; a.download=`${fileBaseName(fileName)}_${fileBaseName(lutName)}.png`; document.body.appendChild(a); a.click(); a.remove(); };
    row.appendChild(document.createElement('div'));
    row.appendChild(dlBtn);
    card.appendChild(title); card.appendChild(img); card.appendChild(row);
    resultsGrid.appendChild(card);
  }

  async function processImageWithLUT(imageEntry, lut){
    const {img, width, height} = imageEntry;
    const srcCanvas = document.createElement('canvas'); srcCanvas.width=width; srcCanvas.height=height;
    const srcCtx = srcCanvas.getContext('2d'); srcCtx.drawImage(img,0,0,width,height);
    const srcImageData = srcCtx.getImageData(0,0,width,height);
    const out = applyLUTToImageData(srcImageData, lut);
    const outCanvas = document.createElement('canvas'); outCanvas.width=width; outCanvas.height=height;
    const outCtx = outCanvas.getContext('2d'); outCtx.putImageData(out,0,0);
    return new Promise(res=> outCanvas.toBlob(b=>res(b), 'image/png'));
  }

  applyAllBtn.addEventListener('click', async ()=>{
    if(!(currentImages.length && currentLUTs.length)) return alert('Vui lòng thêm ảnh và LUT.');
    const lutIndex = parseInt(lutSelectEl.value || '0',10) || 0;
    const lut = currentLUTs[lutIndex];
    applyAllBtn.disabled = true; const originalText = applyAllBtn.textContent; applyAllBtn.textContent = 'Đang xử lý...';
    resultsGrid.innerHTML = '';
    for(let i=0;i<currentImages.length;i++){
      applyAllBtn.textContent = `Đang xử lý (${i+1}/${currentImages.length})...`;
      try{
        const blob = await processImageWithLUT(currentImages[i], lut);
        appendResultCard(currentImages[i].fileName, lut.name, blob);
      }catch(err){ alert('Lỗi khi xử lý ảnh: '+err.message); }
    }
    applyAllBtn.textContent = originalText; applyAllBtn.disabled = false;
  });

  // Simple drag & drop for image & LUT
  ['dragover','drop'].forEach(evt => {
    window.addEventListener(evt, e=>{
      e.preventDefault(); e.stopPropagation();
    });
  });
  window.addEventListener('drop', async (e)=>{
    const files = e.dataTransfer.files;
    if(!files || !files.length) return;
    // Add all compatible files
    addImagesFromFileList(files);
    addLUTsFromFileList(files);
  });

  </script>
</body>
</html>
