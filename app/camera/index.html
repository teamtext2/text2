<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="google" content="notranslate"> 
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
    crossorigin="anonymous"></script>
    <!-- SEO Meta Tags -->
    <title>Text2 - Camera</title>
    <meta name="description" content="Text2 Camera - Free online photo and video capture app. Take high-quality photos, record HD videos, add watermarks, local storage. No installation required, use directly in browser.">
    <meta name="keywords" content="Text2 Camera, online photo capture, online video recording, web camera, camera app, free photo capture, free video recording, web cam, photo capture, video recording">
    <meta name="author" content="Text2">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-6J85STMJ14');
  </script>
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website"> 
    <meta property="og:url" content="https://text2.pro/app/camera/">
    <meta property="og:title" content="Text2 Camera - Free online photo and video capture app">
    <meta property="og:description" content="Text2 Camera - Free online photo and video capture app. Take high-quality photos, record HD videos, add watermarks, local storage. No installation required, use directly in browser.">
    <meta property="og:image" content="/favicon.ico">
    <meta property="og:image:width" content="32">
    <meta property="og:image:height" content="32">
    <meta property="og:site_name" content="Text2 Camera">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:url" content="https://text2.pro/app/camera/">
    <meta name="twitter:title" content="Text2 Camera - Free online photo and video capture app">
    <meta name="twitter:description" content="Text2 Camera - Free online photo and video capture app. Take high-quality photos, record HD videos, add watermarks, local storage.">
    <meta name="twitter:image" content="/favicon.ico">
    <meta name="twitter:creator" content="@text2">

    <!-- Additional SEO -->
    <link rel="canonical" href="https://text2.pro/app/camera/">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Text2 Camera">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Text2 Camera",
        "description": "Free online photo and video capture app with professional features",
        "url": "https://text2.pro/app/camera/",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Organization",
            "name": "Text2"
        },
        "featureList": [
            "High-quality photo capture",
            "HD video recording",
            "Add watermarks",
            "Local storage",
            "Multiple image formats",
            "Grid overlay support",
            "Front/rear camera flip"
        ]
    }
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure full screen and no scrolling */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom scrollbar for gallery */
        .modal-body::-webkit-scrollbar {
            width: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background-color: #52525b; /* neutral-600 */
            border-radius: 20px;
        }

        /* Flash effect when capturing */
        .flash-effect {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 99;
        }
        .flash-effect.flash {
            visibility: visible;
            opacity: 0.8;
        }

        /* Camera grid */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            pointer-events: none;
            z-index: 5;
        }
        .grid-overlay > div {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Capture button */
        .capture-btn {
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 50%;
            border: 6px solid rgba(255, 255, 255, 0.3); /* Thicker and transparent */
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3); /* Add shadow */
            transition: all 0.2s ease;
        }
        .capture-btn:active {
            transform: scale(0.9);
            background-color: #f1f5f9; /* Slightly gray when pressed */
        }
        /* Button when recording video */
        .capture-btn.recording {
            background-color: red;
            border-color: rgba(255, 0, 0, 0.4);
            animation: pulse 1.5s infinite;
        }
        .capture-btn.recording::before {
            content: '';
            display: block;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 4px;
        }
        @keyframes pulse {
            0% { border-color: rgba(255, 0, 0, 0.4); }
            50% { border-color: rgba(255, 0, 0, 0); }
            100% { border-color: rgba(255, 0, 0, 0.4); }
        }

        /* Toggle button (iOS Style) */
        .toggle-bg {
            width: 3rem; /* 48px */
            height: 1.75rem; /* 28px */
            background-color: #3f3f46; /* neutral-700 */
            border-radius: 9999px;
            padding: 0.25rem; /* 4px */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .toggle-bg.toggled {
            background-color: #3b82f6; /* blue-500 */
        }
        .toggle-dot {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            background-color: white;
            border-radius: 50%;
            transform: translateX(0);
            transition: transform 0.2s ease-in-out;
            display: block;
        }
        .toggle-dot.toggled {
            transform: translateX(1.25rem); /* 20px */
        }
    </style>
</head>
<body class="bg-black text-white h-full w-full relative">

    <!-- Camera View -->
    <video id="cameraView" class="w-full h-full object-cover" playsinline autoplay muted></video>

    <!-- Canvas (hidden) for photo capture -->
    <canvas id="canvas" class="hidden"></canvas>

    <!-- Flash effect -->
    <div id="flashEffect" class="flash-effect"></div>

    <!-- Camera Grid (hidden by default) -->
    <div id="gridOverlay" class="grid-overlay hidden">
        <div></div><div></div><div></div>
        <div></div><div></div><div></div>
        <div></div><div></div><div></div>
    </div>

    <!-- Top UI -->
    <div class="absolute top-0 left-0 right-0 p-5 flex justify-between items-center z-10" style="background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0));">
        <button id="openSettingsBtn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
            <!-- Settings Icon (SVG) - Updated -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a6.759 6.759 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
        </button>
        <!-- Add other buttons here if needed (e.g. flash) -->
    </div>

    <!-- Bottom UI -->
    <div class="absolute bottom-0 left-0 right-0 p-5 z-10" style="background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0));">
        <!-- Mode switcher -->
        <div class="flex justify-center items-center gap-4 mb-4">
            <button id="modePhoto" class="text-lg font-bold text-white transition-all">PHOTO</button>
            <button id="modeVideo" class="text-lg font-medium text-gray-400 transition-all">VIDEO</button>
        </div>
        
        <!-- Main button row -->
        <div class="flex justify-between items-center">
            <!-- Gallery -->
            <button id="openGalleryBtn" class="w-14 h-14 flex items-center justify-center bg-black/30 backdrop-blur-sm border border-white/20 rounded-full hover:bg-white/20 transition-colors">
                <!-- Gallery Icon (SVG) - Updated -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Z" />
                </svg>
            </button>

            <!-- Capture/Record Button -->
            <button id="captureBtn" class="capture-btn flex items-center justify-center"></button>

            <!-- Flip Camera -->
            <button id="flipCameraBtn" class="w-14 h-14 flex items-center justify-center bg-black/30 backdrop-blur-sm border border-white/20 rounded-full hover:bg-white/20 transition-colors">
                <!-- Flip Camera Icon (SVG) - Updated -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </div>
    </div>


    <!-- =================================== -->
    <!-- MODALS (POPUP) -->
    <!-- =================================== -->

    <!-- Common Modal (Overlay) -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-md z-40 hidden" data-target=""></div>

    <!-- Modal: Settings -->
    <div id="settingsModal" class="fixed bottom-0 left-0 right-0 bg-neutral-900 rounded-t-2xl p-5 shadow-lg z-50 transform translate-y-full transition-transform duration-300 max-h-[80vh] flex flex-col">
        <h3 class="text-xl font-bold text-center mb-4 flex-shrink-0">Settings</h3>
        
        <div class="space-y-4 overflow-y-auto modal-body flex-1">
            <!-- Auto download -->
            <div class="flex justify-between items-center p-3 bg-neutral-800 rounded-lg">
                <span class="text-gray-200">Auto download</span>
                <button id="toggleAutoDownload" class="toggle-bg">
                    <span class="toggle-dot"></span>
                </button>
            </div>
            
            <!-- Grid -->
            <div class="flex justify-between items-center p-3 bg-neutral-800 rounded-lg">
                <span class="text-gray-200">Show grid</span>
                <button id="toggleGrid" class="toggle-bg">
                    <span class="toggle-dot"></span>
                </button>
            </div>

            <!-- Watermark -->
            <div class="flex justify-between items-center p-3 bg-neutral-800 rounded-lg">
                <span class="text-gray-200">Watermark (text2)</span>
                <button id="toggleWatermark" class="toggle-bg">
                    <span class="toggle-dot"></span>
                </button>
            </div>

            <!-- Mirror front camera -->
            <div class="flex justify-between items-center p-3 bg-neutral-800 rounded-lg">
                <span class="text-gray-200">Mirror front camera</span>
                <button id="toggleMirrorFrontCamera" class="toggle-bg">
                    <span class="toggle-dot"></span>
                </button>
            </div>

            <!-- Resolution button -->
            <button id="openResolutionBtn" class="w-full text-left p-3 bg-neutral-800 rounded-lg flex justify-between items-center hover:bg-neutral-700">
                <span>Resolution</span>
                <span id="currentResolution" class="text-gray-400">Default</span>
            </button>

            <!-- Aspect ratio button -->
            <button id="openAspectRatioBtn" class="w-full text-left p-3 bg-neutral-800 rounded-lg flex justify-between items-center hover:bg-neutral-700">
                <span>Aspect ratio</span>
                <span id="currentAspectRatio" class="text-gray-400">16:9</span>
            </button>

            <!-- Image type button -->
            <button id="openImageTypeBtn" class="w-full text-left p-3 bg-neutral-800 rounded-lg flex justify-between items-center hover:bg-neutral-700">
                <span>Image type</span>
                <span id="currentImageType" class="text-gray-400">PNG</span>
            </button>
            
            <!-- Update (Clear Cache) -->
            <button id="updateAppBtn" class="w-full p-3 bg-blue-600 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Update
            </button>
        </div>
        
        <button id="closeSettingsBtn" class="absolute top-3 right-3 p-2 text-gray-400 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <!-- Modal: Gallery -->
    <div id="galleryModal" class="fixed inset-0 bg-neutral-900 z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
        <!-- Gallery Header -->
        <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-neutral-700">
            <button id="closeGalleryBtn" class="p-2 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-xl font-bold">Gallery</h3>
            <div class="flex gap-2">
                <!-- Download all -->
                <button id="downloadAllBtn" class="p-2 text-gray-400 hover:text-white" title="Download all">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m7.5 7.5 4.5-4.5m0 0 4.5 4.5m-4.5-4.5v9m0 0H6A2.25 2.25 0 0 0 3.75 15v.75c0 1.242.984 2.25 2.25 2.25h13.5A2.25 2.25 0 0 0 21 15.75V15A2.25 2.25 0 0 0 18.75 12.75h-3.75m0 0h-.375c-.621 0-1.125.504-1.125 1.125v.75c0 .621.504 1.125 1.125 1.125h.375m0-3h.375c.621 0 1.125.504 1.125 1.125v.75c0 .621-.504 1.125-1.125 1.125h-.375m0 0H15m-1.125-3H12m0 0v3m0-3c0-.621-.504-1.125-1.125-1.125H9.75c-.621 0-1.125.504-1.125 1.125v3c0 .621.504 1.125 1.125 1.125h.375m0-3H12" />
                    </svg>
                </button>
                <!-- Delete all -->
                <button id="deleteAllBtn" class="p-2 text-red-500 hover:text-red-400" title="Delete all">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.502 0c-.34.053-.68.107-1.022.166m11.022 0L12 5.25v0l-.384.455M18.16 5.79l-1.17-1.403a.375.375 0 0 0-.488-.141l-3.027.954a.375.375 0 0 1-.432-.495V3m0 0l-3.027-.954a.375.375 0 0 0-.488.141L6.84 5.79m0 0L12 5.25v0l-.384.455m0 0v.008c.004.002.007.004.01.006.002.002.005.004.007.006" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Gallery Content -->
        <div id="galleryContainer" class="modal-body flex-1 p-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-1.5 overflow-y-auto">
            <!-- Photos/Videos will be added here by JS -->
            <p id="galleryPlaceholder" class="col-span-full text-center text-gray-500 mt-10">Gallery is empty.</p>
        </div>
    </div>

    <!-- Modal: Selection (shared) -->
    <div id="selectionModal" class="fixed bottom-0 left-0 right-0 bg-neutral-900 rounded-t-2xl p-5 shadow-lg z-50 transform translate-y-full transition-transform duration-300 max-h-[70vh] flex flex-col">
        <h3 id="selectionTitle" class="text-lg font-bold text-center mb-4 flex-shrink-0">Selection</h3>
        <div id="selectionOptions" class="space-y-2 overflow-y-auto modal-body">
            <!-- Options will be added here by JS -->
        </div>
        <button id="closeSelectionModal" class="mt-4 w-full p-3 bg-neutral-800 rounded-lg font-semibold hover:bg-neutral-700 flex-shrink-0">
            Cancel
        </button>
    </div>

    <!-- Modal: View photo/video -->
    <div id="viewerModal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="flex-shrink-0 flex justify-between items-center p-4" style="background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0,0,0,0));">
            <button id="closeViewerBtn" class="p-2 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                </svg>
            </button>
            <div class="flex gap-4">
                <button id="downloadViewBtn" class="p-2 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </button>
                <button id="deleteViewBtn" class="p-2 text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.502 0c-.34.053-.68.107-1.022.166m11.022 0L12 5.25v0l-.384.455M18.16 5.79l-1.17-1.403a.375.375 0 0 0-.488-.141l-3.027.954a.375.375 0 0 1-.432-.495V3m0 0l-3.027-.954a.375.375 0 0 0-.488.141L6.84 5.79m0 0L12 5.25v0l-.384.455m0 0v.008c.004.002.007.004.01.006.002.002.005.004.007.006" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="flex-1 flex items-center justify-center p-4">
            <img id="viewerImage" src="" class="max-w-full max-h-full hidden object-contain transition-transform duration-300" alt="View image">
            <video id="viewerVideo" src="" class="max-w-full max-h-full hidden" controls></video>
        </div>
    </div>


    <!-- JavaScript Inline -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 1. DOM Elements ===
            const video = document.getElementById('cameraView');
            const canvas = document.getElementById('canvas');
            const captureBtn = document.getElementById('captureBtn');
            const flipCameraBtn = document.getElementById('flipCameraBtn');
            const gridOverlay = document.getElementById('gridOverlay');
            const flashEffect = document.getElementById('flashEffect');
            
            const modePhotoBtn = document.getElementById('modePhoto');
            const modeVideoBtn = document.getElementById('modeVideo');

            const modalOverlay = document.getElementById('modalOverlay');
            
            // Settings Modal
            const settingsModal = document.getElementById('settingsModal');
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const toggleAutoDownload = document.getElementById('toggleAutoDownload');
            const toggleGrid = document.getElementById('toggleGrid');
            const toggleWatermark = document.getElementById('toggleWatermark');
            const toggleMirrorFrontCamera = document.getElementById('toggleMirrorFrontCamera');
            const updateAppBtn = document.getElementById('updateAppBtn');
            
            // Gallery Modal
            const galleryModal = document.getElementById('galleryModal');
            const openGalleryBtn = document.getElementById('openGalleryBtn');
            const closeGalleryBtn = document.getElementById('closeGalleryBtn');
            const galleryContainer = document.getElementById('galleryContainer');
            const galleryPlaceholder = document.getElementById('galleryPlaceholder');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            
            // Selection Modals
            const selectionModal = document.getElementById('selectionModal');
            const selectionTitle = document.getElementById('selectionTitle');
            const selectionOptions = document.getElementById('selectionOptions');
            const closeSelectionModal = document.getElementById('closeSelectionModal');
            const openResolutionBtn = document.getElementById('openResolutionBtn');
            const openAspectRatioBtn = document.getElementById('openAspectRatioBtn');
            const openImageTypeBtn = document.getElementById('openImageTypeBtn');
            const currentResolution = document.getElementById('currentResolution');
            const currentAspectRatio = document.getElementById('currentAspectRatio');
            const currentImageType = document.getElementById('currentImageType');
            
            // Viewer Modal
            const viewerModal = document.getElementById('viewerModal');
            const closeViewerBtn = document.getElementById('closeViewerBtn');
            const viewerImage = document.getElementById('viewerImage');
            const viewerVideo = document.getElementById('viewerVideo');
            const downloadViewBtn = document.getElementById('downloadViewBtn');
            const deleteViewBtn = document.getElementById('deleteViewBtn');

            // === 2. State Management ===
            let currentStream = null;
            let currentFacingMode = 'environment'; // 'user' (front) or 'environment' (rear)
            let currentMode = 'photo'; // 'photo' or 'video'
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];
            let viewerCurrentId = null;

            let db = null;
            const DB_NAME = 'Text2CamDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'gallery';
            
            let settings = {
                autoDownload: false,
                grid: false,
                watermark: false,
                mirrorFrontCamera: true, // Default mirror front camera
                imageType: 'image/png',
                imageExtension: 'png',
                resolution: { label: 'Default', value: null },
                aspectRatio: { label: '16:9', value: 16/9 },
            };

            const resolutions = [
                { label: 'Default', value: null },
                { label: '4K (3840x2160)', value: { width: 3840, height: 2160 } },
                { label: 'Full HD (1920x1080)', value: { width: 1920, height: 1080 } },
                { label: 'HD (1280x720)', value: { width: 1280, height: 720 } },
                { label: 'SD (640x480)', value: { width: 640, height: 480 } },
            ];
            const aspectRatios = [
                { label: '16:9', value: 16/9 },
                { label: '4:3', value: 4/3 },
                { label: '1:1', value: 1 },
                { label: '9:16 (Portrait)', value: 9/16 },
            ];
            const imageTypes = [
                { label: 'PNG', value: 'image/png', ext: 'png' },
                { label: 'JPEG', value: 'image/jpeg', ext: 'jpg' },
                { label: 'WebP', value: 'image/webp', ext: 'webp' },
            ];

            // === 3. IndexedDB Functions ===
            function initDB() {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database initialized');
                };

                request.onerror = (event) => {
                    console.error('Database error:', event.target.errorCode);
                };
            }
            function saveMedia(blob, type, facingMode = 'environment') {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const mediaFile = {
                    blob: blob,
                    type: type, // 'photo' or 'video'
                    facingMode: facingMode, // 'user' or 'environment'
                    timestamp: new Date()
                };
                store.add(mediaFile);

                transaction.oncomplete = () => {
                    console.log('Media saved to DB');
                    // Auto download if enabled
                    if (settings.autoDownload && type === 'photo') {
                        downloadMedia(blob, `text2cam.${settings.imageExtension}`);
                    }
                    if (settings.autoDownload && type === 'video') {
                        downloadMedia(blob, `text2cam.webm`);
                    }
                };
                transaction.onerror = (event) => {
                    console.error('Error saving media:', event.target.error);
                };
            }

            function getGallery(callback) {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => {
                    callback(event.target.result.reverse()); // Latest first
                };
            }

            function deleteMedia(id) {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete(id);
                transaction.oncomplete = () => {
                    console.log(`Media ${id} deleted`);
                    renderGallery(); // Update gallery
                    if (viewerCurrentId === id) {
                        closeViewer();
                    }
                };
            }

            function clearGallery() {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();
                transaction.oncomplete = () => {
                    console.log('Gallery cleared');
                    renderGallery();
                    closeViewer();
                };
            }

            function getMediaById(id, callback) {
                if (!db) return;
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = (event) => {
                    callback(event.target.result);
                };
            }


            // === 4. Camera Functions ===
            async function startCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                let constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        aspectRatio: settings.aspectRatio.value ? { exact: settings.aspectRatio.value } : undefined,
                    },
                    audio: (currentMode === 'video') // Only request audio in video mode
                };

                if (settings.resolution.value) {
                    constraints.video.width = { ideal: settings.resolution.value.width };
                    constraints.video.height = { ideal: settings.resolution.value.height };
                }

                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = currentStream;
                    video.style.transform = (currentFacingMode === 'user' && settings.mirrorFrontCamera) ? 'scaleX(-1)' : 'scaleX(1)';
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Cannot access camera. Please grant permission.");
                }
            }

            function flipCamera() {
                currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
                startCamera();
            }

            // === 5. Capture Functions ===
            function takePicture() {
                // Flash effect
                flashEffect.classList.add('flash');
                setTimeout(() => flashEffect.classList.remove('flash'), 300);

                const context = canvas.getContext('2d');
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                canvas.width = videoWidth;
                canvas.height = videoHeight;

                // Mirror image if front camera and setting enabled
                context.save();
                if (currentFacingMode === 'user' && settings.mirrorFrontCamera) {
                    context.translate(videoWidth, 0);
                    context.scale(-1, 1);
                }

                context.drawImage(video, 0, 0, videoWidth, videoHeight);
                context.restore();

                // Add watermark if enabled
                if (settings.watermark) {
                    context.font = `${Math.min(videoWidth, videoHeight) * 0.05}px Arial`;
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    context.textAlign = 'right';
                    context.textBaseline = 'bottom';
                    context.fillText('text2', videoWidth - 20, videoHeight - 20);
                }

                canvas.toBlob((blob) => {
                    saveMedia(blob, 'photo', currentFacingMode);
                }, settings.imageType, 0.95); // 0.95 quality for jpeg/webp
            }

            function startRecording() {
                if (!currentStream || isRecording) return;
                isRecording = true;
                recordedChunks = [];
                captureBtn.classList.add('recording');

                // Get both video and audio tracks
                const tracks = [...currentStream.getVideoTracks(), ...currentStream.getAudioTracks()];
                const combinedStream = new MediaStream(tracks);

                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    saveMedia(blob, 'video', currentFacingMode);
                    recordedChunks = [];
                };

                mediaRecorder.start();
            }

            function stopRecording() {
                if (!mediaRecorder || !isRecording) return;
                isRecording = false;
                captureBtn.classList.remove('recording');
                mediaRecorder.stop();
            }


            // === 6. Modal Functions ===
            function openModal(modalElement, isSubModal = false) {
                if (!isSubModal) {
                    modalOverlay.classList.remove('hidden');
                    modalOverlay.dataset.target = modalElement.id;
                }
                modalElement.classList.remove('translate-y-full');
            }

            function closeModal() {
                const targetId = modalOverlay.dataset.target;
                if (targetId) {
                    document.getElementById(targetId).classList.add('translate-y-full');
                }
                modalOverlay.classList.add('hidden');
                modalOverlay.dataset.target = '';
                
                // Also close selection modal
                selectionModal.classList.add('translate-y-full');
            }
            
            closeSelectionModal.addEventListener('click', () => {
                 selectionModal.classList.add('translate-y-full');
            });


            // === 7. Settings Functions ===
            function loadSettings() {
                const savedSettings = localStorage.getItem('text2CamSettings');
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
                updateSettingsUI();
            }

            function saveSettings() {
                localStorage.setItem('text2CamSettings', JSON.stringify(settings));
                updateSettingsUI();
            }

            function updateSettingsUI() {
                // Toggles
                updateToggle(toggleAutoDownload, settings.autoDownload);
                updateToggle(toggleGrid, settings.grid);
                updateToggle(toggleWatermark, settings.watermark);
                updateToggle(toggleMirrorFrontCamera, settings.mirrorFrontCamera);
                
                // Grid
                gridOverlay.classList.toggle('hidden', !settings.grid);

                // Preview transform according to mirror setting
                video.style.transform = (currentFacingMode === 'user' && settings.mirrorFrontCamera) ? 'scaleX(-1)' : 'scaleX(1)';

                // Labels
                currentResolution.textContent = settings.resolution.label;
                currentAspectRatio.textContent = settings.aspectRatio.label;
                currentImageType.textContent = settings.imageType.split('/')[1].toUpperCase();
            }

            function updateToggle(button, isActive) {
                const bg = button;
                const dot = button.querySelector('span');
                if (isActive) {
                    bg.classList.add('toggled');
                    dot.classList.add('toggled');
                } else {
                    bg.classList.remove('toggled');
                    dot.classList.remove('toggled');
                }
            }

            // Open common selection modal
            function openSelectionModal(title, options, currentSettingKey, callback) {
                selectionTitle.textContent = title;
                selectionOptions.innerHTML = ''; // Clear old options
                
                options.forEach(option => {
                    const isSelected = JSON.stringify(settings[currentSettingKey]) === JSON.stringify(option);
                    
                    const optionBtn = document.createElement('button');
                    optionBtn.className = `w-full text-left p-3 rounded-lg flex justify-between items-center ${isSelected ? 'bg-blue-600 text-white' : 'bg-neutral-800 hover:bg-neutral-700'}`;
                    optionBtn.innerHTML = `
                        <span>${option.label}</span>
                        ${isSelected ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>' : ''}
                    `;
                    
                    optionBtn.onclick = () => {
                        callback(option);
                        saveSettings();
                        selectionModal.classList.add('translate-y-full');
                        // Restart camera if resolution or aspect ratio changed
                        if (currentSettingKey === 'resolution' || currentSettingKey === 'aspectRatio') {
                            startCamera();
                        }
                    };
                    selectionOptions.appendChild(optionBtn);
                });
                
                openModal(selectionModal, true); // true because this is a sub-modal
            }


            // === 8. Gallery Functions ===
            function renderGallery() {
                getGallery((mediaItems) => {
                    galleryContainer.innerHTML = ''; // Clear old content
                    if (mediaItems.length === 0) {
                        galleryContainer.appendChild(galleryPlaceholder);
                        return;
                    }
                    
                    mediaItems.forEach(item => {
                        const url = URL.createObjectURL(item.blob);
                        const itemWrapper = document.createElement('div');
                        itemWrapper.className = 'relative aspect-square bg-neutral-800 rounded-lg overflow-hidden group';
                        
                        let mediaElement;
                        if (item.type === 'photo') {
                            mediaElement = document.createElement('img');
                            mediaElement.src = url;
                            mediaElement.className = 'w-full h-full object-cover';
                        } else {
                            mediaElement = document.createElement('video');
                            mediaElement.src = url;
                            mediaElement.className = 'w-full h-full object-cover';
                            // Add play icon for video
                            const playIcon = document.createElement('div');
                            playIcon.className = 'absolute inset-0 flex items-center justify-center opacity-80 group-hover:opacity-100 transition-opacity';
                            playIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-white/90"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.92-1.4 1.671-.983l5.603 3.113Z" clip-rule="evenodd" /></svg>`;
                            itemWrapper.appendChild(playIcon);
                        }
                        
                        // Hidden buttons (show on hover)
                        const controls = document.createElement('div');
                        controls.className = 'absolute bottom-0 left-0 right-0 p-1 flex justify-end gap-1 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity';
                        
                        // Download button
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'p-1 text-white hover:text-blue-400';
                        downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>`;
                        downloadBtn.onclick = (e) => {
                            e.stopPropagation();
                            const ext = item.type === 'photo' ? settings.imageExtension : 'webm';
                            downloadMedia(item.blob, `text2cam_${item.id}.${ext}`);
                        };
                        
                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'p-1 text-white hover:text-red-500';
                        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.502 0c-.34.053-.68.107-1.022.166m11.022 0L12 5.25v0l-.384.455M18.16 5.79l-1.17-1.403a.375.375 0 0 0-.488-.141l-3.027.954a.375.375 0 0 1-.432-.495V3m0 0l-3.027-.954a.375.375 0 0 0-.488.141L6.84 5.79m0 0L12 5.25v0l-.384.455m0 0v.008c.004.002.007.004.01.006.002.002.005.004.007.006" /></svg>`;
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm('Are you sure you want to delete this photo/video?')) {
                                deleteMedia(item.id);
                            }
                        };
                        
                        controls.appendChild(downloadBtn);
                        controls.appendChild(deleteBtn);
                        
                        itemWrapper.appendChild(mediaElement);
                        itemWrapper.appendChild(controls);
                        
                        // Click to view
                        itemWrapper.onclick = () => {
                            openViewer(item.id, url, item.type, item.facingMode);
                        };
                        
                        galleryContainer.appendChild(itemWrapper);
                    });
                });
            }

            function downloadMedia(blob, filename) {
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function downloadAll() {
                getGallery((mediaItems) => {
                    if (mediaItems.length === 0) {
                        alert("Gallery is empty.");
                        return;
                    }
                    mediaItems.forEach((item, index) => {
                        const ext = item.type === 'photo' ? settings.imageExtension : 'webm';
                        // Add small timeout for browser to handle multiple downloads
                        setTimeout(() => {
                            downloadMedia(item.blob, `text2cam_${item.id}.${ext}`);
                        }, index * 300);
                    });
                });
            }


            // === 9. Viewer Functions ===
            function openViewer(id, url, type, facingMode = 'environment') {
                viewerCurrentId = id;
                if (type === 'photo') {
                    viewerImage.src = url;
                    viewerImage.classList.remove('hidden');
                    // Mirror image if front camera AND setting enabled
                    viewerImage.style.transform = (facingMode === 'user' && settings.mirrorFrontCamera) ? 'scaleX(-1)' : 'scaleX(1)';
                    
                    viewerVideo.classList.add('hidden');
                    viewerVideo.pause();
                    viewerVideo.src = '';
                } else {
                    viewerVideo.src = url;
                    viewerVideo.classList.remove('hidden');
                    viewerImage.classList.add('hidden');
                    viewerImage.src = '';
                }
                viewerModal.classList.remove('hidden');
            }

            function closeViewer() {
                viewerModal.classList.add('hidden');
                viewerImage.src = '';
                viewerImage.style.transform = 'scaleX(1)'; // Reset mirror
                viewerVideo.src = '';
                viewerVideo.pause();
                viewerCurrentId = null;
            }


            // === 10. Event Listeners ===
            
            // Mode switching
            modePhotoBtn.addEventListener('click', () => {
                if (isRecording) stopRecording();
                currentMode = 'photo';
                modePhotoBtn.classList.add('font-bold', 'text-white');
                modePhotoBtn.classList.remove('font-medium', 'text-gray-400');
                modeVideoBtn.classList.add('font-medium', 'text-gray-400');
                modeVideoBtn.classList.remove('font-bold', 'text-white');
                captureBtn.classList.remove('recording');
                openImageTypeBtn.disabled = false;
                openImageTypeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startCamera(); // Restart camera to disable audio
            });
            modeVideoBtn.addEventListener('click', () => {
                currentMode = 'video';
                modeVideoBtn.classList.add('font-bold', 'text-white');
                modeVideoBtn.classList.remove('font-medium', 'text-gray-400');
                modePhotoBtn.classList.add('font-medium', 'text-gray-400');
                modePhotoBtn.classList.remove('font-bold', 'text-white');
                openImageTypeBtn.disabled = true;
                openImageTypeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                startCamera(); // Restart camera to enable audio
            });
            
            // Main buttons
            captureBtn.addEventListener('click', () => {
                if (currentMode === 'photo') {
                    takePicture();
                } else {
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                }
            });
            
            flipCameraBtn.addEventListener('click', flipCamera);
            modalOverlay.addEventListener('click', closeModal);

            // Settings
            openSettingsBtn.addEventListener('click', () => openModal(settingsModal));
            closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('translate-y-full'));

            toggleAutoDownload.addEventListener('click', () => {
                settings.autoDownload = !settings.autoDownload;
                saveSettings();
            });
            toggleGrid.addEventListener('click', () => {
                settings.grid = !settings.grid;
                saveSettings();
            });
            toggleWatermark.addEventListener('click', () => {
                settings.watermark = !settings.watermark;
                saveSettings();
            });
            toggleMirrorFrontCamera.addEventListener('click', () => {
                settings.mirrorFrontCamera = !settings.mirrorFrontCamera;
                saveSettings();
            });
            updateAppBtn.addEventListener('click', () => {
                if (confirm('Clear cache and reload page? Gallery photos will be kept.')) {
                    location.reload(); // Don't use 'true' to try to keep IndexedDB
                }
            });

            // Open selection sub-modals
            openResolutionBtn.addEventListener('click', () => {
                openSelectionModal('Resolution', resolutions, 'resolution', (option) => {
                    settings.resolution = option;
                });
            });
            openAspectRatioBtn.addEventListener('click', () => {
                openSelectionModal('Aspect ratio', aspectRatios, 'aspectRatio', (option) => {
                    settings.aspectRatio = option;
                });
            });
            openImageTypeBtn.addEventListener('click', () => {
                openSelectionModal('Image type', imageTypes, 'imageType', (option) => {
                    settings.imageType = option.value;
                    settings.imageExtension = option.ext;
                });
            });

            // Gallery
            openGalleryBtn.addEventListener('click', () => {
                renderGallery();
                openModal(galleryModal);
            });
            closeGalleryBtn.addEventListener('click', () => galleryModal.classList.add('translate-y-full'));
            
            deleteAllBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to DELETE ALL photos and videos? This action cannot be undone.')) {
                    clearGallery();
                }
            });
            downloadAllBtn.addEventListener('click', downloadAll);

            // Viewer
            closeViewerBtn.addEventListener('click', closeViewer);
            deleteViewBtn.addEventListener('click', () => {
                if (viewerCurrentId && confirm('Are you sure you want to delete this photo/video?')) {
                    deleteMedia(viewerCurrentId);
                }
            });
            downloadViewBtn.addEventListener('click', () => {
                if (!viewerCurrentId) return;
                getMediaById(viewerCurrentId, (item) => {
                    if (item) {
                        const ext = item.type === 'photo' ? settings.imageExtension : 'webm';
                        downloadMedia(item.blob, `text2cam_${item.id}.${ext}`);
                    }
                });
            });

            // === 11. Initialization ===
            initDB();
            loadSettings();
            startCamera();
        });
    </script>
</body>
</html>

