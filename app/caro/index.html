<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>Text2 Caro Game</title>
    <meta name="description" content="Play Text2 Caro Game online for free! 15x15 Tic-Tac-Toe game with smart AI, beautiful interface. Challenge yourself with Text2-Bot or play with friends.">
    <meta name="keywords" content="text2 caro game, tic-tac-toe online, free caro game, caro 15x15, text2 game, caro AI, play caro online">
    <meta name="author" content="Text2 Team">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Text2 Caro Game - Play Tic-Tac-Toe Online Free">
    <meta property="og:description" content="Play Text2 Caro Game online for free! 15x15 Tic-Tac-Toe game with smart AI, beautiful interface. Challenge yourself with Text2-Bot or play with friends.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://text2.pro/app/caro/">
    <meta property="og:site_name" content="Text2.pro">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Text2 Caro Game - Play Tic-Tac-Toe Online Free">
    <meta name="twitter:description" content="Play Text2 Caro Game online for free! 15x15 Tic-Tac-Toe game with smart AI, beautiful interface.">
    <meta name="twitter:site" content="@text2pro">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://text2.pro/app/caro/">
    
    <!-- Breadcrumb Navigation -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Text2.pro",
                "item": "https://text2.pro"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "Apps",
                "item": "https://text2.pro/app/"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "Text2 Caro Game",
                "item": "https://text2.pro/app/caro/"
            }
        ]
    }
    </script>
    
    <!-- Game/Software Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Game",
        "name": "Text2 Caro Game",
        "description": "Play Text2 Caro Game online for free! 15x15 Tic-Tac-Toe game with smart AI, beautiful interface. Challenge yourself with Text2-Bot or play with friends.",
        "url": "https://text2.pro/app/caro/",
        "genre": "Strategy Game",
        "gamePlatform": "Web Browser",
        "operatingSystem": "Any",
        "applicationCategory": "Game",
        "isAccessibleForFree": true,
        "inLanguage": "en",
        "publisher": {
            "@type": "Organization",
            "name": "Text2 Team",
            "url": "https://text2.pro"
        },
        "creator": {
            "@type": "Organization",
            "name": "Text2 Team",
            "url": "https://text2.pro"
        },
        "gameItem": {
            "@type": "Thing",
            "name": "Tic-Tac-Toe"
        },
        "numberOfPlayers": "1-2",
        "playMode": ["SinglePlayer", "MultiPlayer"]
    }
    </script>
    
    <!-- Website Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Text2.pro",
        "url": "https://text2.pro",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://text2.pro/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <meta name="google" content="notranslate"> 
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Analytics -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
    crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) - GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6J85STMJ14');
</script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo
                        secondary: '#EC4899', // Pink
                        board: '#F3F4F6',
                        'board-dark': '#E5E7EB',
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'piece': '2px 4px 6px rgba(0,0,0,0.2)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- ANIMATIONS --- */
        
        /* Piece bounce animation when placed */
        @keyframes bouncy-in {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(1.25) rotate(10deg); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1) rotate(0); }
        }

        .mark-animated {
            animation: bouncy-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            filter: drop-shadow(2px 4px 2px rgba(0,0,0,0.15)); /* Create 3D depth */
        }

        /* Ripple effect on click */
        @keyframes ripple {
            0% { width: 0px; height: 0px; opacity: 0.5; }
            100% { width: 100px; height: 100px; opacity: 0; }
        }
        
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: ripple 0.4s linear;
        }

        /* Game piece colors - Gradient Text */
        .cell-x i {
            background: linear-gradient(135deg, #EF4444, #B91C1C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8rem; /* Slightly larger */
        }
        
        .cell-o i {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.6rem;
        }

        /* Last move - Radar effect */
        .last-move::before {
            content: '';
            position: absolute;
            inset: 2px;
            border: 2px solid rgba(16, 185, 129, 0.5);
            border-radius: 12px;
            animation: pulse-border 1.5s infinite;
            z-index: 0;
        }

        @keyframes pulse-border {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }

        /* Winning line */
        .winning-cell {
            background: #FFFBEB !important;
            transition: background 0.3s;
        }
        .winning-cell i {
            animation: win-spin 1s ease-in-out infinite;
        }
        @keyframes win-spin {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Glassmorphism Modal */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Board Styling */
        .board-wrapper {
            box-shadow: 
                20px 20px 60px #d1d5db, 
                -20px -20px 60px #ffffff;
            border-radius: 20px;
            padding: 8px;
            background: #F3F4F6;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(15, minmax(34px, 1fr));
            grid-template-rows: repeat(15, minmax(34px, 1fr));
            gap: 2px; /* Smaller gap for smoother look */
            background-color: #CBD5E1; /* Grid line color */
            border-radius: 12px;
            overflow: hidden;
        }

        .cell {
            background-color: #F8FAFC;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            /* overflow: hidden; Remove this so piece shadows aren't clipped */
            aspect-ratio: 1 / 1; 
            transition: background-color 0.1s;
        }
        
        .cell:active {
            background-color: #E2E8F0;
        }

        /* Modern buttons */
        .btn-modern {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-modern:active {
            transform: scale(0.92);
        }

        /* Floating Header */
        .floating-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(255,255,255,0.8);
        }
    </style>
</head>
<body class="h-[100dvh] w-full overflow-hidden flex flex-col text-slate-800 select-none bg-slate-50">

    <!-- HEADER: Glassmorphism -->
    <header class="floating-header h-16 flex justify-between items-center px-5 z-30 shrink-0 absolute top-0 w-full">
        <div class="flex items-center gap-3">
            <!-- Turn Indicator with deep shadow -->
            <div id="turn-indicator" class="w-11 h-11 rounded-2xl bg-white flex items-center justify-center text-xl shadow-[0_4px_12px_rgba(0,0,0,0.08)] border border-slate-100 transition-all duration-300">
                <i class="fa-regular fa-circle text-blue-500"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Current Turn</span>
                <h1 id="status-text" class="text-base font-extrabold text-slate-700 leading-none mt-0.5">Player O</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="bg-slate-100/80 px-4 py-1.5 rounded-full border border-slate-200">
                <span id="timer" class="text-sm font-black text-slate-600 font-mono">00:00</span>
            </div>
            <button onclick="toggleSettings()" class="w-10 h-10 rounded-full active:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT: Game Board -->
    <main class="flex-1 overflow-auto relative no-scrollbar w-full flex justify-center items-start pt-20 pb-6" id="main-scroll">
        <div class="p-4 min-h-full flex items-center justify-center">
            <!-- Board Wrapper creates floating effect -->
            <div class="board-wrapper">
                <div id="game-board" class="board-container select-none">
                    <!-- JS will render game cells here -->
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM BAR: Floating Action Bar style -->
    <footer class="absolute bottom-6 left-0 w-full px-6 z-20 flex justify-center pointer-events-none">
        <div class="bg-white/90 backdrop-blur-md shadow-[0_8px_30px_rgb(0,0,0,0.12)] p-2 rounded-3xl flex items-center gap-4 pointer-events-auto border border-white/50">
            
            <!-- Undo Button -->
            <button onclick="undoMove()" id="btn-undo" class="btn-modern w-14 h-14 rounded-2xl bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center text-xl disabled:opacity-40 disabled:cursor-not-allowed shadow-sm border border-slate-100" disabled>
                <i class="fa-solid fa-rotate-left"></i>
            </button>

            <!-- Play/New Game Button (Largest) -->
            <button onclick="resetGame()" class="btn-modern w-20 h-20 rounded-[24px] bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center text-3xl shadow-lg shadow-blue-500/30 -mt-10 border-4 border-white">
                <i class="fa-solid fa-play ml-1"></i>
            </button>

            <!-- Mode Button -->
            <button onclick="toggleMode()" id="btn-mode" class="btn-modern w-14 h-14 rounded-2xl bg-slate-50 text-slate-500 hover:bg-slate-100 flex flex-col items-center justify-center shadow-sm border border-slate-100 relative overflow-hidden">
                <i class="fa-solid fa-robot text-lg mb-0.5" id="mode-icon"></i>
                <span class="text-[8px] font-bold uppercase" id="mode-mini-text">Text2-Bot</span>
                <!-- Indicator -->
                <div class="absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
            </button>
        </div>
    </footer>

    <!-- MODAL: Victory -->
    <div id="winner-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/30 backdrop-blur-[2px] opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-[85%] max-w-sm rounded-[32px] p-8 text-center transform scale-90 transition-transform duration-300 shadow-2xl border border-white/60" id="winner-modal-content">
            
            <div class="relative w-24 h-24 mx-auto mb-4">
                <div class="absolute inset-0 bg-yellow-400 rounded-full blur-xl opacity-20 animate-pulse"></div>
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-yellow-100 to-orange-50 flex items-center justify-center text-5xl text-yellow-500 shadow-inner relative z-10">
                    <i class="fa-solid fa-trophy drop-shadow-md"></i>
                </div>
            </div>

            <h2 class="text-3xl font-black text-slate-800 mb-2 tracking-tight" id="winner-title">Victory!</h2>
            <p class="text-slate-500 font-medium mb-8" id="winner-message">Player X wins absolutely.</p>
            
            <button onclick="closeModalAndReset()" class="btn-modern w-full py-4 rounded-2xl bg-slate-800 text-white font-bold text-lg shadow-lg shadow-slate-800/20">
                Play Again
            </button>
        </div>
    </div>

    <!-- MODAL: Settings -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center bg-slate-900/20 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:w-[90%] sm:max-w-sm sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 opacity-0" id="settings-panel">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-black text-slate-800">Settings</h3>
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <!-- Difficulty -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">AI Difficulty</label>
                <div class="grid grid-cols-2 gap-3 bg-slate-100 p-1.5 rounded-2xl">
                    <button onclick="setDifficulty('easy')" id="diff-easy" class="py-3 rounded-xl text-sm font-bold text-slate-500 transition-all">Easy</button>
                    <button onclick="setDifficulty('hard')" id="diff-hard" class="py-3 rounded-xl text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all">Super Hard</button>
                </div>
            </div>
            
            <!-- Sound -->
            <div class="flex items-center justify-between mb-10 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center">
                        <i class="fa-solid fa-volume-high"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-slate-800">Sound & Vibration</span>
                        <span class="text-xs text-slate-400">Haptic feedback</span>
                    </div>
                </div>
                <div class="relative inline-block w-12 h-7 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="sound-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-1 left-1 checked:left-6 shadow-sm" checked onclick="toggleSound()"/>
                    <label for="sound-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-slate-200 cursor-pointer transition-colors duration-300 checked:bg-indigo-500"></label>
                </div>
            </div>

            <div class="text-center pb-4">
                <p class="text-xs text-slate-300 font-semibold">Text2 Team In Dev @ 2025 - CEO text2 in dev</p>
            </div>
        </div>
    </div>

    <script>
        // Game Configuration (Keep original logic)
        const ROWS = 15;
        const COLS = 15;
        const WIN_COUNT = 5; 
        
        // State
        let board = [];
        let currentPlayer = 'x'; 
        let gameActive = true;
        let history = []; 
        let mode = 'pve'; 
        let aiDifficulty = 'hard'; 
        let soundEnabled = true;
        let timeSeconds = 0;
        let timerInterval = null;

        // DOM Elements
        const boardEl = document.getElementById('game-board');
        const statusTextEl = document.getElementById('status-text');
        const turnIndicatorEl = document.getElementById('turn-indicator');
        const timerEl = document.getElementById('timer');
        const modalEl = document.getElementById('winner-modal');
        const modalContentEl = document.getElementById('winner-modal-content');
        const settingsModalEl = document.getElementById('settings-modal');
        const settingsPanelEl = document.getElementById('settings-panel');
        const btnUndo = document.getElementById('btn-undo');
        const modeIcon = document.getElementById('mode-icon');
        const modeMiniText = document.getElementById('mode-mini-text');

        // --- INITIALIZATION ---
        function initGame() {
            board = Array(ROWS).fill().map(() => Array(COLS).fill(null));
            currentPlayer = 'x';
            gameActive = true;
            history = [];
            timeSeconds = 0;
            updateUI();
            renderBoard();
            startTimer();
            btnUndo.disabled = true;

            // Center board
            setTimeout(() => {
                const scrollContainer = document.getElementById('main-scroll');
                const boardHeight = boardEl.offsetHeight;
                const containerHeight = scrollContainer.clientHeight;
                
                // Smooth scroll for better experience
                scrollContainer.scrollTo({
                    top: (boardHeight - containerHeight) / 2 + 50, // +50 because header covers a bit
                    left: (boardEl.offsetWidth - scrollContainer.clientWidth) / 2,
                    behavior: 'smooth'
                });
            }, 300);
        }

        function renderBoard() {
            boardEl.innerHTML = '';
            // Use DocumentFragment for optimized rendering performance
            const fragment = document.createDocumentFragment();
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    // Add click ripple effect at mouse coordinates
                    cell.onmousedown = (e) => createRipple(e, cell);
                    cell.onclick = () => handleCellClick(r, c);
                    fragment.appendChild(cell);
                }
            }
            boardEl.appendChild(fragment);
        }

        // Ripple effect
        function createRipple(event, element) {
            if(element.children.length > 0) return; // Already has a piece, no ripple
            
            const circle = document.createElement("span");
            const diameter = Math.max(element.clientWidth, element.clientHeight);
            const radius = diameter / 2;

            // Get click position relative to the cell
            const rect = element.getBoundingClientRect();
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - rect.left}px`;
            circle.style.top = `${event.clientY - rect.top}px`;
            circle.classList.add("ripple-effect");

            element.appendChild(circle);
            setTimeout(() => circle.remove(), 400);
        }

        // --- GAME LOGIC ---

        function handleCellClick(r, c) {
            if (!gameActive || board[r][c]) return;

            makeMove(r, c, currentPlayer);

            if (gameActive && mode === 'pve' && currentPlayer === 'o') {
                boardEl.style.pointerEvents = 'none';
                statusTextEl.innerText = 'Text2-Bot is thinking...';
                statusTextEl.classList.add('animate-pulse');
                
                setTimeout(() => {
                    makeAiMove();
                    boardEl.style.pointerEvents = 'auto';
                    statusTextEl.classList.remove('animate-pulse');
                }, 600); // Delay to feel natural
            }
        }

        function makeMove(r, c, player) {
            board[r][c] = player;
            history.push({r, c, player});
            btnUndo.disabled = false;
            
            // Sound / Vibration
            if (soundEnabled) {
                playSound(player === 'x' ? 'pop' : 'click');
                if(navigator.vibrate) navigator.vibrate(15); 
            }

            // UI Update
            const cellIndex = r * COLS + c;
            const cell = boardEl.children[cellIndex];
            
            const iconClass = player === 'x' ? 'fa-xmark' : 'fa-circle'; 
            // Note: O uses fa-circle (solid or regular) but here we use font awesome icon
            // X: fa-xmark, O: fa-circle (but we'll style css separately for beauty)
            
            const content = player === 'x' 
                ? `<i class="fa-solid fa-xmark mark-animated"></i>`
                : `<i class="fa-regular fa-circle mark-animated" style="font-weight:900"></i>`;
            
            cell.innerHTML = content;
            cell.classList.add(player === 'x' ? 'cell-x' : 'cell-o');

            // Remove old last-move
            const prevLastMove = document.querySelector('.last-move');
            if (prevLastMove) prevLastMove.classList.remove('last-move');
            cell.classList.add('last-move');

            // Check Win
            const winInfo = checkWin(r, c, player);
            if (winInfo) {
                endGame(player, winInfo);
                return;
            }

            currentPlayer = player === 'x' ? 'o' : 'x';
            updateUI();
        }

        function updateUI() {
            if (!gameActive) return;
            
            const isX = currentPlayer === 'x';
            if (mode === 'pve') {
                statusTextEl.innerText = isX ? 'Your Turn' : 'Text2-Bot';
            } else {
                statusTextEl.innerText = isX ? 'Player X' : 'Player O';
            }

            // Update Indicator Icon & Shadow Color
            turnIndicatorEl.innerHTML = isX 
                ? '<i class="fa-solid fa-xmark"></i>' 
                : '<i class="fa-regular fa-circle"></i>';
            
            turnIndicatorEl.className = `w-11 h-11 rounded-2xl flex items-center justify-center text-xl font-bold transition-all duration-300 border border-white shadow-lg ${
                isX 
                ? 'bg-red-50 text-red-500 shadow-red-100' 
                : 'bg-blue-50 text-blue-600 shadow-blue-100'
            }`;
        }

        function undoMove() {
            if (history.length === 0 || !gameActive) return;
            const steps = mode === 'pve' ? 2 : 1;

            for(let i=0; i<steps; i++) {
                if(history.length === 0) break;
                const lastMove = history.pop();
                board[lastMove.r][lastMove.c] = null;
                
                const cellIndex = lastMove.r * COLS + lastMove.c;
                const cell = boardEl.children[cellIndex];
                
                // Fade out effect when undoing
                cell.style.transform = 'scale(0)';
                cell.style.opacity = '0';
                setTimeout(() => {
                    cell.innerHTML = '';
                    cell.className = 'cell'; 
                    cell.style.transform = '';
                    cell.style.opacity = '';
                }, 200);
                
                currentPlayer = lastMove.player;
            }
            
            // Reset last move indicator
            const prevLastMove = document.querySelector('.last-move');
            if (prevLastMove) prevLastMove.classList.remove('last-move');
            
            if (history.length > 0) {
                const last = history[history.length - 1];
                const cellIndex = last.r * COLS + last.c;
                boardEl.children[cellIndex].classList.add('last-move');
            } else {
                btnUndo.disabled = true;
            }

            updateUI();
            gameActive = true;
        }

        // --- WIN LOGIC (Keep original) ---
        function checkWin(r, c, player) {
            const directions = [[0, 1], [1, 0], [1, 1], [1, -1]];
            for (let [dr, dc] of directions) {
                let count = 1;
                let winCells = [{r, c}];

                for (let i = 1; i < WIN_COUNT; i++) {
                    const nr = r + dr * i;
                    const nc = c + dc * i;
                    if (isValid(nr, nc) && board[nr][nc] === player) {
                        count++;
                        winCells.push({r: nr, c: nc});
                    } else break;
                }

                for (let i = 1; i < WIN_COUNT; i++) {
                    const nr = r - dr * i;
                    const nc = c - dc * i;
                    if (isValid(nr, nc) && board[nr][nc] === player) {
                        count++;
                        winCells.push({r: nr, c: nc});
                    } else break;
                }
                if (count >= WIN_COUNT) return winCells;
            }
            return null;
        }

        function isValid(r, c) {
            return r >= 0 && r < ROWS && c >= 0 && c < COLS;
        }

        function endGame(winner, winCells) {
            gameActive = false;
            stopTimer();

            // Highlight Cells
            winCells.forEach((pos, index) => {
                const idx = pos.r * COLS + pos.c;
                // Delay animation for each cell for beauty
                setTimeout(() => {
                    boardEl.children[idx].classList.add('winning-cell');
                }, index * 100);
            });

            if (soundEnabled && navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);

            setTimeout(() => {
                modalEl.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modalEl.classList.remove('opacity-0');
                    modalContentEl.classList.remove('scale-90');
                    modalContentEl.classList.add('scale-100');
                });
                
                const winnerName = mode === 'pve' 
                    ? (winner === 'x' ? 'You Win!' : 'Text2-Bot Wins!') 
                    : (winner === 'x' ? 'Player X Wins!' : 'Player O Wins!');
                
                document.getElementById('winner-title').innerText = "Victory!";
                document.getElementById('winner-message').innerText = `${winnerName}\nTime: ${formatTime(timeSeconds)}`;
            }, 1200);
        }

        // --- AI LOGIC (Keep original) ---
        function makeAiMove() {
            if (!gameActive) return;
            let move = null;
            if (aiDifficulty === 'easy') {
                if (Math.random() < 0.3) {
                    const empties = [];
                    for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(!board[r][c]) empties.push({r, c});
                    if(empties.length > 0) move = empties[Math.floor(Math.random() * empties.length)];
                }
            }
            if (!move) move = getBestMove();
            if (move) makeMove(move.r, move.c, 'o');
        }

        function getBestMove() {
            let maxScore = -Infinity;
            let bestMoves = [];
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (board[r][c] === null) {
                        const attackScore = evaluatePoint(r, c, 'o', 'x');
                        const defenseScore = evaluatePoint(r, c, 'x', 'o');
                        let currentScore = Math.max(attackScore, defenseScore);
                        if (attackScore >= 10000) currentScore = attackScore * 1.1;

                        if (currentScore > maxScore) {
                            maxScore = currentScore;
                            bestMoves = [{r, c}];
                        } else if (currentScore === maxScore) {
                            bestMoves.push({r, c});
                        }
                    }
                }
            }
            if (bestMoves.length === 0 || maxScore === 0) {
                const center = Math.floor(ROWS/2);
                if (!board[center][center]) return {r: center, c: center};
                for(let r=0; r<ROWS; r++) for(let c=0; c<COLS; c++) if(!board[r][c]) return {r, c};
            }
            return bestMoves[Math.floor(Math.random() * bestMoves.length)];
        }

        function evaluatePoint(r, c, player, opponent) {
            const directions = [[0, 1], [1, 0], [1, 1], [1, -1]];
            let totalScore = 0;
            for (let [dr, dc] of directions) {
                let count = 0, block = 0;
                // Check forward
                for (let i = 1; i < 5; i++) {
                    const nr = r + dr * i, nc = c + dc * i;
                    if (!isValid(nr, nc)) { block++; break; }
                    if (board[nr][nc] === player) count++;
                    else if (board[nr][nc] === opponent) { block++; break; }
                    else break;
                }
                // Check backward
                for (let i = 1; i < 5; i++) {
                    const nr = r - dr * i, nc = c - dc * i;
                    if (!isValid(nr, nc)) { block++; break; }
                    if (board[nr][nc] === player) count++;
                    else if (board[nr][nc] === opponent) { block++; break; }
                    else break;
                }
                if (count >= 4) totalScore += 100000;
                else if (count === 3 && block === 0) totalScore += 10000;
                else if (count === 3 && block === 1) totalScore += 1000;
                else if (count === 2 && block === 0) totalScore += 500;
                else if (count === 2 && block === 1) totalScore += 100;
                else if (count === 1 && block === 0) totalScore += 10;
            }
            return totalScore;
        }

        // --- UI UTILS ---
        
        // Simple sound simulation using frequency (Simple Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if(type === 'pop') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'click') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
            }
        }

        function resetGame() {
            initGame();
        }

        function closeModalAndReset() {
            modalContentEl.classList.remove('scale-100');
            modalContentEl.classList.add('scale-90');
            modalEl.classList.add('opacity-0');
            setTimeout(() => {
                modalEl.classList.add('hidden');
                resetGame();
            }, 300);
        }

        function toggleSettings() {
            const isHidden = settingsModalEl.classList.contains('hidden');
            if (isHidden) {
                settingsModalEl.classList.remove('hidden');
                // Trigger reflow
                void settingsModalEl.offsetWidth;
                settingsModalEl.classList.remove('opacity-0');
                settingsPanelEl.classList.remove('translate-y-full', 'sm:scale-95', 'opacity-0');
                settingsPanelEl.classList.add('sm:scale-100');
            } else {
                settingsModalEl.classList.add('opacity-0');
                settingsPanelEl.classList.add('translate-y-full', 'sm:scale-95', 'opacity-0');
                settingsPanelEl.classList.remove('sm:scale-100');
                setTimeout(() => {
                    settingsModalEl.classList.add('hidden');
                }, 300);
            }
        }

        function toggleMode() {
            mode = mode === 'pve' ? 'pvp' : 'pve';
            if (mode === 'pve') {
                modeIcon.className = 'fa-solid fa-robot text-lg mb-0.5';
                modeMiniText.innerText = 'Text2-Bot';
                document.querySelector('#btn-mode div').className = 'absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]';
            } else {
                modeIcon.className = 'fa-solid fa-user-group text-lg mb-0.5';
                modeMiniText.innerText = '2P';
                document.querySelector('#btn-mode div').className = 'absolute top-2 right-2 w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.6)]';
            }
            resetGame();
        }

        function setDifficulty(diff) {
            aiDifficulty = diff;
            document.getElementById('diff-easy').className = diff === 'easy' 
                ? 'py-3 rounded-xl text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all' 
                : 'py-3 rounded-xl text-sm font-bold text-slate-500 transition-all';
            
            document.getElementById('diff-hard').className = diff === 'hard' 
                ? 'py-3 rounded-xl text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all' 
                : 'py-3 rounded-xl text-sm font-bold text-slate-500 transition-all';
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeSeconds++;
                timerEl.innerText = formatTime(timeSeconds);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        window.onload = initGame;

    </script>
</body>
</html>

