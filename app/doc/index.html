<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vibe Docs ‚Äî Tr√¨nh so·∫°n th·∫£o m·ªôt file (inline)</title>
<style>
  :root{
    --bg:#0b0c10; /* dark canvas preview friendly */
    --panel:#111218;
    --muted:#1a1b22;
    --accent:#7c5cff;
    --text:#e8e8ef;
    --text-dim:#b9b9c9;
    --ok:#24c8a5; --warn:#ffc857; --danger:#ff5d7a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0c10,#0e1017);color:var(--text);font:14px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100%}
  /* Topbar */
  .topbar{display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;background:rgba(255,255,255,.03);backdrop-filter:saturate(160%) blur(6px);position:sticky;top:0;z-index:50;border-bottom:1px solid rgba(255,255,255,.06)}
  .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
  .brand .dot{width:.7rem;height:.7rem;border-radius:50%;background:conic-gradient(from 210deg,var(--accent),#1ad1a5,#59a0ff)}
  .spacer{flex:1}
  .btn,select,input[type="color"]{appearance:none;border:1px solid rgba(255,255,255,.08);background:var(--panel);color:var(--text);padding:.45rem .6rem;border-radius:.7rem;cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;transition:.2s all}
  .btn:hover{background:var(--muted)}
  .btn[aria-pressed="true"]{outline:2px solid var(--accent)}
  .group{display:flex;gap:.4rem;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);padding:.35rem;border-radius:.9rem}
  .vsep{width:1px;height:28px;background:rgba(255,255,255,.08);margin:0 .25rem}
  .name{min-width:12ch;border:none;padding:.45rem .6rem;border-radius:.7rem;background:rgba(255,255,255,.06);color:var(--text)}

  /* Layout */
  .main{display:grid;grid-template-columns:280px 1fr 300px;gap:.8rem;padding:.8rem}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);border-radius:1rem;overflow:hidden}
  .panel h3{margin:0;padding:.7rem .9rem;border-bottom:1px dashed rgba(255,255,255,.06);color:var(--text-dim)}
  .panel .body{padding:.8rem}

  /* Sidebar (TOC & Comments) */
  #toc ol{padding-left:1rem}
  #comments{max-height:45vh;overflow:auto;display:flex;flex-direction:column;gap:.6rem}
  .comment{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:.6rem;border-radius:.7rem}
  .comment .meta{font-size:.8rem;color:var(--text-dim)}

  /* Editor */
  .editor-wrap{display:flex;flex-direction:column;gap:.6rem;height:calc(100vh - 140px)}
  .ribbon{display:flex;flex-wrap:wrap;gap:.4rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);padding:.45rem;border-radius:1rem;position:sticky;top:.8rem;z-index:10}
  #editor{flex:1;overflow:auto;background:#fff;color:#1a1a1a;border-radius:1rem;padding:2.2cm 2cm;box-shadow:0 10px 30px rgba(0,0,0,.35);outline:none}
  #editor[contenteditable="true"]{caret-color:#333}
  #editor:empty:before{content:"B·∫Øt ƒë·∫ßu g√µ n·ªôi dung ·ªü ƒë√¢y...";color:#9aa1aa}
  .page{max-width:21cm;margin:0 auto}
  #editor{zoom:var(--zoom,1)}

  /* Formatting markers */
  .ins{background:rgba(36,200,165,.18);}
  .del{text-decoration:line-through;background:rgba(255,93,122,.18)}
  .hl{background:#fff39a}
  .cm-highlight{background:#ffef9f}

  /* Print */
  @media print{
    body{background:white}
    .topbar,.main .panel:first-child,.main .panel:last-child,.ribbon{display:none!important}
    #editor{box-shadow:none;padding:2cm 2cm}
    @page{size:auto;margin:2cm}
    header.print-header, footer.print-footer{position:fixed;left:0;right:0;color:#555}
    header.print-header{top:0}
    footer.print-footer{bottom:0}
    footer.print-footer .pageno:after{content: counter(page)}
  }

  /* Modals */
  dialog{border:none;border-radius:1rem;background:var(--panel);color:var(--text);padding:0;box-shadow:0 12px 40px rgba(0,0,0,.45)}
  dialog .dlg-header{padding:.8rem .9rem;border-bottom:1px solid rgba(255,255,255,.08);font-weight:600}
  dialog .dlg-body{padding:.9rem}
  dialog form{display:grid;gap:.6rem}
  dialog .actions{display:flex;justify-content:flex-end;gap:.5rem;padding:.7rem .9rem;border-top:1px solid rgba(255,255,255,.08)}
  .input, textarea{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:.55rem .6rem;border-radius:.6rem;color:var(--text)}
  textarea{min-height:120px}

  /* Toolbar improvements */
  .btn .label{display:inline}
  .btn .only-icon{display:none}
  .ribbon{overflow:auto}
  .ribbon .group{flex-wrap:wrap}
  .ribbon .tabbar{display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.3rem}
  .tab-btn{appearance:none;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:var(--text);padding:.35rem .6rem;border-radius:.6rem;cursor:pointer}
  .tab-btn[aria-selected="true"]{background:rgba(255,255,255,.08);outline:2px solid rgba(124,92,255,.35)}
  .ribbon .section{display:none;gap:.4rem;flex-wrap:wrap}
  .ribbon .section.active{display:flex}
  .mobile-only{display:none}
  .statusbar{display:flex;gap:.8rem;align-items:center;justify-content:space-between;color:var(--text-dim);background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);padding:.45rem .7rem;border-radius:.7rem;margin-top:.4rem}
  .statusbar .meter{display:flex;align-items:center;gap:.5rem}
  .statusbar input[type="range"]{width:140px}
  .statusbar .sep{width:1px;height:18px;background:rgba(255,255,255,.12)}

  /* Compact layout for small screens */
  @media (max-width: 900px){
    .main{grid-template-columns:1fr}
    .main .panel:first-child, .main .panel:last-child{display:none}
    .mobile-only{display:flex}
    .ribbon .tabbar{display:none}
    .btn .label{display:none}
    .btn .only-icon{display:inline}
    .ribbon{position:sticky;top:3.1rem}
  }

  /* Password overlay */
  .locked #editor{filter:blur(5px) grayscale(.3);pointer-events:none}
  .lock-banner{display:none}
  .locked .lock-banner{display:flex;gap:.6rem;align-items:center;justify-content:center;padding:.7rem;border:1px dashed rgba(255,255,255,.18);border-radius:.8rem}

  .hint{color:var(--text-dim);font-size:.85rem}
  .tag{display:inline-flex;align-items:center;gap:.35rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.09);padding:.15rem .45rem;border-radius:999px;font-size:.78rem;color:var(--text-dim)}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand"><span class="dot"></span> Vibe Docs</div>
    <input class="name" id="filename" value="Untitled" />
    <div class="group" role="group" aria-label="File">
      <button class="btn" id="newBtn" title="T·∫°o t√†i li·ªáu m·ªõi (Ctrl+N)">M·ªõi</button>
      <button class="btn" id="openBtn" title="M·ªü (Ctrl+O)">M·ªü</button>
      <input type="file" id="fileOpen" hidden accept=".txt,.html,.htm,.json,.md,.rtf,.doc,.docx,.odt" />
      <button class="btn" id="saveBtn" title="L∆∞u (Ctrl+S)">L∆∞u</button>
      <button class="btn" id="saveAsBtn" title="L∆∞u th√†nh...">L∆∞u th√†nh...</button>
      <div class="vsep"></div>
      <button class="btn" id="exportPDF">Xu·∫•t PDF</button>
      <button class="btn" id="printBtn">In / Xem tr∆∞·ªõc</button>
    </div>
    <div class="group" role="group" aria-label="Protect">
      <button class="btn" id="lockBtn" title="B·∫£o v·ªá m·∫≠t kh·∫©u">üîí Kho√°</button>
    </div>
    <div class="spacer"></div>
    <div class="group" role="group" aria-label="Collab">
      <span class="tag" id="liveStatus">Live: off</span>
      <button class="btn" id="shareTab">B·∫≠t c·ªông t√°c (tab kh√°c)</button>
    </div>
  </div>

  <div class="main">
    <!-- Left panel: TOC & Find/Replace -->
    <aside class="panel">
      <h3>M·ª•c l·ª•c</h3>
      <div class="body" id="toc"></div>
      <h3>T√¨m & Thay th·∫ø</h3>
      <div class="body">
        <input id="findText" class="input" placeholder="T√¨m... (Ctrl+F)" />
        <input id="replaceText" class="input" placeholder="Thay b·∫±ng... (Ctrl+H)" />
        <div style="display:flex; gap:.4rem; margin-top:.4rem">
          <button class="btn" id="findNext">T√¨m ti·∫øp</button>
          <button class="btn" id="replaceOne">Thay 1</button>
          <button class="btn" id="replaceAll">Thay t·∫•t c·∫£</button>
        </div>
        <div class="hint" style="margin-top:.5rem">Ch·∫ø ƒë·ªô ki·ªÉm tra ch√≠nh t·∫£ c·ªßa tr√¨nh duy·ªát ƒë√£ b·∫≠t.</div>
      </div>
    </aside>

    <!-- Editor center -->
    <section class="panel">
      <div class="body editor-wrap">
        <div class="lock-banner" id="lockBanner">
          <span>üîí T√†i li·ªáu ƒëang ƒë∆∞·ª£c b·∫£o v·ªá. Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kho√°.</span>
          <button class="btn" id="unlockBtn">Nh·∫≠p m·∫≠t kh·∫©u</button>
        </div>
        <div class="ribbon" id="ribbon">
          <div class="tabbar" role="tablist">
            <button class="tab-btn" role="tab" id="tab-home" aria-selected="true" aria-controls="sec-home">Trang ch·ªß</button>
            <button class="tab-btn" role="tab" id="tab-insert" aria-selected="false" aria-controls="sec-insert">Ch√®n</button>
            <button class="tab-btn" role="tab" id="tab-review" aria-selected="false" aria-controls="sec-review">Xem l·∫°i</button>
            <button class="tab-btn" role="tab" id="tab-view" aria-selected="false" aria-controls="sec-view">Xem</button>
          </div>

          <div class="section active" id="sec-home" role="tabpanel" aria-labelledby="tab-home">
            <div class="group">
              <select id="blockFormat" title="Ki·ªÉu ƒëo·∫°n">
                <option value="P">ƒêo·∫°n vƒÉn</option>
                <option value="H1">Ti√™u ƒë·ªÅ 1</option>
                <option value="H2">Ti√™u ƒë·ªÅ 2</option>
                <option value="H3">Ti√™u ƒë·ªÅ 3</option>
                <option value="BLOCKQUOTE">Tr√≠ch d·∫´n</option>
                <option value="PRE">M√£ (code)</option>
              </select>
              <button class="btn" id="clearFormat" title="Xo√° ƒë·ªãnh d·∫°ng"><span class="only-icon">‚®Ø</span><span class="label">Xo√° ƒë·ªãnh d·∫°ng</span></button>
            </div>
            <div class="group">
              <select id="fontName">
                <option value="">Font</option>
                <option>Arial</option>
                <option>Georgia</option>
                <option>Times New Roman</option>
                <option>Verdana</option>
                <option>Tahoma</option>
                <option>Courier New</option>
                <option>Inter</option>
              </select>
              <select id="fontSize">
                <option value="">C·ª°</option>
                <option value="1">10</option>
                <option value="2">13</option>
                <option value="3">16</option>
                <option value="4">18</option>
                <option value="5">24</option>
                <option value="6">32</option>
                <option value="7">48</option>
              </select>
              <input type="color" id="foreColor" title="M√†u ch·ªØ" />
              <input type="color" id="backColor" title="T√¥ n·ªÅn" />
            </div>
            <div class="group">
              <button class="btn" data-cmd="bold" title="ƒê·∫≠m (Ctrl+B)"><span class="only-icon"><b>B</b></span><span class="label">ƒê·∫≠m</span></button>
              <button class="btn" data-cmd="italic" title="Nghi√™ng (Ctrl+I)"><span class="only-icon"><i>I</i></span><span class="label">Nghi√™ng</span></button>
              <button class="btn" data-cmd="underline" title="G·∫°ch d∆∞·ªõi (Ctrl+U)"><span class="only-icon"><u>U</u></span><span class="label">G·∫°ch d∆∞·ªõi</span></button>
              <button class="btn" data-cmd="strikeThrough" title="G·∫°ch ngang"><span class="only-icon"><s>S</s></span><span class="label">G·∫°ch ngang</span></button>
            </div>
            <div class="group">
              <button class="btn" data-cmd="justifyLeft" title="CƒÉn tr√°i"><span class="only-icon">‚ü∏</span><span class="label">Tr√°i</span></button>
              <button class="btn" data-cmd="justifyCenter" title="CƒÉn gi·ªØa"><span class="only-icon">‚â°</span><span class="label">Gi·ªØa</span></button>
              <button class="btn" data-cmd="justifyRight" title="CƒÉn ph·∫£i"><span class="only-icon">‚üπ</span><span class="label">Ph·∫£i</span></button>
              <button class="btn" data-cmd="justifyFull" title="CƒÉn ƒë·ªÅu"><span class="only-icon">‚ò∞</span><span class="label">ƒê·ªÅu</span></button>
              <div class="vsep"></div>
              <button class="btn" data-cmd="insertUnorderedList" title="Danh s√°ch ch·∫•m"><span class="only-icon">‚Ä¢</span><span class="label">Danh s√°ch</span></button>
              <button class="btn" data-cmd="insertOrderedList" title="Danh s√°ch s·ªë"><span class="only-icon">1.</span><span class="label">ƒê√°nh s·ªë</span></button>
              <button class="btn" data-cmd="outdent" title="Th·ª•t l√πi"><span class="only-icon">‚á§</span><span class="label">L√πi</span></button>
              <button class="btn" data-cmd="indent" title="Th·ª•t v√†o"><span class="only-icon">‚á•</span><span class="label">Th·ª•t</span></button>
              <select id="lineHeight">
                <option value="">Gi√£n d√≤ng</option>
                <option value="1.15">1.15</option>
                <option value="1.5">1.5</option>
                <option value="2">2.0</option>
                <option value="2.5">2.5</option>
              </select>
            </div>
            <div class="group">
              <button class="btn" id="undoBtn" title="Ho√†n t√°c (Ctrl+Z)"><span class="only-icon">‚Ü∂</span><span class="label">Ho√†n t√°c</span></button>
              <button class="btn" id="redoBtn" title="L√†m l·∫°i (Ctrl+Y)"><span class="only-icon">‚Ü∑</span><span class="label">L√†m l·∫°i</span></button>
            </div>
          </div>

          <div class="section" id="sec-insert" role="tabpanel" aria-labelledby="tab-insert">
            <div class="group">
              <button class="btn" id="insertLink" title="Ch√®n li√™n k·∫øt"><span class="only-icon">üîó</span><span class="label">Li√™n k·∫øt</span></button>
              <button class="btn" id="insertImage" title="Ch√®n ·∫£nh"><span class="only-icon">üñºÔ∏è</span><span class="label">H√¨nh ·∫£nh</span></button>
              <button class="btn" id="insertTable" title="Ch√®n b·∫£ng"><span class="only-icon">‚ñ¶</span><span class="label">B·∫£ng</span></button>
              <button class="btn" id="insertChart" title="Ch√®n bi·ªÉu ƒë·ªì"><span class="only-icon">üìä</span><span class="label">Bi·ªÉu ƒë·ªì</span></button>
              <button class="btn" id="specialChar" title="K√Ω hi·ªáu ƒë·∫∑c bi·ªát"><span class="only-icon">Œ©</span><span class="label">K√Ω hi·ªáu</span></button>
            </div>
            <div class="group">
              <button class="btn" id="insertHeader" title="V√πng ƒë·∫ßu trang"><span class="only-icon">‚á°</span><span class="label">Header</span></button>
              <button class="btn" id="insertFooter" title="V√πng ch√¢n trang"><span class="only-icon">‚á£</span><span class="label">Footer</span></button>
              <button class="btn" id="insertPageNo" title="S·ªë trang"><span class="only-icon">#</span><span class="label">S·ªë trang</span></button>
            </div>
          </div>

          <div class="section" id="sec-review" role="tabpanel" aria-labelledby="tab-review">
            <div class="group">
              <button class="btn" id="toggleTrack" title="Theo d√µi thay ƒë·ªïi"><span class="only-icon">üìù</span><span class="label">Theo d√µi</span></button>
              <button class="btn" id="addComment" title="Th√™m b√¨nh lu·∫≠n"><span class="only-icon">üí¨</span><span class="label">B√¨nh lu·∫≠n</span></button>
              <button class="btn" id="acceptAll" title="Ch·∫•p nh·∫≠n t·∫•t c·∫£"><span class="only-icon">‚úî</span><span class="label">Ch·∫•p nh·∫≠n</span></button>
              <button class="btn" id="rejectAll" title="T·ª´ ch·ªëi t·∫•t c·∫£"><span class="only-icon">‚úñ</span><span class="label">T·ª´ ch·ªëi</span></button>
            </div>
          </div>

          <div class="section" id="sec-view" role="tabpanel" aria-labelledby="tab-view">
            <div class="group">
              <button class="btn" id="toggleSpell" title="B·∫≠t/t·∫Øt ki·ªÉm tra ch√≠nh t·∫£"><span class="only-icon">‚úîÔ∏é</span><span class="label">Ch√≠nh t·∫£</span></button>
              <button class="btn" id="toggleTOC" title="Hi·ªán/·∫©n m·ª•c l·ª•c"><span class="only-icon">‚ò∞</span><span class="label">M·ª•c l·ª•c</span></button>
              <button class="btn" id="toggleCommentsPanel" title="Hi·ªán/·∫©n b√¨nh lu·∫≠n"><span class="only-icon">üí¨</span><span class="label">B√¨nh lu·∫≠n</span></button>
            </div>
          </div>
        </div>

        <div class="page">
          <header class="print-header" contenteditable="true" data-placeholder="Header (in khi in)"></header>
          <main id="editor" contenteditable spellcheck="true"></main>
          <footer class="print-footer" contenteditable="true">
            <span>Trang </span><span class="pageno"></span>
          </footer>
        </div>
        <div class="statusbar" id="statusbar">
          <div class="meter">
            <span>üßÆ</span>
            <span id="wc">0 t·ª´</span>
            <span class="sep"></span>
            <span id="cc">0 k√Ω t·ª±</span>
          </div>
          <div class="meter">
            <label class="hint">Thu ph√≥ng</label>
            <input type="range" id="zoomRange" min="50" max="200" value="100" />
            <span id="zoomPct">100%</span>
            <span class="sep"></span>
            <span class="tag" id="saveState">ƒê√£ l∆∞u</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Right panel: Comments -->
    <aside class="panel">
      <h3>B√¨nh lu·∫≠n</h3>
      <div class="body" id="comments"></div>
      <h3>C√†i ƒë·∫∑t trang</h3>
      <div class="body">
        <label class="hint">Kh·ªï gi·∫•y</label>
        <select id="paper">
          <option value="A4">A4</option>
          <option value="Letter">Letter</option>
        </select>
        <label class="hint" style="margin-top:.4rem;display:block">H∆∞·ªõng</label>
        <select id="orientation">
          <option value="portrait">D·ªçc</option>
          <option value="landscape">Ngang</option>
        </select>
        <label class="hint" style="margin-top:.4rem;display:block">L·ªÅ (cm)</label>
        <input class="input" id="margins" value="2,2,2,2" />
      </div>
    </aside>
  </div>
</div>

<!-- Dialogs -->
<dialog id="dlgChart">
  <div class="dlg-header">Ch√®n bi·ªÉu ƒë·ªì (SVG, kh√¥ng c·∫ßn th∆∞ vi·ªán)</div>
  <div class="dlg-body">
    <form id="chartForm">
      <label>Ti√™u ƒë·ªÅ <input class="input" name="title" placeholder="Doanh thu Q1"/></label>
      <label>D·ªØ li·ªáu (m·ªói d√≤ng: nh√£n,gi√° tr·ªã)
        <textarea name="data" placeholder="Jan,10\nFeb,22\nMar,14"></textarea>
      </label>
    </form>
  </div>
  <div class="actions">
    <button class="btn" id="chartCancel">H·ªßy</button>
    <button class="btn" id="chartOk">Ch√®n</button>
  </div>
</dialog>

<dialog id="dlgPassword">
  <div class="dlg-header">M·∫≠t kh·∫©u t√†i li·ªáu</div>
  <div class="dlg-body">
    <form id="pwdForm">
      <label>ƒê·∫∑t / nh·∫≠p m·∫≠t kh·∫©u<input type="password" class="input" name="pwd"/></label>
      <div class="hint">Kho√° ch·ªâ che n·ªôi dung tr√™n thi·∫øt b·ªã n√†y. N·∫øu mu·ªën m√£ ho√° khi l∆∞u, ch·ªçn ‚ÄúL∆∞u (m√£ ho√°)‚Äù.</div>
    </form>
  </div>
  <div class="actions">
    <button class="btn" id="pwdCancel">H·ªßy</button>
    <button class="btn" id="pwdOk">OK</button>
  </div>
</dialog>

<dialog id="dlgSpecial">
  <div class="dlg-header">K√Ω hi·ªáu ƒë·∫∑c bi·ªát</div>
  <div class="dlg-body" id="specialGrid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:.4rem"></div>
  <div class="actions">
    <button class="btn" id="specClose">ƒê√≥ng</button>
  </div>
</dialog>

<script>
// --- Tiny helper ---
const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const editor = $('#editor');
const filename = $('#filename');
let trackOn=false; let currentPassword = null; let broadcast=null; let liveOn=false;

// --- File ops ---
function download(name, type, data){
  const blob = new Blob([data],{type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
}
function getHTML(){
  return `<!doctype html><meta charset="utf-8"><title>${filename.value}</title>` + document.getElementById('editor').innerHTML;
}
function getTXT(){
  const tmp = editor.cloneNode(true); tmp.querySelectorAll('style,script').forEach(n=>n.remove());
  return tmp.innerText;
}

$('#saveBtn').addEventListener('click',()=>{
  const name = filename.value || 'Untitled';
  download(name + '.html','text/html;charset=utf-8', getHTML());
});
$('#saveAsBtn').addEventListener('click',async()=>{
  const name = prompt('T√™n t·ªáp v√† ƒë·ªãnh d·∫°ng (vd: BaoCao.txt, BaiViet.html, GhiChu.json, BaoCao.md).\nL∆∞u √Ω: PDF d√πng n√∫t "Xu·∫•t PDF".');
  if(!name) return;
  const ext = name.split('.').pop().toLowerCase();
  if(ext==='txt') download(name,'text/plain;charset=utf-8', getTXT());
  else if(ext==='html' || ext==='htm') download(name,'text/html;charset=utf-8', getHTML());
  else if(ext==='json') download(name,'application/json', JSON.stringify({name:filename.value, html:getHTML()},null,2));
  else if(ext==='md') download(name,'text/markdown;charset=utf-8', getTXT());
  else if(ext==='doc' || ext==='rtf' || ext==='odt' || ext==='docx'){
    alert('Xu·∫•t tr·ª±c ti·∫øp DOCX/ODT/RTF trong file ƒë∆°n kh√¥ng th∆∞ vi·ªán l√† h·∫°n ch·∫ø. D√πng HTML/PDF ho·∫∑c m·ªü b·∫±ng Word t·ª´ HTML.');
    download(name.replace(/\.(docx|odt|rtf)$/,'')+'.doc','application/msword', getHTML());
  } else {
    alert('ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£ tr·ª±c ti·∫øp. ƒê√£ l∆∞u HTML.');
    download(name+'.html','text/html;charset=utf-8', getHTML());
  }
});
$('#openBtn').addEventListener('click',()=>$('#fileOpen').click());
$('#fileOpen').addEventListener('change',async (e)=>{
  const f=e.target.files[0]; if(!f) return; filename.value=f.name.replace(/\.[^.]+$/,'');
  const text = await f.text();
  if(/<\/?(html|body|p|div|h1|h2|h3|span)/i.test(text)) editor.innerHTML=text; else editor.innerText=text;
  buildTOC();
});
$('#newBtn').addEventListener('click',()=>{ if(confirm('Xo√° n·ªôi dung hi·ªán t·∫°i?')){ editor.innerHTML=''; filename.value='Untitled'; buildTOC(); }});

// PDF / Print
$('#exportPDF').addEventListener('click',()=>{ window.print(); });
$('#printBtn').addEventListener('click',()=>{ window.print(); });

// --- Formatting commands ---
function cmd(c,val=null){ document.execCommand(c,false,val); }
$$('[data-cmd]').forEach(b=>b.addEventListener('click',()=>cmd(b.dataset.cmd)));
$('#fontName').addEventListener('change',e=>cmd('fontName', e.target.value));
$('#fontSize').addEventListener('change',e=>cmd('fontSize', e.target.value));
$('#foreColor').addEventListener('input',e=>cmd('foreColor', e.target.value));
$('#backColor').addEventListener('input',e=>cmd('hiliteColor', e.target.value));
  $('#blockFormat').addEventListener('change',e=>{ const v=e.target.value; if(v){ cmd('formatBlock', v); e.target.value=''; } });
  $('#clearFormat').addEventListener('click',()=>{ cmd('removeFormat'); });
$('#undoBtn').addEventListener('click',()=>cmd('undo'));
$('#redoBtn').addEventListener('click',()=>cmd('redo'));
$('#lineHeight').addEventListener('change',e=>{
  document.getSelection().getRangeAt(0).surroundContents(Object.assign(document.createElement('span'),{style:`line-height:${e.target.value}` }));
});

  // Tabs: Home, Insert, Review, View
  const tabs = $$('.tab-btn');
  const sections = $$('.ribbon .section');
  function activateTab(id){
    tabs.forEach(t=> t.setAttribute('aria-selected', String(t.id===id)) );
    sections.forEach(s=> s.classList.toggle('active', 'sec-'+id.split('-')[1]===s.id));
  }
  tabs.forEach(t=> t.addEventListener('click',()=> activateTab(t.id)) );

// Insertions
$('#insertLink').addEventListener('click',()=>{
  const url = prompt('URL'); if(url) cmd('createLink', url);
});
$('#insertImage').addEventListener('click',()=>{
  const url = prompt('URL ·∫£nh (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ ch·ªçn file)');
  if(url){ cmd('insertImage', url); return; }
  const input = Object.assign(document.createElement('input'),{type:'file',accept:'image/*'});
  input.onchange = async ()=>{
    const f=input.files[0]; if(!f) return; const data = await f.arrayBuffer();
    const blob = new Blob([data],{type:f.type}); const url = URL.createObjectURL(blob);
    cmd('insertImage', url); setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }; input.click();
});
$('#insertTable').addEventListener('click',()=>{
  const r = parseInt(prompt('S·ªë h√†ng?', '3')||'0',10);
  const c = parseInt(prompt('S·ªë c·ªôt?', '3')||'0',10);
  if(r>0 && c>0){
    let html = '<table border="1" style="border-collapse:collapse;width:100%">';
    for(let i=0;i<r;i++){ html+='<tr>'; for(let j=0;j<c;j++){ html+='<td style="padding:.3rem">¬†</td>'; } html+='</tr>'; }
    html+='</table>';
    cmd('insertHTML', html);
  }
});

// Chart dialog
const dlgChart = $('#dlgChart');
$('#insertChart').addEventListener('click',()=>dlgChart.showModal());
$('#chartCancel').addEventListener('click',()=>dlgChart.close());
$('#chartOk').addEventListener('click',()=>{
  const fd = new FormData($('#chartForm'));
  const title = fd.get('title')||'';
  const lines = String(fd.get('data')||'').trim().split(/\n+/).map(l=>l.split(',')).filter(a=>a.length>=2);
  if(!lines.length){ alert('Nh·∫≠p d·ªØ li·ªáu tr∆∞·ªõc'); return; }
  const max = Math.max(...lines.map(a=>+a[1]||0));
  const width=500, height=260, pad=30;
  const bars = lines.map((a,i)=>{
    const x = pad + i*((width-pad*2)/lines.length);
    const bw = (width-pad*2)/lines.length - 8;
    const h = ( (+a[1]||0) / (max||1) ) * (height-pad*2);
    const y = height - pad - h;
    return `<rect x="${x}" y="${y}" width="${bw}" height="${h}" rx="6" />\n<text x="${x+bw/2}" y="${height-pad+14}" text-anchor="middle" font-size="12">${a[0]}</text>`
  }).join('\n');
  const svg = `<figure class="chart"><figcaption style="text-align:center;font-weight:700">${title}</figcaption>
  <svg viewBox="0 0 ${width} ${height}" style="width:100%"><g fill="currentColor">${bars}</g>
  <line x1="${pad}" y1="${height-pad}" x2="${width-pad}" y2="${height-pad}" stroke="currentColor"/></svg></figure>`;
  cmd('insertHTML', svg); dlgChart.close();
});

// Special characters
const specials = ['¬©','¬Æ','‚Ñ¢','‚úì','‚Üí','‚Üê','‚Üë','‚Üì','‚Äî','‚Äì','¬∑','‚Ä¢','¬ß','¬∂','‚Ç¨','‚Ç´','‚Ç©','¬•','¬£','¬±','‚àû','‚â§','‚â•','‚âà','‚â†','‚àö','‚àë','œÄ','¬µ','Œ©','¬∞','¬º','¬Ω','¬æ','‚ÅÑ'];
const grid = $('#specialGrid');
function buildSpecials(){ grid.innerHTML=''; specials.forEach(ch=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=ch; b.onclick=()=>{ cmd('insertText', ch); }; grid.appendChild(b); }); }
$('#specialChar').addEventListener('click',()=>{ buildSpecials(); $('#dlgSpecial').showModal(); });
$('#specClose').addEventListener('click',()=>$('#dlgSpecial').close());

// Header/Footer/Page number (simple placeholders)
$('#insertHeader').addEventListener('click',()=>{ document.querySelector('header.print-header').focus(); });
$('#insertFooter').addEventListener('click',()=>{ document.querySelector('footer.print-footer').focus(); });
$('#insertPageNo').addEventListener('click',()=>{ cmd('insertText','[Trang #]'); });

// Find & Replace
let lastFind = '';
function findNext(){
  const needle = $('#findText').value; if(!needle) return;
  const sel = window.getSelection(); const range = sel.rangeCount? sel.getRangeAt(0): document.createRange();
  const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null);
  let node; let startFound=false;
  if(range.startContainer) startFound=true; // naive
  while(node = walker.nextNode()){
    const idx = node.data.toLowerCase().indexOf(needle.toLowerCase());
    if(idx>-1){ const r = document.createRange(); r.setStart(node, idx); r.setEnd(node, idx+needle.length); sel.removeAllRanges(); sel.addRange(r); editor.focus(); lastFind=needle; return true; }
  }
  return false;
}
$('#findNext').addEventListener('click',findNext);
$('#replaceOne').addEventListener('click',()=>{
  if(!window.getSelection().rangeCount){ findNext(); }
  document.execCommand('insertText', false, $('#replaceText').value||'');
});
$('#replaceAll').addEventListener('click',()=>{
  const n = $('#findText').value; const r=$('#replaceText').value;
  if(!n) return;
  editor.innerHTML = editor.innerHTML.replace(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'), r);
});

// Track changes (very simplified)
function wrapSelection(cls){
  const sel = window.getSelection(); if(!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const span = document.createElement('span'); span.className=cls; span.setAttribute('data-author','B·∫°n');
  range.surroundContents(span);
}
$('#toggleTrack').addEventListener('click', (e)=>{
  trackOn=!trackOn; e.target.setAttribute('aria-pressed', String(trackOn));
});
editor.addEventListener('beforeinput', (ev)=>{
  if(!trackOn) return;
  if(ev.inputType.startsWith('insert')){
    // After default insertion, we will highlight; delay slightly
    setTimeout(()=>{ try{ wrapSelection('ins'); }catch{} }, 0);
  }
  if(ev.inputType.startsWith('delete')){
    ev.preventDefault();
    const sel = window.getSelection(); if(!sel.rangeCount) return; const r=sel.getRangeAt(0);
    if(r.collapsed && r.startContainer.nodeType===Node.TEXT_NODE){
      const span=document.createElement('span'); span.className='del'; span.textContent=r.startContainer.textContent.slice(r.startOffset-1,r.startOffset);
      r.setStart(r.startContainer, r.startOffset-1); r.deleteContents(); r.insertNode(span); sel.removeAllRanges();
    } else { const frag=r.cloneContents(); const span=document.createElement('span'); span.className='del'; span.append(frag); r.deleteContents(); r.insertNode(span); }
  }
});
$('#acceptAll').addEventListener('click',()=>{
  editor.querySelectorAll('.ins').forEach(n=>{ n.replaceWith(...n.childNodes); });
  editor.querySelectorAll('.del').forEach(n=> n.remove());
});
$('#rejectAll').addEventListener('click',()=>{
  editor.querySelectorAll('.ins').forEach(n=> n.remove());
  editor.querySelectorAll('.del').forEach(n=>{ n.replaceWith(...n.childNodes); });
});

// Comments
let cmId=0;
$('#addComment').addEventListener('click',()=>{
  const sel = window.getSelection(); if(!sel.rangeCount){ alert('Ch·ªçn ƒëo·∫°n ƒë·ªÉ b√¨nh lu·∫≠n'); return; }
  const txt = prompt('N·ªôi dung b√¨nh lu·∫≠n?'); if(!txt) return;
  const r = sel.getRangeAt(0); const mark = document.createElement('mark'); mark.className='cm-highlight'; r.surroundContents(mark);
  const id = 'c'+(++cmId); mark.dataset.cm=id;
  const div = document.createElement('div'); div.className='comment'; div.id=id;
  div.innerHTML = `<div class="meta">#${cmId} ‚Äî ${new Date().toLocaleString()}</div><div>${txt}</div>`;
  $('#comments').appendChild(div);
});

// Auto TOC
function buildTOC(){
  const heads = Array.from(editor.querySelectorAll('h1,h2,h3'));
  const ol = document.createElement('ol');
  heads.forEach((h,i)=>{ const id=h.id || (h.id='h'+i); const li=document.createElement('li'); const a=document.createElement('a'); a.href='#'+id; a.textContent=h.textContent; li.appendChild(a); ol.appendChild(li); });
  const t = $('#toc'); t.innerHTML=''; t.appendChild(ol);
}
const tocObs = new MutationObserver(()=>buildTOC()); tocObs.observe(editor,{subtree:true,childList:true,characterData:true});

// Page settings
function applyPage(){
  const size = $('#paper').value==='Letter'?'8.5in 11in':'210mm 297mm';
  const ori = $('#orientation').value; const [t,r,b,l] = $('#margins').value.split(',').map(x=>x.trim()+ (x.includes('cm')||x.includes('in')?'':'cm'));
  const styleId='pageStyle'; let st=document.getElementById(styleId); if(!st){ st=document.createElement('style'); st.id=styleId; document.head.appendChild(st);} 
  st.textContent = `@page{size:${ori} ${size}; margin:${t} ${r} ${b} ${l}} #editor{padding:${t} ${r} ${b} ${l}}`;
}
['paper','orientation','margins'].forEach(id=>$("#"+id).addEventListener('change',applyPage));
applyPage();

// Password protect (visual lock)
function setLocked(locked){ document.body.classList.toggle('locked', locked); }
$('#lockBtn').addEventListener('click',()=>{ $('#dlgPassword').showModal(); });
$('#pwdCancel').addEventListener('click',()=>$('#dlgPassword').close());
$('#pwdOk').addEventListener('click',()=>{
  const pwd = new FormData($('#pwdForm')).get('pwd'); if(!pwd) return $('#dlgPassword').close();
  currentPassword = pwd; setLocked(true); $('#lockBanner').style.display='flex'; $('#dlgPassword').close();
});
$('#unlockBtn').addEventListener('click',()=>{
  const pwd = prompt('Nh·∫≠p m·∫≠t kh·∫©u:'); if(pwd===currentPassword){ setLocked(false); $('#lockBanner').style.display='none'; } else alert('Sai m·∫≠t kh·∫©u');
});

// Collaboration: BroadcastChannel (same origin, ƒëa tab)
$('#shareTab').addEventListener('click',()=>{
  if(liveOn) return; broadcast = new BroadcastChannel('vibe-doc'); liveOn=true; $('#liveStatus').textContent='Live: on';
  broadcast.onmessage = (ev)=>{ if(ev.data.type==='content' && document.activeElement!==editor){ editor.innerHTML=ev.data.html; buildTOC(); }
    if(ev.data.type==='name'){ filename.value=ev.data.value; }
  };
  editor.addEventListener('input',()=> broadcast.postMessage({type:'content', html:editor.innerHTML}) );
  filename.addEventListener('input',()=> broadcast.postMessage({type:'name', value:filename.value}) );
  alert('M·ªü tab m·ªõi c√πng file ƒë·ªÉ c·ªông t√°c th·ªùi gian th·ª±c (tr√™n c√πng thi·∫øt b·ªã).');
});

  // View tab toggles
  $('#toggleSpell').addEventListener('click', (e)=>{
    const on = editor.getAttribute('spellcheck') !== 'false';
    editor.setAttribute('spellcheck', String(!on));
    e.target.setAttribute('aria-pressed', String(!on));
  });
  const leftPanel = document.querySelector('.main .panel:first-child');
  const rightPanel = document.querySelector('.main .panel:last-child');
  $('#toggleTOC').addEventListener('click',()=>{ if(leftPanel) leftPanel.style.display = (leftPanel.style.display==='none')?'': 'none'; });
  $('#toggleCommentsPanel').addEventListener('click',()=>{ if(rightPanel) rightPanel.style.display = (rightPanel.style.display==='none')?'': 'none'; });

// Basic AutoCorrect (demo)
const autocorrect = new Map(Object.entries({ '(c)':'¬©', '(r)':'¬Æ', '-->':'‚Üí', '<-':'‚Üê', '...':'‚Ä¶' }));
editor.addEventListener('input',()=>{
  const last = window.getSelection(); if(!last.rangeCount) return;
  const r = last.getRangeAt(0); const node=r.startContainer; if(node.nodeType===3){
    const txt=node.textContent; autocorrect.forEach((rep, k)=>{ if(txt.includes(k)){ node.textContent = txt.replaceAll(k, rep); } });
  }
});

  // Statusbar: word/char count
  function textStats(){
    const tmp = editor.cloneNode(true); tmp.querySelectorAll('style,script').forEach(n=>n.remove());
    const plain = tmp.innerText.trim();
    const words = plain ? plain.split(/\s+/).filter(Boolean).length : 0;
    const chars = plain.length;
    $('#wc').textContent = words + ' t·ª´';
    $('#cc').textContent = chars + ' k√Ω t·ª±';
  }
  const statsObs = new MutationObserver(textStats); statsObs.observe(editor,{subtree:true,childList:true,characterData:true});
  textStats();

  // Zoom control
  const zoomRange = $('#zoomRange'); const zoomPct = $('#zoomPct');
  function setZoom(pct){
    document.documentElement.style.setProperty('--zoom', (pct/100).toString());
    zoomPct.textContent = pct + '%';
    localStorage.setItem('vibe.zoom', String(pct));
  }
  zoomRange.addEventListener('input', e=> setZoom(parseInt(e.target.value,10)) );
  setZoom(parseInt(localStorage.getItem('vibe.zoom')||'100',10));

  // Autosave
  const saveTag = $('#saveState'); let saveTimer=null;
  function scheduleSave(){
    saveTag.textContent='ƒêang l∆∞u‚Ä¶';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      localStorage.setItem('vibe.autosave.name', filename.value||'Untitled');
      localStorage.setItem('vibe.autosave.html', editor.innerHTML);
      saveTag.textContent='ƒê√£ l∆∞u';
    }, 500);
  }
  editor.addEventListener('input', scheduleSave);
  filename.addEventListener('input', scheduleSave);
  // Restore session
  (function restore(){
    const n = localStorage.getItem('vibe.autosave.name');
    const h = localStorage.getItem('vibe.autosave.html');
    if(h){ editor.innerHTML=h; buildTOC(); }
    if(n){ filename.value=n; }
  })();

// Init demo content
editor.innerHTML = `<h1>Vibe Docs ‚Äî Demo</h1><p>Tr√¨nh so·∫°n th·∫£o m·ªôt file, ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng c∆° b·∫£n, ch·∫°y <em>ho√†n to√†n</em> trong tr√¨nh duy·ªát. H·ªó tr·ª£ in ra PDF qua h·ªôp tho·∫°i in c·ªßa tr√¨nh duy·ªát.</p><h2>M·ª•c 1</h2><p>So·∫°n th·ª≠ n·ªôi dung, d√πng ribbon ph√≠a tr√™n ƒë·ªÉ ƒë·ªãnh d·∫°ng. Th·ª≠ th√™m <strong>ƒë·∫≠m</strong>, <em>nghi√™ng</em>, <u>g·∫°ch d∆∞·ªõi</u>, <s>g·∫°ch ngang</s>.</p>`;
buildTOC();
</script>
</body>
</html>
