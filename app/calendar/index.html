<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
  crossorigin="anonymous"></script>
  <!-- SEO Meta Tags -->
  <title>Text2 Calendar</title>
  <meta name="description" content="Text2 Calendar is a modern, responsive event management and scheduling application. Create, edit, and organize your events with our intuitive calendar interface. Free online calendar tool by Text02.com">
  <meta name="keywords" content="text2 calendar, calendar app, event management, scheduling, online calendar, text02 calendar, event planner, digital calendar, free calendar">
  <meta name="author" content="Text02.com">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#4f46e5">
  
  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-6J85STMJ14');
  </script>

<meta name="google" content="notranslate"> 

  <!-- Canonical URL -->
  <link rel="canonical" href="https://text02.com/app/calendar">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://text02.com/app/calendar">
  <meta property="og:title" content="Text2 Calendar - Modern Event Management & Scheduling App">
  <meta property="og:description" content="Text2 Calendar is a modern, responsive event management and scheduling application. Create, edit, and organize your events with our intuitive calendar interface.">
  <meta property="og:image" content="https://text02.com/app/calendar/og-image.png">
  <meta property="og:site_name" content="Text02.com">
  <meta property="og:locale" content="en_US">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://text02.com/app/calendar">
  <meta name="twitter:title" content="Text2 Calendar - Modern Event Management & Scheduling App">
  <meta name="twitter:description" content="Text2 Calendar is a modern, responsive event management and scheduling application. Create, edit, and organize your events with our intuitive calendar interface.">
  <meta name="twitter:image" content="https://text02.com/app/calendar/twitter-image.png">
  
  <!-- Favicon and App Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  
  <!-- Additional SEO -->
  <meta name="application-name" content="Text2 Calendar">
  <meta name="msapplication-TileColor" content="#4f46e5">
  <meta name="msapplication-config" content="/browserconfig.xml">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Text2 Calendar",
    "alternateName": "Text02 Calendar",
    "url": "https://text02.com/app/calendar",
    "description": "Text2 Calendar is a modern, responsive event management and scheduling application. Create, edit, and organize your events with our intuitive calendar interface.",
    "applicationCategory": "ProductivityApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Text02.com",
      "url": "https://text02.com"
    },
    "creator": {
      "@type": "Organization",
      "name": "Text02.com",
      "url": "https://text02.com"
    },
    "featureList": [
      "Event Creation and Management",
      "Calendar View",
      "Event Search",
      "Dark Mode Support",
      "Data Export/Import",
      "Responsive Design",
      "Mobile-Friendly Interface"
    ],
    "screenshot": "https://text02.com/app/calendar/screenshot.png",
    "softwareVersion": "2.0",
    "datePublished": "2024-01-01",
    "dateModified": "2024-01-01"
  }
  </script>
  
  <!-- Preload Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: rgba(79, 70, 229, 0.1);
      --bg-body: #f8fafc;
      --bg-surface: #ffffff;
      --text-main: #0f172a;
      --text-sub: #64748b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --header-h: 60px;
      --nav-h: 60px;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-surface: linear-gradient(135deg, #1E1E1E 0%, #242424 100%);
      --text-main: #ffffff;
      --text-sub: #c0c0c0;
      --border: rgba(255,255,255,0.08);
      --primary-soft: rgba(79,195,247,0.2);
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    /* UTILS */
    .btn-icon {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      border: none; background: transparent; color: var(--text-main);
      border-radius: 8px; cursor: pointer; transition: 0.2s;
    }
    .btn-icon:hover { background: var(--border); }
    .hidden { display: none !important; }

    /* HEADER */
    header {
      height: var(--header-h);
      padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      z-index: 20;
    }
    .brand { font-weight: 700; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .month-nav { display: flex; align-items: center; gap: 4px; background: var(--bg-body); padding: 2px; border-radius: 8px; }
    .month-label { font-weight: 600; font-size: 14px; min-width: 100px; text-align: center; cursor: pointer; }

    /* LAYOUT */
    .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

    /* MAIN CALENDAR */
    .calendar-view { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; }

    .week-header {
      display: grid; grid-template-columns: repeat(7, 1fr);
      text-align: center; font-size: 12px; font-weight: 600;
      color: var(--text-sub); margin-bottom: 8px; padding-right: 2px;
    }

    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;
      grid-auto-rows: minmax(80px, 1fr); 
    }

    .day-cell {
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 6px;
      display: flex; flex-direction: column;
      cursor: pointer; position: relative; transition: all 0.2s;
      min-height: 80px;
    }
    .day-cell:hover { border-color: var(--primary); }
    .day-cell.inactive { opacity: 0.3; background: transparent; border: none; pointer-events: none; }
    .day-cell.today { background: var(--bg-body); border-color: var(--primary); }
    .day-cell.selected { ring: 2px solid var(--primary); border-color: var(--primary); }
    
    .day-num { 
      font-weight: 600; font-size: 14px; 
      width: 24px; height: 24px; 
      display: flex; align-items: center; justify-content: center; 
      border-radius: 50%;
    }
    .day-cell.today .day-num { background: var(--primary); color: white; }

    /* Event Indicators */
    .dots-container { display: flex; gap: 3px; margin-top: auto; justify-content: center; }
    .dot { width: 5px; height: 5px; border-radius: 50%; }
    
    .bars-container { display: none; flex-direction: column; gap: 2px; margin-top: 4px; overflow: hidden; }
    .event-bar { 
      font-size: 10px; padding: 2px 4px; border-radius: 4px; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
      color: #fff; line-height: 1.2;
    }

    /* SIDE PANEL (PC) */
    .side-panel {
      width: 320px; background: var(--bg-surface);
      border-left: 1px solid var(--border);
      display: none; flex-direction: column; padding: 20px; z-index: 10;
    }
    .side-header { margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .side-date { font-size: 20px; font-weight: 700; color: var(--primary); }

    /* EVENT LIST */
    .event-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .event-item {
      padding: 12px; border-radius: 10px;
      background: var(--bg-body);
      border-left: 3px solid var(--primary);
      position: relative; cursor: pointer;
      transition: 0.2s;
    }
    .event-item:hover { transform: translateX(2px); background: var(--border); }
    .event-time { font-size: 11px; font-weight: 600; color: var(--text-sub); }
    .event-title { font-size: 14px; font-weight: 500; margin-top: 2px; }
    .event-desc { font-size: 12px; color: var(--text-sub); margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* MOBILE NAV & FAB */
    .bottom-nav {
      height: var(--nav-h); background: var(--bg-surface);
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; align-items: center; z-index: 30;
    }
    .nav-btn {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      background: none; border: none; color: var(--text-sub); font-size: 10px; font-weight: 600;
    }
    .nav-btn.active { color: var(--primary); }
    
    .fab {
      position: absolute; bottom: 20px; right: 20px;
      width: 50px; height: 50px;
      background: var(--primary); color: white;
      border-radius: 16px; border: none;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
      font-size: 24px; display: flex; align-items: center; justify-content: center;
      z-index: 25; cursor: pointer;
    }

    /* MODAL / SHEET */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
      display: flex; align-items: flex-end; justify-content: center;
      backdrop-filter: blur(2px);
    }
    .overlay.open { opacity: 1; pointer-events: auto; }
    
    .sheet {
      background: var(--bg-surface);
      width: 100%; max-width: 500px;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      transform: translateY(100%); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 85dvh; overflow-y: auto; display: flex; flex-direction: column;
    }
    .overlay.open .sheet { transform: translateY(0); }

    /* FORM & INPUTS */
    .form-group { margin-bottom: 16px; }
    .input { 
      width: 100%; padding: 12px; border: 1px solid var(--border); 
      border-radius: 10px; background: var(--bg-body); color: var(--text-main); 
      font-size: 16px; font-family: inherit;
    }
    textarea.input { resize: none; }
    .color-row { display: flex; gap: 10px; margin-top: 8px; }
    .color-opt { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-opt.active { border-color: var(--text-main); transform: scale(1.1); }
    
    .btn-primary { 
      width: 100%; padding: 14px; background: var(--primary); color: white; 
      border: none; border-radius: 12px; font-weight: 600; font-size: 16px; 
    }
    .btn-danger {
      background: transparent; color: var(--danger); border: 1px solid var(--danger);
      margin-top: 10px;
    }

    .btn-secondary {
      width: 100%; padding: 12px 16px; background: var(--bg-body); 
      color: var(--text-main); border: 1px solid var(--border);
      border-radius: 10px; font-weight: 500; font-size: 14px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-secondary:hover {
      background: var(--primary-soft); border-color: var(--primary);
      color: var(--primary);
    }
    .btn-secondary svg {
      width: 18px; height: 18px; flex-shrink: 0;
    }

    /* SEARCH VIEW */
    .search-view {
      position: absolute; inset: 0; background: var(--bg-body);
      z-index: 50; padding: 16px; display: none; flex-direction: column;
    }
    .search-view.active { display: flex; }

    /* DESKTOP RESPONSIVE */
    @media (min-width: 1024px) {
      .bottom-nav, .fab, .dots-container { display: none !important; }
      .side-panel { display: flex; }
      .calendar-grid { grid-auto-rows: 1fr; height: 100%; }
      .bars-container { display: flex; }
      .overlay { align-items: center; }
      .sheet { border-radius: 24px; transform: scale(0.9); width: 400px; }
      .overlay.open .sheet { transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="brand">
      <a href="https://text02.com" target="_blank" style="display: flex; align-items: center; text-decoration: none; border-radius: 8px;">
        <img src="https://text02.com/favicon.ico" alt="Text02 Logo" style="width: 24px; height: 24px; border-radius: 6px;">
      </a>
      <span style="color: var(--primary); font-weight: 700; font-size: 18px; margin-left: 8px;">Text2 Cal</span>
    </div>
    <div class="month-nav">
      <button class="btn-icon" onclick="changeMonth(-1)">❮</button>
      <div class="month-label" id="monthDisplay" onclick="openDatePicker()">Loading</div>
      <button class="btn-icon" onclick="changeMonth(1)">❯</button>
    </div>
    <div style="display:flex; gap:4px">
      <button class="btn-icon" onclick="toggleSearch(true)">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </button>
      <button class="btn-icon" onclick="openSettings()">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
      </button>
    </div>
  </header>

  <!-- SEARCH OVERLAY -->
  <div class="search-view" id="searchOverlay">
    <div style="display:flex; gap:10px; margin-bottom:16px;">
      <input type="text" class="input" id="searchInput" placeholder="Search events..." oninput="handleSearch()">
      <button class="btn-icon" onclick="toggleSearch(false)">✕</button>
    </div>
    <div class="event-list" id="searchResults"></div>
  </div>

  <!-- APP BODY -->
  <div class="app-body">
    <!-- CALENDAR -->
    <main class="calendar-view">
      <div class="week-header">
        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>
      <div class="calendar-grid" id="grid"></div>
      <div style="height: 60px; flex-shrink: 0;" class="mobile-spacer"></div>
    </main>

    <!-- SIDE PANEL (PC) -->
    <aside class="side-panel">
      <div class="side-header">
        <div class="side-date" id="sideDate">Select Date</div>
        <div style="font-size:12px; color:var(--text-sub)">Schedule</div>
      </div>
      <div class="event-list" id="pcEventList"></div>
      <button class="btn-primary" onclick="openModal()" style="margin-top:auto">+ Add Event</button>
    </aside>

    <!-- FAB (Mobile) -->
    <button class="fab" onclick="openModal()">+</button>
  </div>

  <!-- BOTTOM NAV (Mobile) -->
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="toggleSearch(false)">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      Calendar
    </button>
    <button class="nav-btn" onclick="toggleSearch(true)">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      Search
    </button>
    <button class="nav-btn" onclick="openSettings()">
      <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      Settings
    </button>
  </nav>

  <!-- ADD/EDIT EVENT MODAL -->
  <div class="overlay" id="addModal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px">
        <h3 id="modalTitle">New Event</h3>
        <button class="btn-icon" onclick="closeModal('addModal')">✕</button>
      </div>
      <input type="text" id="evtTitle" class="input form-group" placeholder="Event Title" autofocus>
      <div style="display:flex; gap:10px" class="form-group">
        <input type="time" id="evtTime" class="input">
        <input type="time" id="evtEnd" class="input">
      </div>
      <textarea id="evtDesc" class="input form-group" rows="3" placeholder="Description..."></textarea>
      
      <div class="form-group">
        <label style="font-size:12px; color:var(--text-sub)">Color</label>
        <div class="color-row" id="colorPick">
          <div class="color-opt active" style="background:#4f46e5" data-c="#4f46e5"></div>
          <div class="color-opt" style="background:#ef4444" data-c="#ef4444"></div>
          <div class="color-opt" style="background:#22c55e" data-c="#22c55e"></div>
          <div class="color-opt" style="background:#f59e0b" data-c="#f59e0b"></div>
          <div class="color-opt" style="background:#6366f1" data-c="#6366f1"></div>
        </div>
      </div>
      
      <button class="btn-primary" onclick="saveEvent()">Save</button>
      <button class="btn-primary btn-danger" id="btnDelete" onclick="deleteCurrentEvent()" style="display:none">Delete Event</button>
    </div>
  </div>

  <!-- MOBILE EVENTS SHEET -->
  <div class="overlay" id="mobileSheet">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:10px;">
        <h3 id="mobSheetDate">Date</h3>
        <button class="btn-icon" onclick="closeModal('mobileSheet')">✕</button>
      </div>
      <div class="event-list" id="mobEventList" style="max-height: 40vh;"></div>
      <button class="btn-primary" onclick="openModal()" style="margin-top:16px">+ Add Here</button>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="overlay" id="settingsModal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px">
        <h3>Settings</h3>
        <button class="btn-icon" onclick="closeModal('settingsModal')">✕</button>
      </div>
      <div class="form-group">
        <button class="input" style="text-align:left; display:flex; justify-content:space-between;" onclick="toggleTheme()">
          Dark Mode <span id="themeStatus">Off</span>
        </button>
      </div>
      <div class="form-group">
        <label style="font-size:12px; color:var(--text-sub); margin-bottom:12px; display:block; font-weight:600">Data Management</label>
        <div style="display:flex; flex-direction:column; gap:10px">
          <button class="btn-secondary" onclick="exportData()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span>Export to ICS</span>
          </button>
          <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <span>Import from ICS</span>
          </button>
        </div>
        <input type="file" id="fileInput" hidden accept=".ics,text/calendar" onchange="importData(this)">
        <div style="font-size:11px; color:var(--text-sub); margin-top:8px; line-height:1.4">
          Sync with Google Calendar, Outlook, Apple Calendar and more
        </div>
      </div>
      <div style="font-size:12px; color:var(--text-sub); text-align:center; margin-top:20px">Text2 Calendar v2.0</div>
    </div>
  </div>

<script>
  // STATE
  const state = {
    curr: new Date(),
    sel: new Date().toISOString().split('T')[0],
    evts: JSON.parse(localStorage.getItem('t2_evts') || '{}'),
    col: '#4f46e5',
    editing: null // { date, index }
  };

  const el = (id) => document.getElementById(id);
  const isPC = () => window.innerWidth >= 1024;

  // INIT
  (function init() {
    render();
    if(localStorage.getItem('t2_theme') === 'dark') {
      document.body.classList.add('dark-mode');
      el('themeStatus').innerText = 'On';
    }
    
    // Color picker
    document.querySelectorAll('#colorPick .color-opt').forEach(d => {
      d.onclick = () => {
        document.querySelector('.color-opt.active').classList.remove('active');
        d.classList.add('active');
        state.col = d.dataset.c;
      }
    });

    // Close overlays
    document.querySelectorAll('.overlay').forEach(o => {
      o.onclick = (e) => { if(e.target === o) closeModal(o.id); }
    });
  })();

  function render() {
    const y = state.curr.getFullYear(), m = state.curr.getMonth();
    el('monthDisplay').innerText = state.curr.toLocaleString('en-US', {month:'long', year:'numeric'});
    
    const first = new Date(y, m, 1).getDay();
    const days = new Date(y, m+1, 0).getDate();
    const grid = el('grid');
    grid.innerHTML = '';

    for(let i=0; i<first; i++) grid.appendChild(createCell(null));

    const today = new Date().toISOString().split('T')[0];
    for(let d=1; d<=days; d++) {
      const date = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      grid.appendChild(createCell(d, date, date === today));
    }

    if(isPC()) updatePCPanel();
  }

  function createCell(d, date, isToday) {
    const cell = document.createElement('div');
    cell.className = `day-cell ${!d ? 'inactive' : ''} ${isToday ? 'today' : ''}`;
    if(!d) return cell;

    if(date === state.sel) cell.classList.add('selected');
    const evts = state.evts[date] || [];
    
    const bars = evts.map(e => `<div class="event-bar" style="background:${e.c}">${e.t}</div>`).join('');
    const dots = evts.slice(0,3).map(e => `<div class="dot" style="background:${e.c}"></div>`).join('');

    cell.innerHTML = `
      <div class="day-num">${d}</div>
      <div class="bars-container">${bars}</div>
      <div class="dots-container">${dots}</div>
    `;
    cell.onclick = () => selectDate(date);
    return cell;
  }

  function selectDate(date) {
    state.sel = date;
    render();
    if(isPC()) {
      updatePCPanel();
    } else {
      el('mobSheetDate').innerText = new Date(date).toDateString();
      renderList(el('mobEventList'), date);
      el('mobileSheet').classList.add('open');
    }
  }

  function updatePCPanel() {
    el('sideDate').innerText = new Date(state.sel).toDateString();
    renderList(el('pcEventList'), state.sel);
  }

  function renderList(container, date) {
    const list = state.evts[date] || [];
    container.innerHTML = list.length ? '' : '<div style="text-align:center; color:var(--text-sub); padding:20px;">No events</div>';
    
    list.forEach((ev, idx) => {
      const div = document.createElement('div');
      div.className = 'event-item';
      div.style.borderLeftColor = ev.c;
      div.innerHTML = `
        <div class="event-time">${ev.start || 'All day'} ${ev.end ? '- '+ev.end : ''}</div>
        <div class="event-title">${ev.t}</div>
        ${ev.desc ? `<div class="event-desc">${ev.desc}</div>` : ''}
      `;
      div.onclick = () => openModal(date, idx); // Edit on click
      container.appendChild(div);
    });
  }

  // ACTIONS
  window.changeMonth = (dir) => { state.curr.setMonth(state.curr.getMonth() + dir); render(); };
  
  window.openDatePicker = () => {
      const d = prompt("Enter date (YYYY-MM-DD):", state.sel);
      if(d && !isNaN(new Date(d).getTime())) {
          state.curr = new Date(d);
          selectDate(d);
      }
  };

  window.toggleSearch = (show) => {
    const v = el('searchOverlay');
    if(show) { v.classList.add('active'); el('searchInput').focus(); }
    else { v.classList.remove('active'); el('searchInput').value=''; el('searchResults').innerHTML=''; }
  };

  window.handleSearch = () => {
    const v = el('searchInput').value.toLowerCase();
    const c = el('searchResults');
    c.innerHTML = '';
    if(v.length < 2) return;

    Object.keys(state.evts).forEach(date => {
      state.evts[date].forEach((ev, idx) => {
        if(ev.t.toLowerCase().includes(v)) {
          const div = document.createElement('div');
          div.className = 'event-item';
          div.style.borderLeftColor = ev.c;
          div.innerHTML = `<div class="event-time">${date}</div><div class="event-title">${ev.t}</div>`;
          div.onclick = () => {
             state.curr = new Date(date);
             selectDate(date);
             toggleSearch(false);
          }
          c.appendChild(div);
        }
      });
    });
  };

  window.openModal = (date = null, idx = null) => {
    closeModal('mobileSheet');
    
    if(date && idx !== null) {
      // Edit Mode
      state.editing = { date, idx };
      const ev = state.evts[date][idx];
      el('modalTitle').innerText = 'Edit Event';
      el('evtTitle').value = ev.t;
      el('evtTime').value = ev.start;
      el('evtEnd').value = ev.end;
      el('evtDesc').value = ev.desc || '';
      state.col = ev.c;
      el('btnDelete').style.display = 'block';
    } else {
      // New Mode
      state.editing = null;
      el('modalTitle').innerText = 'New Event';
      el('evtTitle').value = '';
      el('evtTime').value = '';
      el('evtEnd').value = '';
      el('evtDesc').value = '';
      el('btnDelete').style.display = 'none';
    }

    // Reset Color UI
    document.querySelectorAll('.color-opt').forEach(o => {
      o.classList.remove('active');
      if(o.dataset.c === state.col) o.classList.add('active');
    });

    el('addModal').classList.add('open');
    setTimeout(()=> el('evtTitle').focus(), 100);
  };

  window.saveEvent = () => {
    const t = el('evtTitle').value;
    if(!t) return alert('Title needed!');
    
    const evObj = {
      t, start: el('evtTime').value, end: el('evtEnd').value, 
      desc: el('evtDesc').value, c: state.col
    };

    if(state.editing) {
      // Update
      state.evts[state.editing.date][state.editing.idx] = evObj;
    } else {
      // Create
      if(!state.evts[state.sel]) state.evts[state.sel] = [];
      state.evts[state.sel].push(evObj);
    }
    
    // Sort
    const targetDate = state.editing ? state.editing.date : state.sel;
    state.evts[targetDate].sort((a,b) => (a.start||'').localeCompare(b.start||''));
    
    saveData();
    closeModal('addModal');
    render();
    if(!isPC()) {
      renderList(el('mobEventList'), state.sel);
      el('mobileSheet').classList.add('open');
    }
  };

  window.deleteCurrentEvent = () => {
    if(state.editing && confirm('Delete?')) {
      state.evts[state.editing.date].splice(state.editing.idx, 1);
      saveData();
      closeModal('addModal');
      render();
      if(!isPC()) {
        renderList(el('mobEventList'), state.editing.date);
        el('mobileSheet').classList.add('open');
      }
    }
  };

  function saveData() {
    localStorage.setItem('t2_evts', JSON.stringify(state.evts));
  }

  // SETTINGS & EXPORT
  window.openSettings = () => el('settingsModal').classList.add('open');
  window.toggleTheme = () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('t2_theme', isDark ? 'dark' : 'light');
    el('themeStatus').innerText = isDark ? 'On' : 'Off';
  };

  // ICS Export/Import Functions
  function formatICSDate(dateStr, timeStr) {
    // dateStr: YYYY-MM-DD, timeStr: HH:MM or empty
    if (!timeStr) {
      // All-day event
      return dateStr.replace(/-/g, '');
    }
    // Timed event - convert to UTC
    const [year, month, day] = dateStr.split('-').map(Number);
    const [hours, minutes] = timeStr.split(':').map(Number);
    const date = new Date(Date.UTC(year, month - 1, day, hours, minutes));
    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  }

  function parseICSDate(icsDate) {
    // ICS format: YYYYMMDDTHHMMSSZ or YYYYMMDD (all-day)
    // Remove any timezone suffix if present
    icsDate = icsDate.trim();
    
    if (icsDate.length === 8) {
      // All-day event: YYYYMMDD
      return {
        date: `${icsDate.slice(0,4)}-${icsDate.slice(4,6)}-${icsDate.slice(6,8)}`,
        time: null
      };
    }
    
    // Timed event: YYYYMMDDTHHMMSS or YYYYMMDDTHHMMSSZ
    let hasT = icsDate.indexOf('T') !== -1;
    let hasZ = icsDate.endsWith('Z');
    
    if (hasT) {
      const datePart = icsDate.slice(0, 8);
      const timePart = icsDate.slice(9, hasZ ? 15 : icsDate.length);
      
      const year = datePart.slice(0, 4);
      const month = datePart.slice(4, 6);
      const day = datePart.slice(6, 8);
      
      const hours = timePart.slice(0, 2) || '00';
      const minutes = timePart.slice(2, 4) || '00';
      
      // Create date in UTC if Z is present, otherwise assume local
      const dateStr = `${year}-${month}-${day}T${hours}:${minutes}:00${hasZ ? 'Z' : ''}`;
      const date = new Date(dateStr);
      
      return {
        date: date.toISOString().split('T')[0],
        time: String(date.getUTCHours()).padStart(2, '0') + ':' + 
              String(date.getUTCMinutes()).padStart(2, '0')
      };
    }
    
    // Fallback: treat as all-day
    return {
      date: `${icsDate.slice(0,4)}-${icsDate.slice(4,6)}-${icsDate.slice(6,8)}`,
      time: null
    };
  }

  function escapeICS(text) {
    if (!text) return '';
    return text
      .replace(/\\/g, '\\\\')
      .replace(/;/g, '\\;')
      .replace(/,/g, '\\,')
      .replace(/\n/g, '\\n');
  }

  function unescapeICS(text) {
    if (!text) return '';
    return text
      .replace(/\\n/g, '\n')
      .replace(/\\,/g, ',')
      .replace(/\\;/g, ';')
      .replace(/\\\\/g, '\\');
  }

  window.exportData = () => {
    let icsContent = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Text2 Calendar//EN',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH'
    ];

    // Convert events to ICS format
    Object.keys(state.evts).forEach(date => {
      state.evts[date].forEach((evt, idx) => {
        const uid = `text2-cal-${date}-${idx}-${Date.now()}@text02.com`;
        const dtStart = formatICSDate(date, evt.start || '');
        const dtEnd = evt.end 
          ? formatICSDate(date, evt.end)
          : evt.start 
            ? formatICSDate(date, evt.start) 
            : formatICSDate(date, '');
        
        // If all-day, increment end date by 1 day
        let dtEndFormatted = dtEnd;
        if (!evt.start && !evt.end) {
          const endDate = new Date(date);
          endDate.setDate(endDate.getDate() + 1);
          dtEndFormatted = endDate.toISOString().split('T')[0].replace(/-/g, '');
        } else if (evt.start && !evt.end) {
          // If start time but no end time, add 1 hour
          const [year, month, day] = date.split('-').map(Number);
          const [hours, minutes] = evt.start.split(':').map(Number);
          const endDate = new Date(Date.UTC(year, month - 1, day, hours + 1, minutes));
          dtEndFormatted = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        icsContent.push('BEGIN:VEVENT');
        icsContent.push(`UID:${uid}`);
        icsContent.push(`DTSTART${!evt.start ? ';VALUE=DATE' : ''}:${dtStart}`);
        icsContent.push(`DTEND${!evt.start ? ';VALUE=DATE' : ''}:${dtEndFormatted}`);
        icsContent.push(`SUMMARY:${escapeICS(evt.t)}`);
        if (evt.desc) {
          icsContent.push(`DESCRIPTION:${escapeICS(evt.desc)}`);
        }
        // Store color in X-COLOR property (non-standard but useful)
        if (evt.c) {
          icsContent.push(`X-COLOR:${evt.c}`);
        }
        icsContent.push(`DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z`);
        icsContent.push('END:VEVENT');
      });
    });

    icsContent.push('END:VCALENDAR');
    
    const icsString = icsContent.join('\r\n');
    const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", url);
    dlAnchorElem.setAttribute("download", `text2_calendar_${new Date().toISOString().slice(0,10)}.ics`);
    dlAnchorElem.click();
    URL.revokeObjectURL(url);
  };

  window.importData = (input) => {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const icsText = e.target.result;
        const importedEvents = {};
        
        // Parse ICS file
        const lines = icsText.split(/\r?\n/);
        let currentEvent = null;
        let inEvent = false;
        
        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          
          // Handle line folding (ICS allows lines to be folded with space/tab continuation)
          while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
            line += lines[i + 1].substring(1);
            i++;
          }
          
          if (line.startsWith('BEGIN:VEVENT')) {
            inEvent = true;
            currentEvent = {};
          } else if (line.startsWith('END:VEVENT')) {
            if (currentEvent && currentEvent.summary) {
              const dateKey = currentEvent.date;
              if (!importedEvents[dateKey]) {
                importedEvents[dateKey] = [];
              }
              
              const evt = {
                t: currentEvent.summary,
                desc: currentEvent.description || '',
                c: currentEvent.color || '#4f46e5',
                start: currentEvent.startTime || '',
                end: currentEvent.endTime || ''
              };
              
              importedEvents[dateKey].push(evt);
            }
            inEvent = false;
            currentEvent = null;
          } else if (inEvent && currentEvent) {
            if (line.startsWith('DTSTART')) {
              // Handle DTSTART;VALUE=DATE:20240101 or DTSTART:20240101T120000Z
              const colonIndex = line.indexOf(':');
              if (colonIndex !== -1) {
                const value = line.substring(colonIndex + 1);
                const parsed = parseICSDate(value);
                currentEvent.date = parsed.date;
                currentEvent.startTime = parsed.time;
              }
            } else if (line.startsWith('DTEND')) {
              // Handle DTEND;VALUE=DATE:20240102 or DTEND:20240101T130000Z
              const colonIndex = line.indexOf(':');
              if (colonIndex !== -1) {
                const value = line.substring(colonIndex + 1);
                const parsed = parseICSDate(value);
                currentEvent.endTime = parsed.time;
              }
            } else if (line.startsWith('SUMMARY:')) {
              currentEvent.summary = unescapeICS(line.substring(8));
            } else if (line.startsWith('DESCRIPTION:')) {
              currentEvent.description = unescapeICS(line.substring(12));
            } else if (line.startsWith('X-COLOR:')) {
              currentEvent.color = line.substring(8);
            }
          }
        }
        
        // Merge with existing events
        const mergedEvents = { ...state.evts };
        for (const date in importedEvents) {
          if (mergedEvents[date]) {
            mergedEvents[date] = mergedEvents[date].concat(importedEvents[date]);
          } else {
            mergedEvents[date] = importedEvents[date];
          }
        }
        
        state.evts = mergedEvents;
        saveData();
        render();
        alert('Events imported successfully!');
        closeModal('settingsModal');
      } catch(err) { 
        console.error(err);
        alert('Invalid ICS file. Please check the file format.'); 
      }
    };
    reader.readAsText(file);
  };

  window.closeModal = (id) => el(id).classList.remove('open');
  window.onresize = () => { if(isPC()) closeModal('mobileSheet'); render(); };
</script>
</body>
</html>

