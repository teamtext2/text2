<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  
  <!-- SEO Meta Tags -->
  <title>Text2 — Calendar</title>
  <meta name="description" content="Text2 Calendar App - A professional, responsive calendar application for managing events, appointments, and schedules. Features dark mode, lunar calendar, event search, and data import/export." />
  <meta name="keywords" content="calendar app, event management, schedule planner, appointment tracker, lunar calendar, dark mode calendar, responsive calendar, web calendar, Text2 calendar" />
  <meta name="author" content="Text2" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="English" />
  <meta name="revisit-after" content="7 days" />

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-6J85STMJ14');
  </script>

  <!-- no translate -->
  <meta name="google" content="notranslate"> 

  <!-- text2 ads -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
  crossorigin="anonymous"></script>
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Text2 — Calendar Pro | Professional Calendar & Event Management App" />
  <meta property="og:description" content="Text2 Calendar App - A professional, responsive calendar application for managing events, appointments, and schedules. Features dark mode, lunar calendar, event search, and data import/export." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://text2calendar.com" />
  <meta property="og:image" content="https://text2calendar.com/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="Text2 Calendar App - Professional Calendar Interface" />
  <meta property="og:site_name" content="Text2 Calendar" />
  <meta property="og:locale" content="en_US" />
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Text2 — Calendar Pro | Professional Calendar & Event Management App" />
  <meta name="twitter:description" content="Text2 Calendar App - A professional, responsive calendar application for managing events, appointments, and schedules." />
  <meta name="twitter:image" content="https://text2calendar.com/twitter-card.png" />
  <meta name="twitter:image:alt" content="Text2 Calendar App Interface" />
  <meta name="twitter:site" content="@Text2Calendar" />
  <meta name="twitter:creator" content="@Text2Calendar" />
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1722731267767270"
  crossorigin="anonymous"></script> 
  
  <!-- Additional SEO Meta Tags -->
  <meta name="application-name" content="Text2 Calendar" />
  <meta name="msapplication-TileColor" content="#2563eb" />
  <meta name="msapplication-config" content="/browserconfig.xml" />
  <meta name="format-detection" content="telephone=no" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://text2calendar.com" />
  
  <!-- Alternate Languages (if you plan to support multiple languages) -->
  <link rel="alternate" hreflang="en" href="https://text2calendar.com" />
  <link rel="alternate" hreflang="x-default" href="https://text2calendar.com" />
  
  <!-- Favicons and App Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Preconnect for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- DNS Prefetch for External Resources -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Text2 Calendar Pro",
    "alternateName": "Text2 Calendar App",
    "description": "A professional, responsive calendar application for managing events, appointments, and schedules. Features dark mode, lunar calendar, event search, and data import/export.",
    "url": "https://text2calendar.com",
    "applicationCategory": "ProductivityApplication",
    "operatingSystem": "Web Browser",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "author": {
      "@type": "Organization",
      "name": "Text2"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Text2"
    },
    "datePublished": "2024-01-01",
    "dateModified": "2024-12-19",
    "inLanguage": "en-US",
    "isAccessibleForFree": true,
    "browserRequirements": "Requires JavaScript. Requires HTML5.",
    "softwareVersion": "1.0",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "ratingCount": "150"
    },
    "featureList": [
      "Event Management",
      "Dark Mode Support",
      "Lunar Calendar Display",
      "Event Search",
      "Data Import/Export",
      "Responsive Design",
      "Touch-Friendly Interface",
      "Keyboard Navigation"
    ]
  }
  </script>
  
  <meta name="google" content="notranslate">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Text2 Calendar">
  <style>
    
    :root {
      --primary: #2563eb; /* Professional blue */
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --white: #ffffff;
      --black: #000000;
      --bg: #ffffff;
      --bg-secondary: #f8fafc;
      --text: #1f2937;
      --text-dark: #111827;
      --text-muted: #6b7280;
      --text-light: #9ca3af;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s ease-in-out;
    }

    /* (MỚI) Chế độ tối */
    body.dark-mode {
        --bg: #0f172a;
        --bg-secondary: #1e293b;
        --text: #ffffff;           /* (SỬA) Thành trắng tinh */
        --text-dark: #ffffff;      /* (SỬA) Thành trắng tinh */
        --text-muted: #e2e8f0;      /* (SỬA) Sáng hơn nhiều */
        --text-light: #94a3b8;     /* (SỬA) Sáng hơn */
        --border: #334155;
        --border-light: #475569;
        --white: #1e293b;
        --black: #f8fafc;
    }
    body.dark-mode .color-swatch.selected {
      border-color: var(--border-light);
      box-shadow: 0 0 0 3px var(--text-dark);
    }
    /* (MỚI) Style cho danh sách sự kiện chi tiết */
    body.dark-mode .delete-event-btn:hover {
      background: #dc2626;
      border-color: #dc2626;
      color: var(--white);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* --- BACKGROUND --- */
    body {
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 16px;
      overflow: hidden; 
      position: relative;
      transition: background-color 0.3s ease; /* Thêm transition */
    }
    
    body.sidebar-open {
      overflow: hidden;
    }
    
    /* Subtle pattern background */
    body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:  
          radial-gradient(circle at 25% 25%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
        z-index: -1;
    }


    /* --- MAIN APP CONTAINER --- */
    .calendar-app {
      width: 100%;
      max-width: 1200px;
      height: calc(100vh - 32px);
      max-height: 800px;
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 1; 
      transition: margin-left 0.3s ease-in-out, max-width 0.3s ease-in-out, transform 0.3s ease; /* Sửa transition */
    }

    /* --- HEADER --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      min-height: 60px;
    }

    .nav-buttons, .date-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn, .date-selector button {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
    }
    
    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .icon-btn:hover, .date-selector button:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--white);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .date-selector button {
      padding: 8px 16px;
      font-weight: 500;
      font-size: 16px;
    }

    #calendarDisplay {
      text-align: center;
      font-weight: 600;
      font-size: 20px;
      color: var(--text-dark);
      flex-grow: 1;
    }

    /* --- CALENDAR --- */
    .calendar-container {
      padding: 24px;
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      min-height: 0;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 12px;
      flex: 1;
      min-height: 0;
      align-content: stretch;
    }

    .day-cell {
      background: var(--white);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      color: var(--text);
      overflow: hidden;
      padding: 4px;
      min-height: 0;
    }

    .day-cell:hover {
      transform: scale(1.02);
      border-color: var(--primary);
      background: var(--bg-secondary);
      box-shadow: var(--shadow);
    }
    
    .day-cell.inactive {
        color: var(--text-light);
        background: var(--bg-secondary);
        pointer-events: none;
        opacity: 0.5;
    }

    .day-number {
      font-size: 16px;
      font-weight: 500;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      z-index: 2;
      margin-top: 2px;
      flex-shrink: 0;
    }
    
    .lunar-day {
      font-size: 11px;
      color: var(--text-muted);
      z-index: 2;
      display: none; 
      margin-top: 2px;
    }
    
    body.lunar-visible .lunar-day {
      display: block; 
    }

    .day-cell:hover .day-number {
        color: var(--primary);
        font-weight: 600;
    }

    .day-cell .current-day {
      background-color: var(--primary);
      color: var(--white);
      font-weight: 700;
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .event-dot {
      position: absolute;
      bottom: 8px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(37, 99, 235, 0.3);
      z-index: 1;
      flex-shrink: 0;
    }
    
    /* --- ADD BUTTON --- */
    .add-btn {
      position: absolute;
      bottom: 40px;
      right: 40px;
      background: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
      z-index: 50;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .add-btn:hover {
      transform: scale(1.05) rotate(90deg);
      background: var(--primary-dark);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    /* --- MODALS --- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002; 
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal.show {
        display: flex;
        opacity: 1;
    }

    .modal-content {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      width: min(550px, 95vw); /* (MỚI) Tăng kích thước */
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text);
      transform: scale(0.95);
      transition: transform 0.3s ease;
      display: flex; /* (MỚI) Thêm flex */
      flex-direction: column; /* (MỚI) Thêm flex */
    }
    
    .modal.show .modal-content {
        transform: scale(1);
    }

    .modal-content h3 {
      color: var(--text-dark);
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }

    input, textarea {
      width: 100%;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      font-size: 16px;
      margin-bottom: 12px;
      transition: var(--transition);
      color: var(--text);
    }
    
    input::placeholder, textarea::placeholder {
        color: var(--text-muted);
    }

    input:focus, textarea:focus {
      background: var(--white);
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Input tùy chỉnh (cho file, date) */
    .input-group {
      margin-bottom: 12px;
    }
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    input[type="date"], input[type="file"] {
      padding: 10px 16px;
    }
    input[type="file"] {
      font-size: 14px;
      padding: 0;
      border: none;
      background: transparent;
      box-shadow: none;
    }
     input[type="file"]::file-selector-button {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px 12px;
      margin-right: 12px;
     }
     input[type="file"]::file-selector-button:hover {
       background: var(--bg-secondary);
     }


    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
      box-shadow: var(--shadow);
    }
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text);
        border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--border-light);
      border-color: var(--text-muted);
    }
    
    .btn-danger {
        background: #dc2626;
        color: var(--white);
    }
    .btn-danger:hover {
        background: #b91c1c;
        transform: translateY(-1px);
    }
    
    #selectorList {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
    }
    
    #selectorList button {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 10px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
    }
    #selectorList button:hover {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
    }
    
    /* (MỚI) Sửa lại style cho #eventDetailsContent */
    #eventDetailsContent {
      flex: 1; /* Cho phép co giãn */
      overflow-y: auto; /* Thêm cuộn nếu cần */
      margin-bottom: 16px;
      max-height: 40vh; /* Giới hạn chiều cao */
      padding-right: 10px; /* Chỗ cho thanh cuộn */
    }
    .event-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-light);
    }
    .event-list-item:last-child {
        border-bottom: none;
    }
    .event-list-item-details {
        flex: 1;
        margin-right: 12px;
    }
    .event-list-item-details b {
        font-size: 1.1em;
        display: block;
    }
    .event-list-item-details p {
        margin: 4px 0 0;
        line-height: 1.5;
        font-size: 15px;
        color: var(--text-muted);
    }
    .delete-event-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-muted);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0;
    }
    .delete-event-btn svg { width: 18px; height: 18px; }
    .delete-event-btn:hover {
        background: #dc2626;
        border-color: #dc2626;
        color: var(--white);
    }


    /* --- SIDEBAR (MỚI) --- */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 300px;
      height: 100vh;
      height: 100svh; /* (SỬA) */
      background: var(--bg);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      z-index: 1001;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-top: calc(20px + env(safe-area-inset-top)); /* (SỬA) */
      padding-bottom: calc(20px + env(safe-area-inset-bottom)); /* (SỬA) */
      padding-left: calc(20px + env(safe-area-inset-left)); /* (SỬA) */
      overflow-y: auto;
    }
    .sidebar.open {
      transform: translateX(0);
    }
    
    /* Mobile sidebar - hiển thị ở dưới */
    @media (max-width: 1023px) {
      .sidebar {
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: auto;
        max-height: 70vh;
        max-height: 70svh;
        border-right: none;
        border-top: 1px solid var(--border);
        transform: translateY(100%);
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }
      .sidebar.open {
        transform: translateY(0);
      }
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .sidebar-header h2 {
      font-size: 20px;
      color: var(--text-dark);
    }
    #closeSidebarBtn {
      background: transparent;
      border: none;
    }
    
    .sidebar-section {
      margin-bottom: 20px;
    }
    .sidebar-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 4px;
    }
    
    /* Toggle Switch */
    .switch-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    .switch-group label {
      font-size: 16px;
      color: var(--text);
      font-weight: 500;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--primary);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Search Results */
    #searchResults {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 150px;
      overflow-y: auto;
    }
    #searchResults li {
      padding: 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
    }
    #searchResults li:hover {
      background: var(--bg-secondary);
    }
    #searchResults li small {
      color: var(--primary);
      font-weight: 600;
      margin-right: 8px;
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    /* (MỚI) Sửa logic overlay */
    @media (max-width: 1023.98px) {
      .sidebar-overlay.open {
        opacity: 1;
        visibility: visible;
      }
    }

    /* --- COLOR PICKER (MỚI) --- */
    .color-picker {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      margin-top: 8px;
      justify-content: center;
    }
    .color-swatch {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    .color-swatch.selected {
      border-color: var(--white);
      box-shadow: 0 0 0 3px var(--text-dark);
      transform: scale(1.1);
    }

    /* --- TOAST (MỚI) --- */
    .toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-dark);
      color: var(--bg);
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 1005;
      transition: bottom 0.3s ease-in-out;
      font-size: 15px;
    }
    .toast.show {
      bottom: 30px;
    }

    /* --- RESPONSIVE --- */
    /* (MỚI) Logic đẩy UI khi sidebar mở trên desktop */
    @media (min-width: 1024px) {
      body.sidebar-open .calendar-app {
        margin-left: 300px;
        max-width: calc(1200px - 300px); 
      }
    }
    
    /* Mobile-specific improvements */
    @media (max-width: 1023px) {
      /* Đảm bảo calendar không bị đẩy khi sidebar mở */
      body.sidebar-open .calendar-app {
        margin-left: 0;
        max-width: none;
      }
      
      /* Cải thiện hiệu ứng mở sidebar từ dưới */
      .sidebar {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      /* Tối ưu overlay cho mobile */
      .sidebar-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
    }
    
    /* Desktop Large (1200px+) */
    @media (min-width: 1200px) {
      .calendar-app {
        max-width: 1400px;
        height: calc(100vh - 40px);
      }
      body.sidebar-open .calendar-app {
         max-width: calc(1400px - 300px);
      }
      .calendar-container {
        padding: 32px;
      }
      .days-grid {
        gap: 16px;
      }
      .day-cell {
        min-height: 85px;
      }
      .day-number {
        font-size: 18px;
        width: 36px;
        height: 36px;
      }
      .weekdays {
        font-size: 15px;
        margin-bottom: 16px;
      }
      .lunar-day {
        font-size: 12px;
      }
    }

    /* Very small mobile (max-width: 360px) */
    @media (max-width: 360px) {
      .header {
        padding: 6px 8px;
        gap: 4px;
      }
      #calendarDisplay {
        font-size: 14px;
      }
      .icon-btn {
        width: 34px;
        height: 34px;
        min-width: 34px;
        min-height: 34px;
      }
      .icon-btn svg {
        width: 16px;
        height: 16px;
      }
      .date-selector button {
        padding: 4px 6px;
        font-size: 10px;
        min-height: 30px;
      }
      .calendar-container {
        padding: 4px 2px;
      }
      .weekdays {
        font-size: 9px;
        margin-bottom: 3px;
      }
      .days-grid {
        gap: 2px;
      }
      .day-cell {
        border-radius: 4px;
        padding: 1px;
      }
      .day-number {
        font-size: 13px;
        width: 26px;
        height: 26px;
      }
      .lunar-day {
        font-size: 7px;
      }
      .event-dot {
        width: 3px;
        height: 3px;
        bottom: 3px;
      }
      .add-btn {
        width: 46px;
        height: 46px;
        min-width: 46px;
        min-height: 46px;
      }
      .add-btn svg {
        width: 20px;
        height: 20px;
      }
    }

    /* Tablet Landscape (768px - 991px) */
    @media (max-width: 991px) and (min-width: 768px) {
      .calendar-app {
        max-width: 900px;
        height: calc(100vh - 20px);
      }
      .header {
        padding: 16px 20px;
      }
      .calendar-container {
        padding: 20px;
      }
      .days-grid {
        gap: 10px;
      }
      .day-cell {
        min-height: 65px;
      }
      .day-number {
        font-size: 15px;
        width: 30px;
        height: 30px;
      }
      #calendarDisplay {
        font-size: 18px;
      }
      .weekdays {
        font-size: 13px;
        margin-bottom: 10px;
      }
      .add-btn {
        width: 56px;
        height: 56px;
        bottom: 30px;
        right: 30px;
      }
    }

    /* Tablet Portrait & Mobile Large (481px - 767px) */
    @media (max-width: 767px) {
      body { 
        padding: 4px; 
      }
      .calendar-app { 
        height: calc(100vh - 8px); 
        max-height: none;
        border-radius: var(--radius-md); 
      }
      .header { 
        flex-direction: row;
        gap: 8px; 
        padding: 10px 12px; 
        text-align: left;
        flex-wrap: wrap;
        min-height: auto;
        align-items: center;
      }
      .nav-buttons {
        order: 1;
        width: auto;
        justify-content: flex-start;
        gap: 8px;
      }
      #calendarDisplay { 
        order: 2;
        flex: 1;
        font-size: 18px; 
        margin-bottom: 0;
        text-align: center;
        min-width: 0;
      }
      .date-selector {
        order: 3;
        width: auto;
        justify-content: flex-end;
        margin-left: auto;
        gap: 6px;
      }
      .date-selector button {
        padding: 6px 10px;
        font-size: 12px;
      }
      .calendar-container { 
        padding: 10px 8px; 
        flex: 1;
        min-height: 0;
      }
      .days-grid { 
        gap: 5px;
        min-height: 0;
      }
      .day-cell {
        min-height: 0;
        aspect-ratio: 1;
        border-radius: var(--radius-sm); 
      }
      .day-number {
        font-size: 15px;
        width: 30px;
        height: 30px;
      }
      .lunar-day {
        font-size: 9px;
        margin-top: 1px;
      }
      .weekdays {
        font-size: 12px;
        margin-bottom: 8px;
        padding: 0 4px;
      }
      .event-dot {
        width: 5px;
        height: 5px;
        bottom: 6px;
      }
      .add-btn { 
        width: 52px; 
        height: 52px; 
        bottom: 20px; 
        right: 20px; 
      }
      .modal-content {
        width: min(400px, 95vw);
        padding: 20px;
      }
    }

    /* Mobile Portrait (320px - 480px) */
    @media (max-width: 480px) {
      body { 
        padding: 0; 
      }
      .calendar-app { 
        height: 100vh; 
        height: 100svh;
        max-height: none;
        border-radius: 0; 
        border: none;
        box-shadow: none;
      }
      .header { 
        flex-direction: row;
        gap: 6px;
        padding: 6px 8px;
        text-align: left;
        flex-wrap: wrap;
        align-items: center;
        min-height: auto;
      }
      .nav-buttons {
        order: 1;
        width: auto;
        justify-content: flex-start;
        gap: 6px;
      }
      #calendarDisplay { 
        order: 2;
        flex: 1;
        font-size: 16px;
        margin-bottom: 0;
        text-align: center;
        min-width: 0;
        font-weight: 600;
      }
      .date-selector {
        order: 3;
        width: auto;
        justify-content: flex-end;
        margin-left: auto;
        gap: 4px;
      }
      .date-selector button {
        padding: 5px 8px;
        font-size: 11px;
        min-height: 32px;
      }
      .icon-btn {
        width: 38px;
        height: 38px;
        min-width: 38px;
        min-height: 38px;
      }
      .icon-btn svg {
        width: 18px;
        height: 18px;
      }
      .calendar-container { 
        padding: 6px 4px;
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .weekdays {
        font-size: 10px;
        margin-bottom: 4px;
        padding: 0 2px;
        font-weight: 600;
      }
      .days-grid { 
        gap: 3px;
        flex: 1;
        min-height: 0;
      }
      .day-cell {
        min-height: 0;
        aspect-ratio: 1;
        border-radius: 6px;
        padding: 2px;
      }
      .day-number {
        font-size: 14px;
        width: 28px;
        height: 28px;
        font-weight: 500;
      }
      .lunar-day {
        font-size: 8px;
        margin-top: 0;
        line-height: 1;
      }
      .event-dot {
        width: 4px;
        height: 4px;
        bottom: 4px;
      }
      .add-btn { 
        width: 50px;
        height: 50px;
        bottom: calc(16px + env(safe-area-inset-bottom));
        right: calc(16px + env(safe-area-inset-right));
        min-width: 50px;
        min-height: 50px;
      }
      .add-btn svg {
        width: 22px;
        height: 22px;
      }
      .modal {
        padding: 0;
        align-items: flex-end; 
      }
      .modal-content {
        width: 100vw;
        max-height: 90vh;
        max-height: 90svh;
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        transform: translateY(100%);
      }
      .modal.show .modal-content {
        transform: translateY(0);
      }
    }

    /* Landscape orientation adjustments */
    @media (max-height: 500px) and (orientation: landscape) {
      .calendar-app {
        height: calc(100vh - 10px);
      }
      .header {
        padding: 6px 12px;
        flex-direction: row; 
        gap: 6px;
      }
      .nav-buttons { 
        order: 1; 
        width: auto; 
        gap: 6px;
      }
      #calendarDisplay { 
        order: 2; 
        font-size: 14px;
        flex: 1;
      }
      .date-selector { 
        order: 3; 
        width: auto; 
        gap: 4px;
      }
      .date-selector button {
        padding: 4px 8px;
        font-size: 11px;
      }
      .icon-btn {
        width: 32px;
        height: 32px;
      }
      .icon-btn svg {
        width: 16px;
        height: 16px;
      }
      .calendar-container {
        padding: 4px 8px;
        flex: 1;
        min-height: 0;
      }
      .days-grid {
        gap: 3px;
        flex: 1;
        min-height: 0;
      }
      .day-cell {
        min-height: 0;
        aspect-ratio: 1;
      }
      .day-number {
        font-size: 12px;
        width: 24px;
        height: 24px;
      }
      .lunar-day {
        display: none; 
      }
      .weekdays {
        font-size: 10px;
        margin-bottom: 4px;
        padding: 0 2px;
      }
      .event-dot {
        width: 3px;
        height: 3px;
        bottom: 3px;
      }
      .add-btn {
        width: 44px;
        height: 44px;
        bottom: 12px;
        right: 12px;
      }
      .add-btn svg {
        width: 20px;
        height: 20px;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .day-cell:hover {
        transform: none;
        border-color: var(--border-light);
        background: var(--white);
        box-shadow: none;
      }
      .day-cell:active {
        transform: scale(0.95);
        background: var(--bg-secondary);
        border-color: var(--primary);
      }
      .day-cell:hover .day-number {
        color: var(--text);
        font-weight: 500;
      }
      .icon-btn:hover, .date-selector button:hover {
        transform: none;
        background: var(--white);
        border-color: var(--border);
        color: var(--text);
        box-shadow: none;
      }
      .icon-btn:active, .date-selector button:active {
        transform: scale(0.95);
        background: var(--primary);
        border-color: var(--primary);
        color: var(--white);
      }
      .add-btn:hover {
        transform: none;
        background: var(--primary);
        box-shadow: var(--shadow-lg);
      }
      .add-btn:active {
        transform: scale(0.95);
        background: var(--primary-dark);
      }
      .modal-btn:hover {
        transform: none;
      }
      .modal-btn:active {
        transform: scale(0.98);
      }
      
      /* Tối ưu kích thước cho touch */
      .day-cell {
        min-height: 0;
        aspect-ratio: 1;
      }
      .icon-btn {
        min-width: 38px;
        min-height: 38px;
      }
      .date-selector button {
        min-height: 32px;
        padding: 6px 12px;
      }
      .add-btn {
        min-width: 50px;
        min-height: 50px;
      }
      
      /* Cải thiện sidebar trên mobile */
      .sidebar {
        padding: 20px;
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
      }
      
      /* Tối ưu modal trên mobile */
      .modal-content {
        padding: 20px;
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
      }
      
      /* Cải thiện các nút trong sidebar */
      .switch {
        width: 50px;
        height: 28px;
      }
      .slider:before {
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
      }
      input:checked + .slider:before {
        transform: translateX(22px);
      }
    }

    /* (MỚI) Bỏ media query cho dark mode */
    /* @media (prefers-color-scheme: dark) { ... } */

    /* Focus indicators for keyboard navigation */
    .icon-btn:focus,
    .date-selector button:focus,
    .add-btn:focus,
    .modal-btn:focus,
    .day-cell:focus,
    .sidebar input:focus,
    .sidebar button:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Skip to content link for screen readers */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--primary);
      color: var(--white);
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
    }
    .skip-link:focus {
      top: 6px;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Sidebar (Mới) -->
  <nav class="sidebar" id="sidebar" aria-label="Options menu">
    <div class="sidebar-header">
      <h2>Options</h2>
      <button id="closeSidebarBtn" class="icon-btn" aria-label="Close menu">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="sidebar-section">
        <h3>Search</h3>
        <div class="input-group">
          <label for="searchEventsInput">Search events</label>
          <input type="search" id="searchEventsInput" placeholder="Enter event name...">
          <ul id="searchResults"></ul>
        </div>
        <div class="input-group">
          <label for="gotoDateInput">Go to date</label>
          <input type="date" id="gotoDateInput">
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3>Settings</h3>
        <div class="switch-group">
          <label for="lunarToggle">Show Lunar</label>
          <label class="switch">
            <input type="checkbox" id="lunarToggle">
            <span class="slider"></span>
          </label>
        </div>
        <!-- (MỚI) Thêm theme toggle -->
        <div class="switch-group">
          <label for="themeToggle">Dark Mode</label>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Data</h3>
        <div class="input-group">
          <label for="importFileBtn">Import events file (.json)</label>
          <input type="file" id="importFileBtn" accept=".json">
        </div>
        <div class="input-group">
           <button id="exportFileBtn" class="modal-btn btn-secondary" style="width: 100%;">Export events file</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Overlay (Mới) -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Main App -->
  <div class="calendar-app" id="main-content">
    <div class="header">
      <div class="nav-buttons">
        <!-- Nút Menu (Mới) -->
        <button id="menuToggleBtn" class="icon-btn" aria-label="Open menu">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <button id="prevMonthBtn" class="icon-btn" aria-label="Previous month">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <button id="nextMonthBtn" class="icon-btn" aria-label="Next month">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>
      </div>
      <div id="calendarDisplay"></div>
      <div class="date-selector">
        <button id="monthSelector">Month</button>
        <button id="yearSelector">Year</button>
      </div>
    </div>

    <div class="calendar-container">
      <div class="weekdays">
        <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
      </div>
      <div id="daysGrid" class="days-grid"></div>
    </div>
  </div>

  <button id="addEventBtn" class="add-btn" aria-label="Add event">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
  </button>

  <!-- Toast (Mới) -->
  <div id="toast-notification" class="toast"></div>

  <!-- Modals -->
  <div id="selectorModal" class="modal">
    <div class="modal-content">
      <h3 id="selectorTitle">Select...</h3>
      <div id="selectorList"></div>
      <div class="modal-actions">
          <button onclick="closeModal('selectorModal')" class="modal-btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <div id="eventFormModal" class="modal">
    <div class="modal-content">
      <h3>Add event for <span id="eventDateDisplay"></span></h3>
      <form id="eventForm">
        <input type="hidden" id="eventDayDate">
        <input type="text" id="eventTitle" placeholder="Event title" required>
        <textarea id="eventDetails" placeholder="Details (optional)" rows="3"></textarea>
        
        <!-- Color Picker (Mới) -->
        <input type="hidden" id="eventColor" value="#2563eb">
        <div class="color-picker" id="colorPicker">
            <span class="color-swatch selected" data-color="#2563eb" style="background-color: #2563eb;" aria-label="Blue color"></span>
            <span class="color-swatch" data-color="#e11d48" style="background-color: #e11d48;" aria-label="Red color"></span>
            <span class="color-swatch" data-color="#16a34a" style="background-color: #16a34a;" aria-label="Green color"></span>
            <span class="color-swatch" data-color="#f97316" style="background-color: #f97316;" aria-label="Orange color"></span>
            <span class="color-swatch" data-color="#6d28d9" style="background-color: #6d28d9;" aria-label="Purple color"></span>
        </div>

        <div class="modal-actions">
            <button type="button" onclick="closeModal('eventFormModal')" class="modal-btn btn-secondary">Cancel</button>
            <button type="submit" class="modal-btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="eventDetailsModal" class="modal">
    <div class="modal-content">
      <h3>Events for <span id="popupEventDate"></span></h3>
      <!-- (MỚI) Sửa lại eventDetailsContent -->
      <div id="eventDetailsContent">
          <!-- JS sẽ render danh sách sự kiện vào đây -->
      </div>
      <!-- (MỚI) Sửa lại modal-actions -->
      <div class="modal-actions">
        <button onclick="closeModal('eventDetailsModal')" class="modal-btn btn-secondary">Close</button>
        <button id="addAnotherEventBtn" class="modal-btn btn-primary">Add New</button>
      </div>
    </div>
  </div>

  <script>
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const calendarDisplay = document.getElementById("calendarDisplay");
    const daysGrid = document.getElementById("daysGrid");
    const monthSelectorBtn = document.getElementById("monthSelector");
    const yearSelectorBtn = document.getElementById("yearSelector");
    
    const selectorModal = document.getElementById("selectorModal");
    const selectorTitle = document.getElementById("selectorTitle");
    const selectorList = document.getElementById("selectorList");
    
    const eventFormModal = document.getElementById("eventFormModal");
    const eventDetailsModal = document.getElementById("eventDetailsModal");
    
    const popupEventDate = document.getElementById("popupEventDate");
    const eventDetailsContent = document.getElementById("eventDetailsContent");
    const eventForm = document.getElementById("eventForm");
    const eventDateDisplay = document.getElementById("eventDateDisplay");
    const eventDayDateInput = document.getElementById("eventDayDate");
    
    // (Mới) DOM Elements cho Sidebar
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');
    const searchEventsInput = document.getElementById('searchEventsInput');
    const searchResults = document.getElementById('searchResults');
    const gotoDateInput = document.getElementById('gotoDateInput');
    const lunarToggle = document.getElementById('lunarToggle');
    const themeToggle = document.getElementById('themeToggle'); // (Mới) Thêm theme toggle
    const importFileBtn = document.getElementById('importFileBtn');
    const exportFileBtn = document.getElementById('exportFileBtn');
    const colorPicker = document.getElementById('colorPicker');
    const eventColorInput = document.getElementById('eventColor');
    const addAnotherEventBtn = document.getElementById('addAnotherEventBtn'); // (Mới) Thêm nút

    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedDayForEvent = null;
    let showLunar = false; 

    function loadEvents() {
      return JSON.parse(localStorage.getItem("calendarEvents") || "{}");
    }

    function saveEvents(e) {
      localStorage.setItem("calendarEvents", JSON.stringify(e));
    }

    function formatDate(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function formatDisplayDate(d) {
      const p = d.split("-");
      return `${p[2]}/${p[1]}/${p[0]}`;
    }

    function getLunarDate(d, m, y) {
      // Placeholder
      let lunarDay = d;
      let lunarMonth = (m === 1 ? 12 : m - 1);
      if (d > 28) lunarDay = d - 28;
      if (d === 1) lunarMonth = m;
      if (d === 30) lunarMonth = m;
      return `${lunarDay}/${lunarMonth}`;
    }

    function renderCalendar() {
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const firstDay = firstDayOfMonth.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      daysGrid.innerHTML = "";
      calendarDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      monthSelectorBtn.textContent = monthNames[currentMonth];
      yearSelectorBtn.textContent = currentYear;

      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

      for (let i = firstDay; i > 0; i--) {
        const day = daysInPrevMonth - i + 1;
        daysGrid.appendChild(createCell(day, "inactive", null));
      }

      const today = new Date();
      const events = loadEvents();
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(currentYear, currentMonth, d);
        const key = formatDate(date);
        const cell = createCell(d, "", key);

        if (today.toDateString() === date.toDateString()) {
          const span = cell.querySelector(".day-number");
          span.classList.add("current-day");
        }
        
        const dayEvents = events[key] || [];
        if (dayEvents.length) {
          // (MỚI) Hiển thị nhiều dot (tối đa 3)
          const dotsContainer = document.createElement('div');
          dotsContainer.style.display = 'flex';
          dotsContainer.style.gap = '3px';
          dotsContainer.style.position = 'absolute';
          dotsContainer.style.bottom = '8px';
          
          dayEvents.slice(0, 3).forEach(event => {
              const dot = document.createElement("div");
              dot.className = "event-dot";
              dot.style.backgroundColor = event.color || 'var(--primary)';
              dot.style.position = 'relative';
              dot.style.bottom = 'auto';
              dotsContainer.appendChild(dot);
          });
          
          dotsContainer.style.zIndex = '3';
          cell.appendChild(dotsContainer);
          cell.onclick = (e) => { e.stopPropagation(); showEventDetails(key); };
        } else {
          cell.onclick = (e) => { e.stopPropagation(); showEventForm(key); };
        }
        daysGrid.appendChild(cell);
      }
      
      const totalCells = 42; 
      const filledCells = firstDay + daysInMonth;
      for (let i = 1; i <= totalCells - filledCells; i++) {
        daysGrid.appendChild(createCell(i, "inactive", null));
      }
    }

    function createCell(day, className, dateKey) {
      const div = document.createElement("div");
      div.className = `day-cell ${className}`;
      if(dateKey) div.dataset.date = dateKey; 

      const num = document.createElement("span");
      num.className = "day-number";
      num.textContent = day;
      div.appendChild(num);
      
      const lunar = document.createElement("span");
      lunar.className = "lunar-day";
      if (!className && dateKey) {
         const [y, m, d] = dateKey.split('-').map(Number);
         lunar.textContent = getLunarDate(d, m, y);
      }
      div.appendChild(lunar);

      return div;
    }

    function changeMonth(x) {
      currentMonth += x;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }
    
    function showModal(id) {
        document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function showSelector(type) {
      selectorList.innerHTML = "";
      selectorTitle.textContent = type === "month" ? "Select month" : "Select year";
      const opts = type === "month" 
        ? monthNames.map((n, i) => ({ n, i })) 
        : [...Array(11)].map((_, i) => ({ n: currentYear - 5 + i, i: currentYear - 5 + i }));

      opts.forEach(o => {
        const b = document.createElement("button");
        b.textContent = o.n;
        b.onclick = () => {
          if (type === "month") currentMonth = o.i;
          else currentYear = o.i;
          renderCalendar();
          closeModal("selectorModal");
        };
        selectorList.appendChild(b);
      });
      showModal("selectorModal");
    }

    function showEventForm(date) {
      selectedDayForEvent = date;
      eventDateDisplay.textContent = formatDisplayDate(date);
      eventDayDateInput.value = date;
      eventForm.reset();
      document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      const defaultColorEl = document.querySelector('.color-swatch[data-color="#2563eb"]');
      if (defaultColorEl) defaultColorEl.classList.add('selected');
      eventColorInput.value = '#2563eb';
      
      showModal("eventFormModal");
      document.getElementById("eventTitle").focus();
    }

    eventForm.onsubmit = e => {
      e.preventDefault();
      const title = document.getElementById("eventTitle").value;
      const details = document.getElementById("eventDetails").value;
      const color = eventColorInput.value; 
      const date = eventDayDateInput.value;
      if (!title) return;
      const ev = loadEvents();
      if (!ev[date]) ev[date] = [];
      ev[date].push({ title, details, color }); 
      saveEvents(ev);
      renderCalendar();
      closeModal("eventFormModal");
    };

    // (MỚI) Sửa lại hàm showEventDetails
    function showEventDetails(date) {
      selectedDayForEvent = date;
      const ev = loadEvents()[date] || [];
      popupEventDate.textContent = formatDisplayDate(date);
      
      eventDetailsContent.innerHTML = ev.length ? ev.map((e, index) => `
        <div class="event-list-item">
            <div class="event-list-item-details">
                <b style="color: ${e.color || 'var(--primary)'}">${e.title}</b>
                <p>${e.details || "No details"}</p>
            </div>
            <button class="delete-event-btn" data-index="${index}" aria-label="Delete event ${e.title}">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
      `).join("") : "<p>No events</p>";
      
      showModal("eventDetailsModal");
    }

    // (MỚI) Hàm xóa 1 sự kiện
    function deleteSingleEvent(date, index) {
        const ev = loadEvents();
        if (!ev[date] || !ev[date][index]) return;
        
        ev[date].splice(index, 1); // Xóa sự kiện tại index
        
        if (ev[date].length === 0) { // Nếu không còn sự kiện nào, xóa key
            delete ev[date];
        }
        
        saveEvents(ev);
        renderCalendar();
        
        // Tải lại modal hoặc đóng nếu hết sự kiện
        if (ev[date]) {
            showEventDetails(date);
        } else {
            closeModal('eventDetailsModal');
        }
    }
    
    // (MỚI) Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast-notification');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // (MỚI) --- Sidebar Functions ---
    function openSidebar() {
      sidebar.classList.add('open');
      document.body.classList.add('sidebar-open');
      if (window.innerWidth < 1024) {
        sidebarOverlay.classList.add('open');
      }
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      document.body.classList.remove('sidebar-open');
      sidebarOverlay.classList.remove('open');
    }
    
    function gotoDate(dateString) {
        const [year, month, day] = dateString.split('-').map(Number);
        currentYear = year;
        currentMonth = month - 1;
        renderCalendar();
        
        setTimeout(() => {
          const cell = document.querySelector(`.day-cell[data-date="${dateString}"]`);
          if (cell) {
            cell.style.transition = 'none';
            cell.style.backgroundColor = 'var(--primary-light)';
            cell.style.borderColor = 'var(--primary-dark)';
            setTimeout(() => {
              cell.style.transition = 'var(--transition)';
              cell.style.backgroundColor = '';
              cell.style.borderColor = '';
            }, 1000);
          }
        }, 100);
        
        closeSidebar();
    }
    
    // (MỚI) --- Theme Functions ---
    function setTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        localStorage.setItem('calendarTheme', 'dark');
        themeToggle.checked = true;
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('calendarTheme', 'light');
        themeToggle.checked = false;
      }
    }

    // --- Event Listeners ---
    menuToggleBtn.onclick = openSidebar;
    closeSidebarBtn.onclick = closeSidebar;
    sidebarOverlay.onclick = closeSidebar;

    document.getElementById("prevMonthBtn").onclick = () => changeMonth(-1);
    document.getElementById("nextMonthBtn").onclick = () => changeMonth(1);
    monthSelectorBtn.onclick = () => showSelector("month");
    yearSelectorBtn.onclick = () => showSelector("year");
    document.getElementById("addEventBtn").onclick = () => showEventForm(formatDate(new Date()));
    
    // (MỚI) Nút thêm mới từ modal chi tiết
    addAnotherEventBtn.onclick = () => {
        closeModal('eventDetailsModal');
        // selectedDayForEvent vẫn đang giữ ngày
        if (selectedDayForEvent) {
            showEventForm(selectedDayForEvent);
        }
    };
    
    // (MỚI) Listener cho nút xóa (event delegation)
    eventDetailsContent.addEventListener('click', e => {
        const deleteBtn = e.target.closest('.delete-event-btn');
        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.index, 10);
            if (selectedDayForEvent && index >= 0) {
                deleteSingleEvent(selectedDayForEvent, index);
            }
        }
    });
    
    // (MỚI) Sidebar Listeners
    lunarToggle.onchange = (e) => {
      showLunar = e.target.checked;
      document.body.classList.toggle('lunar-visible', showLunar);
      localStorage.setItem('calendarShowLunar', showLunar);
    };
    
    // (MỚI) Theme listener
    themeToggle.onchange = (e) => {
      setTheme(e.target.checked ? 'dark' : 'light');
    };
    
    searchEventsInput.oninput = (e) => {
      const searchTerm = e.target.value.toLowerCase();
      searchResults.innerHTML = '';
      if (searchTerm.length < 2) return;
      
      const events = loadEvents();
      let found = [];
      for (const date in events) {
          events[date].forEach(event => {
              const title = (event.title || '').toLowerCase();
              const details = (event.details || '').toLowerCase();
              if (title.includes(searchTerm) || details.includes(searchTerm)) {
                  found.push({ date, event });
              }
          });
      }
      
      if(found.length === 0) {
        searchResults.innerHTML = '<li>No results found...</li>';
        return;
      }
      
      found.sort((a,b) => new Date(a.date) - new Date(b.date)); 
      
      found.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<small>${formatDisplayDate(item.date)}</small> ${item.event.title}`;
          li.onclick = () => gotoDate(item.date);
          searchResults.appendChild(li);
      });
    };
    
    gotoDateInput.onchange = (e) => {
      if(e.target.value) gotoDate(e.target.value);
    };
    
    importFileBtn.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (res) => {
                try {
                    const importedEvents = JSON.parse(res.target.result);
                    const currentEvents = loadEvents();
                    // Merge
                    const mergedEvents = { ...currentEvents };
                    // (MỚI) Cải thiện logic merge: Nối mảng thay vì ghi đè
                    for (const date in importedEvents) {
                        if (mergedEvents[date]) {
                            mergedEvents[date] = mergedEvents[date].concat(importedEvents[date]);
                        } else {
                            mergedEvents[date] = importedEvents[date];
                        }
                    }
                    saveEvents(mergedEvents);
                    renderCalendar();
                    showToast('Events imported successfully!');
                    closeSidebar();
                } catch (err) {
                    console.error(err);
                    showToast('Error: Invalid JSON file.');
                }
                e.target.value = null; // Reset input
            };
            reader.readAsText(file);
        }
    };
    
    exportFileBtn.onclick = () => {
        const events = loadEvents();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(events, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href",     dataStr);
        downloadAnchorNode.setAttribute("download", `calendar_events_${formatDate(new Date())}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        showToast('Events file exported!');
    };
    
    colorPicker.addEventListener('click', e => {
        if (e.target.classList.contains('color-swatch')) {
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            e.target.classList.add('selected');
            eventColorInput.value = e.target.dataset.color;
        }
    });
    
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target.id);
        }
    });

    // (MỚI) Khởi tạo trạng thái sidebar và theme khi tải trang
    
    // 1. Theme
    const savedTheme = localStorage.getItem('calendarTheme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (prefersDark) {
      setTheme('dark');
    } else {
      setTheme('light');
    }

    // 2. Sidebar
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
            sidebarOverlay.classList.remove('open');
        } else {
            if (sidebar.classList.contains('open')) {
                sidebarOverlay.classList.add('open');
                document.body.classList.add('sidebar-open');
            }
        }
    });
    
    if (window.innerWidth >= 1024) {
        openSidebar();
    }
    
    // 3. Lunar
    showLunar = localStorage.getItem('calendarShowLunar') === 'true';
    lunarToggle.checked = showLunar;
    document.body.classList.toggle('lunar-visible', showLunar);

    renderCalendar();
  </script>
</body>
</html>

